#include "pny_defines.var"

vector			tv_temp
message		EVT_msg_filter
int					ti_rank
messageid		EVT_ID
object			to_obj, to_gao
int					ti_canal
vector			tv_tir_arrivee
vector			tv_normal
int					gfx
float				tf_dist
object			to_canal
object			to_camera	

to_canal = ANI_CanalObjectGet(1)

to_camera = VIEW_GetObject(0)
f_camera_sqr_dist = MATH_VecSquareNorm(@to_camera OBJ_PosGet() - OBJ_PosGet())

if (f_camera_sqr_dist < Cf_SND_Sqr_Dist_On)
{
	if (i_SND_bzzz_loop == -1)
		i_SND_bzzz_loop = SND_RequestPlayLoop(Ci_SND_bzzz_loop)
}
else if (f_camera_sqr_dist > Cf_SND_Sqr_Dist_Off)
{
	if (i_SND_bzzz_loop != -1)
	{
		SND_Stop(i_SND_bzzz_loop)
		i_SND_bzzz_loop = -1
	}
}

f_time_since_last_kong_seen += TIME_GetDt()

if(i_mode == 0)
	AI_Execute("pny_standby")
else
	AI_Execute("pny_alerte")
	
// Orientation de moi
tv_temp = @o_follow OBJ_PosGet() - @to_canal OBJ_PosGet()
tf_dist  = MATH_VecNorm(tv_temp)

OBJ_BankingGeneralSet(tv_temp, Cv_VerticalVector)
@to_canal OBJ_SightGeneralSet(tv_temp, Cv_VerticalVector)
//@o_light OBJ_PosSet(@to_canal OBJ_PosGet() + @to_canal OBJ_SightGet())
//@o_light OBJ_SightGeneralSet(tv_temp, Cv_VerticalVector)

	
//// Si y'a une BV de délimitation et que cette BV est culled, j'éteins la light ... Optim 2000
//if(o_bv_limite_alerte && (@o_bv_limite_alerte OBJ_FlagsStatusGet() & OBJ_C_StatusFlag_Culled))
//	@o_light LIGHT_FlagSet(3, 0)
//else
//	@o_light LIGHT_FlagSet(3, 1)	
	
// Ai-je recu un Paf de n'importe qui en lache ? ... Si oui, je destroy myself.
//MSG_SetNull( EVT_msg_filter)
//EVT_msg_filter.msg_gao1 = OBJ_Me()
//ti_rank = -1
//EVT_ID = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, EVT_msg_filter)
//while(MSG_GlobalIsValid(EVT_ID))
//{
//	AI_TrackCurChangeNow("pny_destroy")
//}

AI_Execute("pny_exec_check_paf")
if (i_flag_paf)
{
	if (i_idhalo != -1)
	{
		GFX_Del(i_idhalo)
		i_idhalo = -1
	}
	
//	@o_light LIGHT_FlagSet(3, 0)

	SND_RequestPlay(Ci_SND_destroyed)

	AI_TrackCurChangeNow("pny_destroy")
}

// Lancer de rayon pour voir si le macaque est la
ti_canal = -1
tv_tir_arrivee = Cv_NullVector
to_gao = COL_RayObject_Dist(@to_canal OBJ_PosGet(), @to_canal OBJ_SightGet(), tf_dist , all, none, 0, COL_C_Ray_on_visuel_and_bone_volumes)
if(to_gao)
{
	ti_canal = COL_RayObject_CanalGet()
	if(ti_canal != -1) to_gao = COL_RayObject_ActorGet()
	tv_tir_arrivee = COL_RayObject_PosGet()
	tv_normal = COL_RayObject_NormalGet()
}

// Ouééé ... Kong est dans le spot ... flingue mode 2000 ...
if(to_gao == AI_MainActorGet(C_ID_Kong))
{
	if(!f_time_last_tir)
		f_time_last_tir = TIME_Get()
		
	f_time_since_last_kong_seen = 0
	v_last_pos_kong_in_ray = @to_gao OBJ_PosGet()	
	v_last_speed_kong_in_ray = @to_gao DYN_SpeedGetVector()
	f_time_tir = 2
	i_mode = 1
}

// Sfx
GFX_Setv(i_idhalo, 21200, @to_canal OBJ_PosGet() + @to_canal OBJ_SightGet())
GFX_Setv(i_idhalo, 21201, @to_canal OBJ_SightGet())

// Tire-je ?
f_time_tir -= TIME_GetDt()
if(f_time_tir < 0) 
{
	f_time_tir = 0
}

if(f_time_tir)
{
	if(TIME_Elapsed(f_time_last_tir, f_frequence_tir))
	{
		f_time_last_tir = TIME_Get()
		if(to_gao == AI_MainActorGet(C_ID_Kong))
		{
			SND_RequestPlay(Ci_SND_shoot)
			f_time_last_tir += 4.0
			EVENT_AddEventPafCanal(C_EVENT_FILTER_All, C_PAF_KK_Moyen, OBJ_Me(), Cf_EVENT_Duree_1Trame, to_gao, ti_canal, 10.0 * PAF_Unit, OBJ_SightGet(), tv_tir_arrivee)
		}
		
		gfx = GFX_Add(1)
		GFX_Setf(gfx, 1000, 0.5)
		GFX_Seti(gfx, 1100, 0x4FFFFFFF)
         GFX_FlagSet(gfx, 0, 1)            // activation de l’effet
         GFX_FlagSet(gfx, 2, 1)            // le matériau utilié sera transparent
		GFX_MaterialSet(gfx, get_SFX_light_and_smoke, 15)
		GFX_LifeTimeSet(gfx, 0.1)
		
		GFX_Setv(gfx, 1200, @to_canal OBJ_PosGet() + @to_canal OBJ_SightGet())
		GFX_Setv(gfx, 1201, @to_canal OBJ_PosGet() + (@to_canal OBJ_SightGet() * (1.0 + tf_dist)) )
		
		if(to_gao)
		{
			LIBGFX_GunsImpact( tv_tir_arrivee, tv_normal, to_gao, ti_canal, -1, -1)
		}
	}
}