
//==========================================================================
// Inclinaison horizontale
//==========================================================================

#include "KIGO_defines.var"

#define	Ci_orient_horiz_mode_paf				1
#define	Ci_orient_horiz_mode_ground		2
#define	Ci_orient_horiz_mode_air				3

int			ti_mode

vector	tv_orient
vector	tv_normal
vector	tv_temp


if( ! MATH_VecNullEpsilon(v_sum_pafs_dir) )
{
	// tronc paffé -> tombe
	AI_Execute("KIGO_exec_dyn_on")
	tv_orient = v_sum_pafs_dir
	MATH_VecSetHorzNormalize(tv_orient)
	ti_mode = Ci_orient_horiz_mode_paf
}
else if (COL_CollideType(COL_C_Ground) )
{
	// le tronc est au sol
	tv_normal = COL_NormalGet( COL_C_Ground)
	tv_temp = MATH_VecCrossProduct( tv_normal, OBJ_BankingGet())
//	DBG_RenderVector(OBJ_PosGet(), tv_temp * 10, color_jaune)
	tv_orient = MATH_VecCrossProduct( tv_temp, tv_normal)
//	DBG_RenderVector(OBJ_PosGet(), tv_orient * 10, color_cyan)
	ti_mode = Ci_orient_horiz_mode_ground
}
else
{
	// le tronc est en l'air
	tv_orient = OBJ_BankingGet()
	tv_orient.z = 0.0
	if( MATH_VecNullEpsilon( tv_orient))
	{
		if( o_snap_actor )
			tv_orient = OBJ_PosGet() - @o_snap_actor OBJ_PosGet()
		else
			tv_orient.x  = 0.001 
	}
	MATH_VecSetHorzNormalize(tv_orient)
	ti_mode = Ci_orient_horiz_mode_air
}

if( ti_mode != i_orient_horiz_mode )
{
	f_horizontal_blend_coef = 0.0
	i_orient_horiz_mode = ti_mode
}
//else if( tv_orient != v_orient_horiz_banking_perfect )
else if( ! MATH_VecNullToler(tv_orient - v_orient_horiz_banking_perfect, 0.5 ) )
{
	f_horizontal_blend_coef = 0.0	
	v_orient_horiz_banking_perfect = tv_orient
}
if( MATH_VecNullEpsilon(v_orient_horiz_banking_perfect) )
	v_orient_horiz_banking_perfect = tv_orient

f_horizontal_blend_coef = MATH_FloatBlend(f_horizontal_blend_coef, 1.0, 1.0 * TIME_GetDt())
//DBG_RenderVector(OBJ_PosGet(), tv_orient * 10, color_bleu)
//tv_orient = MATH_VecBlendRotate(OBJ_BankingGet(), tv_orient, f_horizontal_blend_coef)
v_orient_horiz_banking_cur = MATH_VecBlendRotate(v_orient_horiz_banking_cur, v_orient_horiz_banking_perfect, f_horizontal_blend_coef)
DBG_RenderVector(OBJ_PosGet(), v_orient_horiz_banking_cur * 10, color_bleu)
//OBJ_BankingGeneralSet(OBJ_SightGet(), tv_orient)
OBJ_BankingGeneralSet(OBJ_SightGet(), v_orient_horiz_banking_cur)

if( i_etat_courant == ETAT_KIGO_attente )
{
	if( f_horizontal_blend_coef > 0.9 )
		DYN_Off()
}



