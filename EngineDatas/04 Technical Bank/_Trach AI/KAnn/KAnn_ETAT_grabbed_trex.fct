#include "KAnn_defines.var"


// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	// ne pas couper la liaison et la callback à la sortie du mode !!! (état mort)
	i_sort_etat = faux
	return
}


// INITIALISATION ETAT ==============================================================
if (i_etat_courant != ETAT_grabbed_trex)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_grabbed_trex
	
	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}
	fct_last_etat = AI_TrackCurGet()
	f_time_start_etat = 0.0
	
	COL_ColSetActivationSet(none, C_bit_zdm_pied)
	DYN_GravitySet(Cv_NullVector)
	DYN_SpeedSetVector(Cv_NullVector)
	
	o_grabbed_TREX_actor = ao_SRV[Ci_LNK_GRAB_KONG]
	@o_grabbed_TREX_actor COL_UnCollidableAdd(OBJ_Me())
	AI_CBAdd(o_grabbed_TREX_actor, CallBack_After_Blend, "KAnn_CALLBACK_set_pos")
	f_pos_blend_coef = 0.0
	ACT_ActionSet(Ann_mort)
	
	KAnn_Set_Safe_Wp(nobody)

}
else
{
	f_time_start_etat += TIME_GetDt()
	f_pos_blend_coef = MATH_FloatBlend(f_pos_blend_coef, 1.0, 7.0 * TIME_GetDt())
}

// ANALYSE ===============================================================================
if( f_time_start_etat > 0.0 )
{
	// ne pas lire le paf correspondant au grab
	AI_Execute("KAnn_exec_CHECK_paf")
	if (o_paf_sender && ( i_paf_type & C_PAF_KK_KiTue ) )
	{
		OBJ_FlagInvisibleSet(vrai)
		macro_change_etat("KAnn_ETAT_mort")
	}
}

