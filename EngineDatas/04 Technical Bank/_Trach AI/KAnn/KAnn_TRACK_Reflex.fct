#include "KAnn_defines.var"

int			ti_i
vector	tv_cur_pos


//if( @get_global i_KAnn_check_paf_on_network )
//	Str_DisplayTextOnce("i_KAnn_check_paf_on_network", cvector(0.4,0.85,0))

if( @get_global i_KAnn_Drop_Javelin )
{
	AI_Execute("KAnn_exec_javelin_drop")
}

f_total_time += TIME_GetDt()

if (KAnn_Is_Cornered())
{
	OBJ_CapaSet(Capa_Cornered, none)	
}
	
if (OBJ_CapaTest(Capa_Action_Ann))
{
	if (i_etat_courant == ETAT_follow_network)
	{
		macro_change_etat("KAnn_ETAT_action")
	}
}

i_run_breath_enabled = faux

// SUIVI DU REGARD =========================================================
o_suivi_regard_object = nobody
v_suivi_regard_position = Cv_NullVector

// TERRAIN ================================================================
if (i_etat_courant == ETAT_Action && i_action_id == WP_Action_Colonne )
{
	i_ground_ID = Ci_OnPilier
}
else 
{
	i_ground_ID = Ci_OnGround
}

// Pour fred : capa 0 à 1 indique pendant une trame que le perso s'est fait taper ou grabber )-=======
OBJ_CapaSet( 0, OBJ_Capa_paffe_grabbe )

// CHECK FACE DE MORT =====================================================
if( COL_CollideType(COL_C_Ground) && COL_GMAT_FlagsGet( COL_C_Ground) & Gmat_KK_Face_de_mort )
{
	DBG_TraceString("ANN morte après contact avec une face de mort")
	DBG_TraceEOL()
	macro_change_etat("KAnn_ETAT_mort")
}

if( COL_CollideType(COL_C_Ground) && COL_GMAT_FlagsGet( COL_C_Ground) & Gmat_KK_Face_de_lave )
{
	DBG_TraceString("ANN morte après contact avec une face de lave")
	DBG_TraceEOL()
	macro_change_etat("KAnn_ETAT_mort")
}


// MESSAGES ==============================================================
AI_Execute("KAnn_exec_CHECK_msg")

// IK ======================================================================
for (ti_i = 0; ti_i < 4; ti_i++)
{
	i_flag_climb_IK[ti_i]	= faux
	f_IK_speed[ti_i] = TIME_GetDt() * 6.0
}

i_flag_walk_IK[Ci_IK_pied_gauche]	= ACT_CustomBitTest(Ani_CB_IK_PiedG)
i_flag_walk_IK[Ci_IK_pied_droit]	= ACT_CustomBitTest(Ani_CB_IK_PiedD)


// VIE ======================================================================
KAnn_MakeVision()

o_old_interaction_object = ao_SRV[Ci_LNK_INTERACTION]


// CINE FORCER LE CHOIX D'UN NOUVEAU WP ======================================
if( OBJ_CapaTest(CAPA_Force_New_Safe_WP) )
{
	if( i_etat_courant == ETAT_FPS )
	{
		DBG_Error("on vient de m'attribuer la capa 1 (force calc new wp) alors que je suis en état fantome FPS !!!!")
	}
	OBJ_CapaSet(none, CAPA_Force_New_Safe_WP)
	i_CINE_force_new_safe_WP = vrai
	macro_change_etat("KAnn_ETAT_follow_network")
}

// Suivi de regard actif par default
i_suivi_regard = 1

// DEATH ===================================================
if (f_time_mort > 0.0)
{
	@get_Kong_Path o_KONG i_mode_mort = Ci_Kamera_AnnDeath

	if (TIME_Get() - f_time_mort > 0.4)
	{
		// plan de cam sur ANN
		@get_Kamera Proc_Kam_FinishMode_Set( Ci_Kamera_AnnDeath, OBJ_Me())	// ANN camera Death	
	}
}
// DEATH =====================================================

if (OBJ_CapaTest(Capa_Paf_By_Javelin))
{
	AI_Execute("KAnn_exec_CHECK_paf_javelin")
}
