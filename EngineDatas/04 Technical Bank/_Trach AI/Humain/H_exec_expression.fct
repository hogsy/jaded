#include "H_Action.var"
#include "H_defines.var"

object	to_obj
float		tf_temp, tf_temp1, tf_temp2
int			ti_expr, ti_act

#define NEUTRE 0

if(joueur) return
to_obj = ANI_CanalObjectGet(Anim_Canal_Tete)
@to_obj OBJ_MorphProgSet(3, 2.0)
@to_obj OBJ_MorphFactorSet(5, 1.0)	// clin d'oeil
@to_obj OBJ_MorphProgSet(5, 0.0)

/////////////////// EXPRESSION COURANTE //////////////////////

// Context
ti_expr = EXPRESSION_NEUTRE
if(IsEtatGrab(i_etat_courant) || i_flag_panique)
	ti_expr = EXPRESSION_PEUR
else if(i_etat_courant == ETAT_IA_Ann_Heal)
	ti_expr = EXPRESSION_TRISTESSE
else if(i_etat_courant == ETAT_IA_lance || i_etat_courant == ETAT_IA_tir || i_etat_courant == ETAT_IA_frappe)
	ti_expr = EXPRESSION_COMBAT
else if(i_in_fight && i_cur_expression == EXPRESSION_COMBAT)
	ti_expr = EXPRESSION_COLERE
//else if(i_in_fight && i_cur_expression == EXPRESSION_NEUTRE || i_cur_expression == EXPRESSION_PEUR)
//	ti_expr = EXPRESSION_PEUR
else if(o_obj_suivi_des_yeux == o_ennemi_proche)
	ti_expr = EXPRESSION_COLERE_NEUTRE

// Anim
ti_act = ACT_DesignFlagGet()
if(ti_act & 0x0F) ti_expr = ti_act & 0x0F

// Blabla
ti_act = SPEECH_HumanGetExpressionIdx(OBJ_Me())
switch(ti_act)
{
	case 1:	ti_expr = EXPRESSION_NEUTRE break
	case 2: 	ti_expr = EXPRESSION_COLERE break
	case 3:	ti_expr = EXPRESSION_COMBAT break
	case 4:	ti_expr = EXPRESSION_TRISTESSE break
	case 5:	ti_expr = EXPRESSION_JOIE break
	case 6:	ti_expr = EXPRESSION_PEUR break
	case 7:	ti_expr = EXPRESSION_AMOUR break
}

//
if(i_force_expression)
{
	f_force_expression_time -= TIME_GetDt()
	if(f_force_expression_time < 0)
	{
		f_force_expression_time = 0
		i_force_expression = 0
	}
	else
	{
		ti_expr = i_force_expression
	}
}

//============================================================================================

//if(IO_ButtonJustPressed(joy_button_R2))
//{
//	i_test_expression++
//	if(i_test_expression == 6) i_test_expression = 0
//	switch(i_test_expression)
//	{
//		case 0:	ChangeExpression(EXPRESSION_NEUTRE, 5.0) break
//		case 1:	ChangeExpression(EXPRESSION_COLERE, 5.0) break
//		case 2:	ChangeExpression(EXPRESSION_COMBAT, 5.0) break
//		case 3:	ChangeExpression(EXPRESSION_JOIE, 5.0) break
//		case 4:	ChangeExpression(EXPRESSION_PEUR, 5.0) break
//		case 5:	ChangeExpression(EXPRESSION_TRISTESSE, 5.0) break
//	}
//	
//	i_changing_expression = faux
//}
//
//ti_expr = i_test_expression
//
//switch(i_cur_expression)
//{
//	case EXPRESSION_NEUTRE :			STR_CreateText("NEUTRE", cvector(0.5,0.5,0), 0) break	
//	case EXPRESSION_COLERE :			STR_CreateText("COLERE", cvector(0.5,0.5,0), 0) break
//	case EXPRESSION_COMBAT :			STR_CreateText("COMBAT", cvector(0.5,0.5,0), 0) break
//	case EXPRESSION_TRISTESSE :		STR_CreateText("TRISTESSE", cvector(0.5,0.5,0), 0) break
//	case EXPRESSION_JOIE :				STR_CreateText("JOIE", cvector(0.5,0.5,0), 0) break
//	case EXPRESSION_PEUR :				STR_CreateText("PEUR", cvector(0.5,0.5,0), 0) break
//}

//============================================================================================

// Expression
ChangeExpression(ti_expr, 2.0)

if(!i_mode_cine_morph) 
{
	UpdateExpression()
}
else
{
	i_changing_expression = faux
}

if(i_changing_expression)
{
	tf_temp1 = @to_obj OBJ_MorphFactorGet(1)
	tf_temp1 = MATH_FloatBlend(tf_temp1, f_dest_factor_expression[1], f_speed_factor_expression[1] * f_speed_expression * TIME_GetDt())
	@to_obj OBJ_MorphFactorSet(1, tf_temp1)
	
	tf_temp2 = @to_obj OBJ_MorphFactorGet(2)
	tf_temp2 = MATH_FloatBlend(tf_temp2, f_dest_factor_expression[2], f_speed_factor_expression[2] * f_speed_expression * TIME_GetDt())
	@to_obj OBJ_MorphFactorSet(2, tf_temp2)
	
	// PROG
	tf_temp = @to_obj OBJ_MorphProgGet(1)
	tf_temp = MATH_FloatBlend(tf_temp, 3, f_speed_expression * TIME_GetDt())
	@to_obj OBJ_MorphProgSet(1, tf_temp)
	
	tf_temp = @to_obj OBJ_MorphProgGet(2)
	tf_temp = MATH_FloatBlend(tf_temp, 3, f_speed_expression * TIME_GetDt())
	@to_obj OBJ_MorphProgSet(2, tf_temp)
	
	if(tf_temp > 2.95 && (MATH_AbsFloat(tf_temp1 - f_dest_factor_expression[1]) < 0.05) && (MATH_AbsFloat(tf_temp2 - f_dest_factor_expression[2]) < 0.05))
	{
		i_changing_expression = faux
		@to_obj OBJ_MorphDataSet(1, @to_obj OBJ_MorphDataGet(1, 2), 1) 	// Sourire
		@to_obj OBJ_MorphDataSet(2, @to_obj OBJ_MorphDataGet(2, 2), 1) 	// Sourire
		@to_obj OBJ_MorphProgSet(1, 2.0)
		@to_obj OBJ_MorphProgSet(2, 2.0)
	}
}