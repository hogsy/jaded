#include "H_defines.var"

int			ti_i
int			ti_numero
int			ti_index
int			ti_flag_grab
int			ti_context
int			ti_rank
int			ti_danger
messageid	EVT_ID
float		tf_dist
float		tf_sign
float		tv_val
float		tf_offset
float		tf_bestdist 

vector	tv_cover_pos
vector	tv_dest_pos
vector	tv_temp, tv_temp1

object	to_trap
object	to_obj
object	to_bestobj

// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	if(LNK_InteractionTypeGet(amid_SRV_LIAISON_ID[Ci_LNK_INTERACTION]) == Ci_LNK_INTERACTION_COVER)
	{
		o_obj_interaction = ao_SRV[Ci_LNK_INTERACTION]
		ao_SRV[Ci_LNK_INTERACTION] = LNK_ServeurGet(Ci_LNK_INTERACTION, amid_SRV_LIAISON_ID[Ci_LNK_INTERACTION], faux, nofunc, nofunc)
	}
	i_sort_etat = faux
	return
}

// INITIALISATION ETAT ==============================================================
if (i_etat_courant != ETAT_IA_cover)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_IA_cover

	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}

	fct_last_etat = AI_TrackCurGet()

	for (ti_i = 0; ti_i < Ci_LNK_TYPE_NB; ti_i++)
		ai_SRV_ENABLE[ti_i] = faux

	// AUTORISATIONS DES GRABS
	ai_SRV_ENABLE[Ci_LNK_GRAB_RAPTOR]	= vrai
	ai_SRV_ENABLE[Ci_LNK_GRAB_TRANSPORTE]	= vrai

	// AUTORISATIONS DES BLOCKS
	ai_SRV_ENABLE[Ci_LNK_BLOCK_RAPTOR]	= vrai

	// AUTORISATION DES AIDES
	ai_SRV_ENABLE[Ci_LNK_INTERACTION] 		= vrai
	ai_SRV_ENABLE[Ci_LNK_PSSS]	= vrai

	DYN_SpeedSetVector( Cv_NullVector)
	DYN_TractionSet( Cv_NullVector)
	
	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE  =====================================================================
AI_Execute("H_exec_read_world")
AI_Execute("H_exec_serveur_get")
AI_Execute("H_exec_change_etat")
AI_Execute("H_exec_ch_Stimulus_Paf")
if (o_paf_sender) macro_change_etat("H_ETAT_IA_paf")

// INTERACTION
OBJ_Me().des_int1 = Ci_DISPLAY_PSSS
if (!ao_SRV[Ci_LNK_INTERACTION]) macro_change_etat(fct_main_etat)

// COMPORTEMENT ==============================================================

// Si je vois une cible, je shoot direct
ComputeCibleAShooter( -1.0 )
if(o_target_stimulus_vis && f_time_start_etat > 1)
{
	AI_Execute("H_exec_validate_tir")
}

// Je vais jusqu'à celui qui donne de l'aide
to_obj = ao_SRV[Ci_LNK_INTERACTION]
tv_cover_pos = LNK_InteractionPositionGet(amid_SRV_LIAISON_ID[Ci_LNK_INTERACTION])
v_way_destpos = tv_cover_pos
CommonMove()

if (!f_joy_norm)
{
	OrienteVersEnnemiProche()
}

// Anims
///////////////////////////////////////////////
AI_Execute("H_exec_select_action")

