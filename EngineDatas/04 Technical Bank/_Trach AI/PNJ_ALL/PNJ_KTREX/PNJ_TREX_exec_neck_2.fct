// VAR SUPP SUIVI REGARD
private int			i_flag_perfect_look
private int			i_neck_bezier_mode

private float			f_look_main_actor_coef
private float			f_neck_length
private float			f_look_angle_blend_speed
private float			af_neck_bone_length[4]
private float			f_neck_vert_coef
private float			f_head_col_ray_Z_offset
private float			f_head_col_ray_Z_speed			= 1.0
private float			f_neck_col_duration
private float			f_time_head_col
private float			f_neck_B_weight
private float			f_neck_C_weight
private float			f_neck_bezier_coef					= 1.0
private float			af_neck_bone_bezier_coef[4]		= (0.25, 0.5, 0.75, 1.0)
private float			f_look_head_coef

private object		ao_head_bones[5]

private vector		v_look_axis
private vector		v_neck_head_anti_col_pos
private vector		v_neck_col_normale
private vector		v_neck_head_anti_col_sight

// INIT IK NECK
for (ti_i = 0; ti_i < 4; ti_i++)
{
	ao_head_bones[ti_i] = ANI_CanalObjectGet(Anim_Canal_Tete + ti_i)

	if (ti_i)	
	{
		af_neck_bone_length[ti_i - 1] = MATH_VecNorm(@ao_head_bones[ti_i - 1] OBJ_PosGet() - @ao_head_bones[ti_i] OBJ_PosGet())
		f_neck_length += af_neck_bone_length[ti_i - 1]
	}
}

ao_head_bones[4] = ANI_CanalObjectGet(Anim_Canal_Bassin)

to_head = ANI_CanalObjectGet(Anim_Canal_Tete)
v_look_head_pos = MATH_VecGlobalToLocal(@to_head OBJ_PosGet() - OBJ_PosGet())
v_look_banking = MATH_VecGlobalToLocal(@to_head OBJ_BankingGet())
v_look_axis = OBJ_SightGet() * 5.0





#include "PNJ_TREX_defines.var"

int				ti_i
int				ti_k
int				ti_flag_look_at_main_actor

float			tf_dist
float			tf_angle
float			tf_sign
float			tf_dot_product

vector		tv_pivot_pos
vector		tv_dest_pos
vector		tv_axis
vector		tv_bone_to_dest
vector		tv_temp

object		to_target
object		to_bone

#define Cf_speed				12.0

ti_flag_look_at_main_actor = faux

//if (i_flag_look_best_interet)
//{
//	if (!MSG_GlobalIsValid(mid_best_interet))
//	{
//		i_flag_look = faux
//	}
//	else if (EVENT_InteretSeenTimeGet(mid_best_interet) == TIME_Get())
//	{
//		to_target = EVENT_TargetGet(mid_best_interet) 
//		to_bone = @to_target ANI_CanalObjectGet(Anim_Canal_Tete)
//		v_look_pos = @to_bone OBJ_PosGet()
//	
//		if (to_target == o_main_actor)
//		{
//			ti_flag_look_at_main_actor = vrai
//			i_flag_perfect_look = vrai
//			f_look_main_actor_coef += MATH_FloatMin(1.0 - f_look_main_actor_coef, 2.0 * TIME_GetDt())
//		}
//	}
//	else
//	{
//		v_look_pos = 	EVENT_InteretPositionGet(mid_best_interet)
//	}
//}

if (!ti_flag_look_at_main_actor)
	f_look_main_actor_coef = 0.0

if (i_flag_look)
	f_look_blend_coef += MATH_FloatMin(1.0 - f_look_blend_coef, 4.0 * TIME_GetDt())
else
	f_look_blend_coef -= MATH_FloatMin(f_look_blend_coef, 4.0 * TIME_GetDt())

if (f_look_blend_coef)
{
	// CALCUL DE LA POSITION A REGARDER ================================
	tv_dest_pos = v_look_pos
	tv_pivot_pos = @ao_head_bones[4] OBJ_PosGet()

	// DISTANCE MIN ===========
	tv_bone_to_dest = v_look_pos
	tv_bone_to_dest -= tv_pivot_pos
	tv_bone_to_dest.z = 0.0
	
	tf_dist = MATH_VecDotProduct(tv_bone_to_dest, tv_bone_to_dest)
	if (tf_dist < 1.0)
	{
		tf_dist = MATH_FloatSqrt(tf_dist)
		tv_bone_to_dest /= tf_dist
//		tv_bone_to_dest *= 1.0
		
		tv_dest_pos = tv_pivot_pos
		tv_dest_pos += tv_bone_to_dest
		tv_dest_pos.z = v_look_pos.z
	}

	// CONTRAINTE ANGULAIRE
	tv_bone_to_dest = tv_dest_pos - tv_pivot_pos

	// ON A UNE ZONE D'EXCLUSION
	tv_axis = tv_bone_to_dest
	tv_axis.z = 0.0
	tv_axis = MATH_VecInCone(tv_axis, OBJ_SightGet(), 2.6, 0)
	tv_axis.z = tv_bone_to_dest.z
	tv_bone_to_dest = tv_axis

	// DETECTION DU "DEMI-TOUR"
	tv_temp = tv_bone_to_dest
	tv_temp.z = 0.0
	MATH_VecSetNormalize(tv_temp)

	if (MATH_VecDotProduct(tv_temp, OBJ_SightGet()) < 0.0 || MATH_VecDotProduct(v_look_axis, OBJ_SightGet()) < 0.0)
	{
		tf_sign = MATH_FloatSign(MATH_VecDotProduct(tv_temp, OBJ_HorizonGet()))
	
		if (MATH_FloatSign(MATH_VecDotProduct(v_look_axis, OBJ_HorizonGet())) != tf_sign)
		{
			i_flag_perfect_look = faux
		
			f_look_main_actor_coef	 = 0.0
			f_look_angle_blend_speed = 3.0
		
			tv_bone_to_dest = v_look_axis
//			tv_bone_to_dest.z = 0.0
			tv_bone_to_dest = tf_sign * MATH_VecCrossProduct(Cv_VerticalVector, tv_bone_to_dest)
		}
	}
	
//	if (DBG_IsObjSel())
//		DBG_RenderVector(tv_pivot_pos, tv_bone_to_dest, color_rouge)

	v_look_axis = MATH_VecBlendRotate(v_look_axis, tv_bone_to_dest, MATH_FloatMax(f_look_angle_blend_speed * TIME_GetDt(), f_look_main_actor_coef))

	v_look_pos = tv_pivot_pos
	v_look_pos += v_look_axis

//	if (DBG_IsObjSel())
//		DBG_RenderVector(tv_pivot_pos, v_look_axis, color_vert)

	AI_Execute("PNJ_TREX_exec_neck_IK")

//	// APPLICATION DE LA ROTATION
//	for (ti_i = 4; ti_i >= 0; ti_i--)
//	{
//		tf_angle = f_look_blend_coef / (ti_i + 1.0)
//
//		tv_bone_to_dest = tv_dest_pos - @ao_head_bones[ti_i] OBJ_PosGet()
//		tv_bone_to_dest.z = MATH_FloatBlend(tv_bone_to_dest.z, @ao_head_bones[ti_i] OBJ_BankingGet().z, ti_i / 4.0)
//		@ao_head_bones[ti_i] OBJ_BankingSet(MATH_VecBlendRotate(@ao_head_bones[ti_i] OBJ_BankingGet(), tv_bone_to_dest, tf_angle))
//	}
}
else
{
	i_flag_perfect_look = vrai	

	f_look_main_actor_coef = 0.0
	v_look_axis = OBJ_SightGet() * 5.0

	v_look_pos = @ao_head_bones[4] OBJ_PosGet()
	v_look_pos += v_look_axis
	
	AI_Execute("PNJ_TREX_exec_neck_IK")
}

// BACKUP EN LOCAL ================================================================
v_look_head_pos = MATH_VecGlobalToLocal(@ao_head_bones[0] OBJ_PosGet() - OBJ_PosGet())
v_look_virtual_sight = @ao_head_bones[0] OBJ_BankingGet()
v_look_banking = MATH_VecGlobalToLocal(v_look_virtual_sight)

