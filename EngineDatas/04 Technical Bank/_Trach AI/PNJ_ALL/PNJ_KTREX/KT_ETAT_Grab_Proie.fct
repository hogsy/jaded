#include "KT_defines.var"

float		tf_dot_avec_occluder
float		tf_dot_sans_occluder
float		tf_dist_can_eat


// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	o_grab_actor = LNK_ClientGet(Ci_LNK_GRAB_RAPTOR, mid_grab_actor_LNK_ID, faux, nofunc, nofunc, nofunc)
	i_sort_etat = faux
	return
}

// INITIALISATION ETAT ==============================================================
if( i_etat_courant != ETAT_Grab_Proie )
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Grab_Proie
	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}
	fct_last_etat = AI_TrackCurGet()
	f_time_start_etat = 0.0
	ai_grabbed_availibility[ Ci_LNK_GRAB_KONG] = vrai	
//	ACT_ActionSet(Action_Choppe_Avale)
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE ========================================================================

// Detection de GRAB
o_grabbed_actor_KK = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_grabbed_by_Kong_LNK_ID, vrai, nofunc, nofunc)
if (o_grabbed_actor_KK)
{
	macro_change_etat("KT_ETAT_Grabbed_by_Kong")		
}

// Detection de PAF
AI_Execute("KT_exec_check_paf")
if (o_paf_actor)
{
	macro_change_etat("KT_ETAT_paf")					// ko delay nul -> simple paf
}

// Jack fait diversion
Macro_Check_Paf_Jauge_Crier

// Detection du vide
macro_checkchute


//o_grab_actor = LNK_ThisClientGet(o_grab_actor, Ci_LNK_GRAB_RAPTOR, mid_grab_actor_LNK_ID, vrai, nofunc, nofunc, nofunc)
//if( ! o_grab_actor )
//{
//	macro_change_etat("KT_ETAT_attente")
//}


// COMPORTEMENT ===================================================================

// INTERET
KT_Interet_Update(o_grab_actor, C_EVENT_InteretStatusFoodchainLocked)

// REGARD
i_flag_look = faux

switch( ACT_ActionGet() )
{
	case Action_Mange :
		if( ANI_CurrentFrameGet(0) > 260 )
		{
			ACT_ActionSet(Action_Choppe_Avale)
			ANI_CurrentFrameSet(0, 90)
		}
		break
		
	case Action_Choppe_Avale :
		if( ANI_CurrentFrameGet(0) > 200 )
		{	
			EVENT_AddEventPaf(C_EVENT_FILTER_All, C_PAF_KK_FoodChain | C_PAF_KK_KiTue, OBJ_Me(), Cf_EVENT_Duree_1Trame, o_grab_actor, 1000.0 * PAF_Unit, OBJ_SightGet())
			@o_grab_actor OBJ_FlagInvisibleSet(vrai)
		}
		if (ACT_ActionFinished())
		{
			if( o_Jack )
			{
				i_foodchain_cri_fini_de_manger = vrai		// crie vers Jack
				macro_change_etat("KT_ETAT_fight_JACK")
			}
			else
				macro_change_etat("KT_ETAT_attente")
		}	
		break
}
