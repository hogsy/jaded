
// --------------------------------------------
// A METTRE EN PLACE : TREX SUR KONG
// --------------------------------------------


#include "PNJ_TREX_defines.var"

int			ti_i
int			ti_sens
int			ti_action

object	to_head
object	to_canal

vector	tv_pos_ultim

float		tf_delta_grab
float		tf_dot

// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	i_sort_etat = faux
	o_grabbed_actor = LNK_ClientGet(Ci_LNK_GrabStatus_TREX_TT, mid_grabbed_LNK_ID, faux, nofunc, nofunc, nofunc)
	COL_UnCollidableDel( o_grabbed_uncol)
	macro_reset_KK_joy
	return
}

// INITIALISATION ETAT ==============================================================
if (i_etat_courant != ETAT_KK_grabbedDessus)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_KK_grabbedDessus
	
	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}

	fct_last_etat = AI_TrackCurGet()
	o_grabbed_uncol = o_grabbed_actor
	COL_UnCollidableAdd( o_grabbed_uncol)
	ACT_ActionSet(Action_Fight_GrabTT_cycl)

	// i_grabbed_position == 2
	f_time_start_etat = 0.0
	MSG_GlobalSetGao( mid_grabbed_LNK_ID, nobody, GAO4)
	MSG_GlobalSetGao( mid_grabbed_LNK_ID, nobody, GAO5)
	i_grabbed_etat = Ci_grabbed_Prise_UP_neutre
	MSG_GlobalSetInt( mid_grabbed_LNK_ID, i_grabbed_etat, INT2)

}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE =======================================================================================================
o_grabbed_actor = LNK_ServeurGet(Ci_LNK_KKGRAB_FORCE, mid_grabbed_LNK_ID, vrai, nofunc, nofunc)
if (o_grabbed_actor == nobody)
{
	macro_change_etat(fct_main_etat)
}

// COMPORTEMENT =======================================================================================================
//tv_pos_ultim = OBJ_PosGet()
//tv_pos_ultim += OBJ_HorizonGet() * 1.0

to_canal = ANI_CanalObjectGet( Anim_Canal_Grab_Target)
tv_pos_ultim = @to_canal OBJ_PosGet()
MSG_GlobalSetVector( mid_grabbed_LNK_ID, tv_pos_ultim, VEC5, VEC_ALL)


// LECTURE DU JOY ET CHOIX DES ACTIONS SIMULS + COMBO
LNK_GrabCurrentSet( mid_grabbed_LNK_ID, 0.0)
//LNK_GrabDeltaUpdate( mid_grabbed_LNK_ID, TIME_GetDt())


tf_delta_grab = TIME_GetDt()			// Vitesse de deplacement de la jauge de grab apres 5s le grab lache

//tf_dot = MATH_VecDotProduct( glob_joyvector_get, OBJ_HorizonGet())
//if( tf_dot < -Cf_Cos45)
//{
//	// AVANCE : KONG POUSSE
//	v_grabbed_last_dir = -OBJ_HorizonGet()
//	ti_sens = Ci_grabbed_mode_CTG_pousse
//	tf_delta_grab = 2.0  * TIME_GetDt()		// Le joueur force durée grab plus courte( épuisement ??)
//}

//ti_action = ACT_ActionGet()
//if ( ACT_ActionFinished() || i_grabbed_etat == Ci_grabbed_mode_CTG_neutre)
//{
//	if ( LNK_GrabCurrentGet( mid_grabbed_LNK_ID) > LNK_GrabMaxGet(mid_grabbed_LNK_ID))
//	{
//		i_grabbed_etat = ti_sens
//		if ( ti_sens == Ci_grabbed_mode_CTG_pousse)
//		{
//			i_grabbed_etat = Ci_grabbed_mode_CTG_pousse
//			MSG_GlobalSetInt( mid_grabbed_LNK_ID, Ci_grabbed_mode_CTG_pousse, INT2)
//		}
//	}
//	else
//	{
//		i_grabbed_etat = Ci_grabbed_mode_CTG_neutre
//		MSG_GlobalSetInt( mid_grabbed_LNK_ID, Ci_grabbed_mode_CTG_neutre, INT2)
//	}
//}

// ETATS
if ( i_grabbed_etat == Ci_grabbed_Prise_UP_neutre)
{
	ACT_ActionSet( Action_Fight_GrabTT_cycl)
}