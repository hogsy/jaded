#include "prs_RaptorSlim_defines.var"

int				ti_trame
int				ti_action

float			tf_dist

vector		tv_temp

object		to_target

messageid	tmid_invalid

#define Cf_end_of_anim					0.999

// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	i_sort_etat = faux

	OBJ_FlagsExtraSet(none, OBJ_C_ExtraFlag_AlwaysPlay)

	i_flag_bite = faux
	i_flag_zde_fight_enable = faux

	if (i_flag_paf_visual)
	{
		f_force_run_duration = MATH_FloatMax(f_force_run_duration, Cf_after_bite_force_run_duration)
	}
	else if (i_perceived_best_actor_index != -1 && ! IsThis_ID_Humain(ai_perceived_ID[i_perceived_best_actor_index]) )
	{
		f_force_run_duration = MATH_FloatMax(f_force_run_duration, 2.0)
	}
	
	o_IK_bassin_bite_actor = nobody

	DYN_FrictionVectorSet(cvector(f_friction, f_friction, 0.0))

	i_frappe_target_nb = 0
	
	f_mord_delai = MATH_RandFloat(0.25,0.75)
	
	return
}

// INITIALISATION ETAT ==============================================================
if (i_etat_courant != ETAT_PRS_MORD)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_PRS_MORD

	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}

	fct_last_etat = AI_TrackCurGet()


	i_flag_bite_ok = faux

	DYN_FrictionVectorSet(cvector(8.0, 8.0, 0.0))

	to_target = EVENT_InteretTargetGet(mid_best_interet)
	switch(ai_perceived_ID[i_perceived_best_actor_index])
	{
		case C_ID_Monture_Serpent :
			o_IK_bassin_bite_actor = @to_target ANI_CanalObjectGet(5)
			break
			
		case C_ID_Monture_Aigle :
			o_IK_bassin_bite_actor = @to_target ANI_CanalObjectGet(Anim_Canal_Torse)
			break	
	
		default:
			o_IK_bassin_bite_actor = @to_target ANI_CanalObjectGet(Anim_Canal_Tete)
	}

	if (!o_IK_bassin_bite_actor)
		o_IK_bassin_bite_actor = to_target

	PRS_ActionSet(Action_Fight_Mord)

	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE =======================================================================================================
OBJ_FlagsExtraSet(OBJ_C_ExtraFlag_AlwaysPlay, none)

//AI_Execute("PNJ_Raptor_exec_check_msg")

AI_Execute("prs_exec_check_cadavre")
AI_Execute("prs_exec_check_vision")
AI_Execute("prs_exec_check_paf")
if (i_flag_paf_fly)
	macro_change_etat("prs_ETAT_PAF_FLY")
if (i_flag_paf_fall)
	macro_change_etat("prs_ETAT_PAF_FALL")
if (i_flag_paf_repousse || i_flag_paf_slide || ! EVENT_LIFE_CurLifeGet(ID_LIFE))
	macro_change_etat("prs_ETAT_PAF_SLIDE")


//
//AI_Execute("PNJ_Raptor_exec_check_sound")
//
//
//if (i_flag_paf_visual)
//	macro_change_etat("prs_ETAT_ATTENTE")
//
//AI_Execute("PNJ_Raptor_exec_check_shoot")
//

//AI_Execute("PNJ_Raptor_exec_update_best_interest")

// GRABBED ----------------------------------------------------------
o_grabbed_actor_KK = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_grabbed_by_Kong_LNK_ID, vrai, nofunc, nofunc)
if (o_grabbed_actor_KK)
	macro_change_etat("prs_ETAT_GRABBED")

//if (i_flag_change_target)
//	macro_change_etat("PNJ_Raptor_ETAT_HESITE")
//
//AI_Execute("PNJ_Raptor_exec_check_requin")
//
//AI_Execute("PNJ_Raptor_exec_check_client")
//
//if (o_grab_actor)
//	macro_change_etat("PNJ_Raptor_ETAT_GRAB")
//
if ( ! MSG_GlobalIsValid(mid_best_interet) || i_perceived_best_actor_index == -1)
	macro_change_etat(fct_main_etat)

to_target = EVENT_InteretTargetGet(mid_best_interet)
if (to_target == o_main_actor )
	f_time_last_jackattack = TIME_Get()

// COMPORTEMENT =================================================================================================
i_flag_zde_fight_enable = vrai

EVENT_InteretStatusSet(mid_best_interet, C_EVENT_InteretStatusLock)

ai_perceived_seen[i_perceived_best_actor_index] = vrai

ti_trame = ANI_CurrentFrameGet(0)

ti_action = ACT_ActionGet()
switch(ti_action)
{
	case Action_Fight_Mord :

		if (ACT_ActionFinished())
			macro_change_etat("prs_ETAT_ATTENTE")

		if (ti_trame >= 14 && ti_trame <= 19)
		{
			i_flag_bite = vrai
		}
		PRS_Do_Commun_Bite_Stuff(to_target)
		break
}

if ( ! i_flag_bite_no_wall )
{
	tv_temp = DYN_SpeedGetVector()
	tv_temp.x = 0.0
	tv_temp.y = 0.0
	DYN_SpeedSetVector(tv_temp)
	macro_change_etat("prs_ETAT_ATTENTE")
}
