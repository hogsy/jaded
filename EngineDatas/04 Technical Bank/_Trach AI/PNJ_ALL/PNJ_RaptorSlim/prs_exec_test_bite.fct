#include "prs_RaptorSlim_defines.var"

int			ti_i
int			ti_flag_ok

float		tf_test_dist
float		tf_dist, tf_dist2
float		tf_dot_product
float		tf_sqr_dist
float		tf_norm
float		tf_me_to_target_dist

vector	tv_temp
vector	tv_sight
vector	tv_pos
vector	tv_me_to_target

object	to_target
object	to_target_ref_bone


if (! i_flag_in_my_territory )
	return

if (i_flag_paf_repousse || i_flag_paf_visual)
	return

if (i_perceived_best_actor_index == -1)
	return

//if (! MSG_GlobalIsValid(mid_best_interet))
//	return
//
//if (! ai_perceived_seen[i_perceived_best_actor_index] )
//	return
//
//if (ai_perceived_ID[i_perceived_best_actor_index] == -1)
//	return
//
//if ( ! ai_perceived_accessible[i_perceived_best_actor_index])
//	return
//
//if (ai_perceived_hiding_place_index[i_perceived_best_actor_index] != -1)
//	return

//if (ai_perceived_status[i_perceived_best_actor_index] & (Ci_PERCEIVED_ALREADY_GRABBED | Ci_PERCEIVED_IS_DEAD))
//	return

//if (ai_perceived_ID[i_perceived_best_actor_index] == C_ID_Jack)
//{
//	if ( ! TIME_Elapsed(f_time_last_jackattack, 0.2) )
//		return
//}
//
to_target = ao_perceived_actor[i_perceived_best_actor_index]

switch(ai_perceived_ID[i_perceived_best_actor_index])
{
	case C_ID_Monture_Serpent :
		to_target_ref_bone = @to_target ANI_CanalObjectGet(5)
		break

	case C_ID_Monture_Aigle : 
		to_target_ref_bone = @to_target ANI_CanalObjectGet(Anim_Canal_Torse)
		break

	case C_ID_Raptor :
		if (MATH_VecDotProduct(OBJ_SightGet(), @to_target OBJ_SightGet()) > 0.0)
			to_target_ref_bone = @to_target ANI_CanalObjectGet(Anim_Canal_Bassin)
		else
			to_target_ref_bone = @to_target ANI_CanalObjectGet(Anim_Canal_Tete)
		break
		
	case C_ID_Rayman :
	default:
		to_target_ref_bone = @to_target ANI_CanalObjectGet(Anim_Canal_Tete)
}

if ( ! to_target_ref_bone )
	to_target_ref_bone = to_target

ti_flag_ok = faux


tf_sqr_dist = 3.0 * OBJ_ZoomGet()
tf_sqr_dist *= tf_sqr_dist

tv_temp = @to_target OBJ_PosGet()
tv_temp -= OBJ_PosGet()

if (MATH_VecDotProduct(OBJ_SightGet(), tv_temp) > 0.0 && tv_temp.z > -2.0 && tv_temp.z < 3.5)
{	
	tv_temp = @to_target_ref_bone OBJ_PosGet()
	tv_temp -= v_look_head_pos
	tv_temp.z = 0.0	

	tf_dist = MATH_VecDotProduct(tv_temp, tv_temp)

	if (tf_dist < 2.0)
	{
		ti_flag_ok = vrai
	}
	else if (tf_dist < tf_sqr_dist)
	{
		tf_dist = MATH_FloatSqrt(tf_dist)
		tv_temp /= tf_dist	
		
		if (MATH_VecDotProduct(tv_temp, v_look_virtual_sight) > Cf_Cos60)
			ti_flag_ok = vrai
	}
}

// MUR ENTRE MOI ET MA CIBLE ?
if (ti_flag_ok)
	PRS_Target_Reachable()
	
// On peut mordre
if (ti_flag_ok && i_flag_bite_no_wall && ! f_mord_delai )
	macro_change_etat("prs_ETAT_MORD")
