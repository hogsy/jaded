#include "PNJ_RK_defines.var"

int			ti_i

float		tf_dist
float		tf_best_dist

object	to_camera

vector	tv_camera_to_wp

if (i_flag_sortie_etat)
{
	i_flag_sortie_etat = faux
	return
}

if (i_etat_courant != ETAT_Attente)
{
	// INTIALISATION
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Attente
	
	if (fct_last_etat)
	{
		i_flag_sortie_etat = vrai
		AI_Execute(fct_last_etat)
	}

	fct_last_etat = AI_TrackCurGet()
	
	OBJ_FlagInvisibleSet(vrai)

	ACT_ActionSet(Ci_Action_Attente)

	i_flag_can_look = faux

	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE =========================================================================
to_camera = @get_global o_camera

tf_best_dist = Cf_Infinit
o_start_wp = nobody

for (ti_i = 0; ti_i < 50; ti_i++)
{
	if ( ! ao_start_wp[ti_i] )
		break
	
	tv_camera_to_wp = @ao_start_wp[ti_i] OBJ_PosGet() - @o_main_actor OBJ_PosGet()
	tv_camera_to_wp.z = 0.0
	
	tf_dist = MATH_VecSquareNorm(tv_camera_to_wp)
//	if (tf_dist > 0.001)
//	{
//		tf_dist = MATH_FloatSqrt(tf_dist)
//		tv_camera_to_wp /= tf_dist
//		
//		tf_dist *= 2.0 - MATH_VecDotProduct(@to_camera OBJ_SightGet(), tv_camera_to_wp)
//	}	

//	if (MATH_VecDotProduct(@to_camera OBJ_SightGet(), tv_camera_to_wp) < 0.0)
//		tf_dist += 1000000.0
	
	if (tf_dist < tf_best_dist)
	{
		tf_best_dist = tf_dist
		o_start_wp = ao_start_wp[ti_i]
	}

}

if (o_start_wp)
	macro_change_etat("PNJ_RK_ETAT_Fuite")

// COMPORTEMENT ===================================================================
