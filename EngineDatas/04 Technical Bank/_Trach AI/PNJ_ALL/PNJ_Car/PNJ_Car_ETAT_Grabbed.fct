#include "PNJ_Car_defines.var"

int			ti_action

object	to_serveur

// SORTIE ETAT =============================================================================
if (i_sort_etat)
{
	i_sort_etat = faux
	COL_ColSetActivationSet(C_bit_zde_corps, C_bit_zde_fight)
	OBJ_CapaSet(none, Capa_Grabbed)
	AI_CBDel(o_grabbed_actor_KK, CallBack_After_Blend, "PNJ_Car_callback_posset")
	return
}

// INITIALISATION ETAT ========================================================================
if (i_etat_courant != ETAT_Grabbed)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Grabbed

	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}

	if (i_dernier_etat == ETAT_Deplacement ) // f_time_reverse_camera )
	{
		// Si on lockait la caméra et qu'on vient de se faire chopper...	
		// HELP US
		SPEECH_RequestPost
		(
			OBJ_Me(),
			OBJ_Me(), 
			SPEECH_CteTxg_SpeNewYork, 
			GeneNY_C_car_caught, 
			1.0, 
			SPEECH_Cte_PriorityDefault, 
			5,
			0,
			0,
			0
		)

		f_time_reverse_camera = 0.0
	}

	fct_last_etat = AI_TrackCurGet()
	fct_main_etat = fct_last_etat

//	ODE_Enable(faux)
	OBJ_CapaSet(Capa_Grabbed, none)
	COL_ColSetActivationSet(C_bit_zde_fight, C_bit_zde_corps)
	AI_CBAdd(o_grabbed_actor_KK, CallBack_After_Blend, "PNJ_Car_callback_posset")
	
	i_flag_grab_allowed = vrai

	SND_RequestPlay(Ci_SND_Grabbed_By_Kong)

	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE ===============================================================================
to_serveur = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_grabbed_by_Kong_LNK_ID, vrai, nofunc, nofunc)
if ( ! to_serveur )
	macro_change_etat("PNJ_Car_ETAT_Epave")

// COMPORTEMENT =========================================================================
ti_action = LNK_GrabKong_ActionGet( mid_grabbed_by_Kong_LNK_ID) 
switch(ti_action)
{
	case Ci_GrabKong_Lance :
	case Ci_GrabKong_Relache :
	case Ci_GrabKong_KBoom :
		macro_change_etat("PNJ_Car_ETAT_Epave")
}

ODE_Setv(3, Cv_NullVector) // Moment angulaire

//if (GFX_Fire != -1 && f_time_start_etat > 0.2)
//	EVENT_AddEventPaf(C_EVENT_FILTER_All, C_PAF_KK_Moyen, OBJ_Me(), Cf_EVENT_Duree_1Trame, to_serveur, PAF_Unit * 10, -@to_serveur OBJ_SightGet())
