#include "PNJ_Scolo_defines.var"

int				ti_i

float			tf_coef
float			tf_dist
float			tf_speed

object		to_target
object		to_client
object		to_me
object		to_KAnn

vector		tv_pos
vector		tv_new_sight
vector		tv_new_banking
vector		tv_speed
vector		tv_traction


if (i_flag_sortie_etat)
{
	i_flag_sortie_etat = faux
	
	COL_StartMatrixSet(OBJ_PosGet())

	i_snaped_bone_index = -1
	f_delay_before_moving_again = 0.0

	AI_TrackChange(4, "PNJ_Scolo_After_ETAT")
	AI_CBDel(o_proie, CallBack_After_Blend, "PNJ_Scolo_callback_set_pos")
	
//	if( i_flag_kong_mode )
//		o_proie = LNK_ThisClientGet(o_proie, Ci_LNK_INTERACTION, mid_proie_LNK, faux, nofunc, nofunc, nofunc)
//	else
		o_proie = LNK_ThisClientGet(o_proie, Ci_LNK_GRAB_RAPTOR, mid_proie_LNK, faux, nofunc, nofunc, nofunc)
	
	if (SND_rollup_loop != -1)
	{
		SND_Stop(SND_rollup_loop)
		SND_rollup_loop = -1
	}

	return
}

if (i_etat_courant != ETAT_Snap)
{
	// INTIALISATION
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Snap
	
	if (fct_last_etat)
	{
		i_flag_sortie_etat = vrai
		AI_Execute(fct_last_etat)
	}

	fct_last_etat = "PNJ_Scolo_ETAT_Snap"
	
	PNJ_Scolo_Virtual_Net_Init(vrai, nobody)

	f_grab_Z_speed = DYN_SpeedGetVector().z

	AI_TrackChange(Ci_Track_Reflex, "PNJ_Scolo_Reflex")

	if (!o_proie)
	{
//		TIME_Wait(0.1)	
//	
//		o_proie = o_main_actor
//		AI_Execute("PNJ_Scolo_exec_check_vision")
//		PNJ_Scolo_Best_Interet_Update(i_perceived_main_actor_index)
		DBG_Error("un scolo vient de passer en snap alors qu'il n'a pas de proie ??!!")
	}
	
	AI_TrackStop(4)
	AI_CBAdd(o_proie, CallBack_After_Blend, "PNJ_Scolo_callback_set_pos")

	if (ai_perceived_ID[i_perceived_best_actor_index] == C_ID_Scolo)
	{
		LNK_GrabStatusSet(mid_proie_LNK, 1)	
	
		if (i_snaped_bone_index == -1)
			i_snaped_bone_index = Anim_Canal_Tete
		
		o_snap_bone = @o_proie ANI_CanalObjectGet(i_snaped_bone_index)

		f_move_speed = MATH_FloatLimit(MATH_VecDotProduct(DYN_SpeedGetVector(), -@o_snap_bone OBJ_SightGet()), 1.0, 3.5)

		switch(i_modele)
		{
			case Ci_Modele_Sombre :
				f_snaped_speed = 1.5
				break

			default:
				f_snaped_speed = 4.0
	
				to_me = OBJ_Me()
				EVENT_AddEventPafCanal(	C_EVENT_FILTER_All, 
														C_PAF_KK_Weapon, 
														to_me, 
														Cf_EVENT_Duree_1Trame, 
														o_proie, 
														i_snaped_bone_index, 
														0.0 * PAF_Unit, 
														MATH_VecBlendRotate(OBJ_SightGet(), Cv_VerticalVector, 0.75),
														@o_proie OBJ_PosGet()												
													)
													
				break
		}

		f_snaped_bone_length = @o_proie OBJ_ZoomGet() * 0.3
	
		v_snap_pos = @o_snap_bone MATH_VecGlobalToLocal(OBJ_PosGet() - @o_snap_bone OBJ_PosGet())
		f_on_snaped_bone_length = v_snap_pos.y

		v_snap_sight = @o_snap_bone MATH_VecGlobalToLocal(OBJ_SightGet())
		v_snap_banking = @o_snap_bone MATH_VecGlobalToLocal(OBJ_BankingGet())
	}
	else
	{
		if (ai_perceived_ID[i_perceived_best_actor_index] == C_ID_Joueur)
		{
			o_snap_bone = o_proie
		}
		else if (IsThis_ID_Humain(ai_perceived_ID[i_perceived_best_actor_index]))
		{
			o_snap_bone = @o_proie ANI_CanalObjectGet(Anim_Canal_Bassin)
			EVENT_AddEventPaf(C_EVENT_FILTER_All, C_PAF_KK_Fort, OBJ_Me(), Cf_EVENT_Duree_1Trame, o_proie, 0.0 * PAF_Unit, OBJ_SightGet())
		}
		else
		{
			o_snap_bone = @o_proie ANI_CanalObjectGet(i_snaped_bone_index)
			f_move_speed = DYN_SpeedGet()
			f_snaped_speed = 4.0 * OBJ_ZoomGet()
		}
	
		v_snap_pos = @o_snap_bone MATH_VecGlobalToLocal(OBJ_PosGet() - @o_snap_bone OBJ_PosGet()) 
		v_snap_sight = @o_snap_bone MATH_VecGlobalToLocal(OBJ_SightGet())
		
		v_snap_banking = OBJ_PosGet() - @o_snap_bone OBJ_PosGet()
		v_snap_banking.z = 0.0
		MATH_VecSetNormalize(v_snap_banking)
		v_snap_banking = @o_snap_bone MATH_VecGlobalToLocal(v_snap_banking)
	}

	f_arround_neck_dist = 0.0

	DYN_Off()

	COL_ColSetActivationSet(none, C_bit_zdm_pied)

	f_delay_until_last_ground_col = 1000.0

	f_time_start_etat = 0.0
	
	i_etat_phase = 0
	f_time_start_etat = 0.0
	
	SND_RequestPlay(SND_ATTACK)

	if (SND_rollup_loop == -1)
	{
		SND_rollup_loop = SND_RequestPlayLoop(SND_ROLLUP)
	}
}
else
{
	f_time_start_etat += TIME_GetDt()
}

if (f_time_start_etat > 1.0)
	tutorial = faux

//PNJ_Scolo_IK(, Cv_NullVector, Cv_NullVector)
//returntrack

// ANALYSE ===============================================================
o_KK_Grabbed_actor = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_kong_LNK, vrai, nofunc, nofunc)
if (o_KK_Grabbed_actor)
	macro_change_etat("PNJ_Scolo_ETAT_Grabbed_By_Kong")

o_predateur = LNK_ServeurGet(Ci_LNK_GRAB_RAPTOR, mid_predateur_LNK, vrai, "PNJ_Scolo_exec_LNK_predateur", nofunc)
if (o_predateur)
{
	switch(LNK_GrabServeurVisionIDGet(mid_predateur_LNK))
	{
		case C_ID_Scolo :
			macro_change_etat("PNJ_Scolo_ETAT_Wait_For_Grab")
			break	
	
		default:
			macro_change_etat("PNJ_Scolo_ETAT_Grabbed_Predateur")
	}
}

AI_Execute("PNJ_Scolo_exec_check_vision")

//if( i_flag_kong_mode )
//	to_client = LNK_ThisClientGet(o_proie, Ci_LNK_INTERACTION, mid_proie_LNK, vrai, nofunc, nofunc, nofunc)
//else
	to_client = LNK_ThisClientGet(o_proie, Ci_LNK_GRAB_RAPTOR, mid_proie_LNK, vrai, nofunc, nofunc, nofunc)
if (!to_client)
	macro_change_etat("PNJ_Scolo_ETAT_Paf")

AI_Execute("PNJ_Scolo_exec_check_paf")
if (i_flag_paf  || ! f_lifecur)
	macro_change_etat("PNJ_Scolo_ETAT_Paf")

AI_Execute("PNJ_Scolo_exec_check_best_interet")

// COMPORTEMENT =========================================================
//if( i_flag_kong_mode )	// pour kong et kann
if( o_kong && o_proie == o_kong )
	EVENT_InteretStatusSet(mid_best_interet, C_EVENT_InteretStatusRide)
else
	EVENT_InteretStatusSet(mid_best_interet, C_EVENT_InteretStatusLock)


// KONG MODE ================================================
//if( i_flag_kong_mode )
//{
//	if( o_proie == @"univ" ao_AllHumains[C_ID_Ann] )
//	{
//		// mode de liaison d'intéraction
//		if( LNK_InteractionParamGet(mid_proie_LNK) == C_INTER_FIGHT_ANN_READY )
//			LNK_InteractionParamSet(mid_proie_LNK, C_INTER_FIGHT_ENEMY_FAKE_ATTACK)
//		
//		// test tuer KAnn
//		if( @o_proie KAnn_Death_Attack_Enabled() )
//		{
//			LNK_InteractionParamSet(mid_proie_LNK, C_INTER_FIGHT_ENNEMY_ATTACK )
//			EVENT_AddEventPaf(C_EVENT_FILTER_Enemy, C_PAF_KK_KiTue, OBJ_Me(), Cf_EVENT_Duree_1Trame, o_proie, 99, OBJ_SightGet())
//			to_client = LNK_ThisClientGet(o_proie, Ci_LNK_INTERACTION, mid_proie_LNK, faux, nofunc, nofunc, nofunc)
//			macro_change_etat("PNJ_Scolo_ETAT_Sol")
//		}
//	}
//}

tv_pos = @ao_modules[i_modules_nb - 1] OBJ_PosGet()
tv_pos.z = MATH_FloatMax(tv_pos.z, OBJ_PosGet().z)

if (COL_RayObject_Dist(tv_pos, -Cv_VerticalVector, 10.0, all, none, Ci_Filter_IdentityFlag, COL_C_Ray_on_ColMap_NoCrossable))
{
	v_ray_pos = MATH_VecBlend(v_ray_pos, COL_RayObject_PosGet(), 6.0 * TIME_GetDt())
	v_ray_normal = MATH_VecBlendRotate(v_ray_normal, COL_RayObject_NormalGet(), 4.0 * TIME_GetDt())
}

//if( ! i_flag_kong_mode && f_time_start_etat > 10.0 && IsThis_ID_Humain(ai_perceived_ID[i_perceived_best_actor_index]))
if( ( ! o_kong || o_proie != o_kong ) && f_time_start_etat > 10.0 && IsThis_ID_Humain(ai_perceived_ID[i_perceived_best_actor_index]))
	EVENT_AddEventPaf(C_EVENT_FILTER_All, C_PAF_KK_KiTue, OBJ_Me(), Cf_EVENT_Duree_1Trame, o_proie, 0.0 * PAF_Unit, OBJ_SightGet())

//PNJ_Scolo_Bite_Dead_Meat()

