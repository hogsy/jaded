#include "PNJ_Scolo_defines.var"

int				ti_i
int				ti_flag_locked

vector		tv_pos

object		to_duplicated

if (i_flag_sortie_etat)
{
	i_flag_sortie_etat = faux
	
	if( i_etat_courant != ETAT_Grabbed_Predateur )
		o_predateur = LNK_ServeurGet(Ci_LNK_GRAB_RAPTOR, mid_predateur_LNK, faux, "PNJ_Scolo_exec_LNK_proie", nofunc)
	
	i_perfored_module_index = -1

	COL_ColSetActivationSet(C_bit_zdm_pied | C_bit_zde_corps, none)

	return
}

if (i_etat_courant != ETAT_Paf)
{
	// INTIALISATION
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Paf
	
	if (fct_last_etat)
	{
		i_flag_sortie_etat = vrai
		AI_Execute(fct_last_etat)
	}

	DYN_Off()
	OBJ_FlagsIdentitySet(none, OBJ_C_IdentityFlag_Dyna)
	COL_ColSetActivationSet(none, C_zdm_pied)
	OBJ_HierarchyReset()	

	fct_last_etat = "PNJ_Scolo_ETAT_Paf"

	i_flag_grab_paf = faux
	
	o_KK_Grabbed_actor = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_kong_LNK, faux, nofunc, nofunc)
	o_proie = LNK_ServeurGet(Ci_LNK_GRAB_RAPTOR, mid_proie_LNK, faux, nofunc, nofunc)

	f_time_start_etat = 0.0

	// RAGDOLL ============================
	i_on_ground_modules_nb = 0
	i_in_water_modules_nb = 0

	f_delay_until_last_wall_col = 1000.0

	f_ragdoll_damping = 1.0
	i_flag_start_ragdoll_damping = faux

	for (ti_i = 0; ti_i < i_modules_nb; ti_i++)
	{
		av_bone_col_normal[ti_i] = Cv_NullVector
		af_bone_ground_col_timer[ti_i] = 1000.0
//		af_modules_water_Z[ti_i] = f_water_Z
	}
	// RAGDOLL ============================

//	ai_modules_locked[7] = vrai
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE ===============================================================
if( f_time_start_etat > 0.0 )
{
	// pas la trame où je coupe
	o_KK_Grabbed_actor = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_kong_LNK, vrai, nofunc, nofunc)
	if (o_KK_Grabbed_actor)
		macro_change_etat("PNJ_Scolo_ETAT_Grabbed_By_Kong")
}

//// FINISH DE KONG 
if (o_kk_finish)
	macro_change_etat("PNJ_Scolo_ETAT_KK_I_Finish")

// VINC ADD !!!!
o_predateur = LNK_ServeurGet(Ci_LNK_GRAB_RAPTOR, mid_predateur_LNK, vrai, "PNJ_Scolo_exec_LNK_predateur", nofunc)
if (o_predateur)
{
	switch(LNK_GrabServeurVisionIDGet(mid_predateur_LNK))
	{
		case C_ID_Scolo :
//			macro_change_etat("PNJ_Scolo_ETAT_Wait_For_Grab")
			break	
	
		default:
			macro_change_etat("PNJ_Scolo_ETAT_Grabbed_Predateur")
	}
}
// VINC ADD !!!!

AI_Execute("PNJ_Scolo_exec_check_vision")

AI_Execute("PNJ_Scolo_exec_check_paf")

AI_Execute("PNJ_Scolo_exec_check_best_interet")

// COMPORTEMENT =========================================================

PNJ_Scolo_Check_Javelin()

ti_flag_locked = faux

for (ti_i = 0; ti_i < 10; ti_i++)
{
	if ( ! ao_javelin[ti_i] )
		continue	

	if (ai_modules_locked[ai_javelin_bone_index[ti_i]])
	{
		ti_flag_locked = vrai
		break
	}
}

if (!ti_flag_locked && f_time_start_etat > 1.0 && f_lifecur )
{
	if (i_on_ground_modules_nb >= 10 && (! af_bone_ground_col_timer[0] || (af_modules_archimede[0] < 1.5 && av_modules_speed[0].z > -1.0)))
		macro_change_etat("PNJ_Scolo_ETAT_Sol")
	else if (f_time_start_etat > 10.0)
		macro_change_etat("PNJ_Scolo_ETAT_Sol")
}

PNJ_Scolo_Rag_Doll(0)

//if (IO_KeyJustPressed(VK_SPACE))
//{
//	if (ai_modules_locked[7])
//		ai_modules_locked[7] = faux
//	else
//		ai_modules_locked[7] = vrai
//}

