#include "PNJ_Scolo_defines.var"

int			ti_i

float		tf_dist
float		tf_coef
float		tf_speed
float		tf_norm
float		tf_pow_coef

object	to_target
object	to_head_target

vector	tv_head_pos
vector	tv_head_sight
vector	tv_impulsion
vector	tv_new_sight
vector	tv_horizon
vector	tv_start_pos
vector	tv_speed
vector	tv_me_to_target
vector	tv_ik_start_pos
vector	tv_ik_start_sight

//vector	tv_ray_start_pos
//vector	tv_ray_dir
//vector	tv_ray_col_normal

object	to_me
object	to_predateur

#define Cf_phase_0_duration				1.0
#define Cf_phase_1_duration				0.8

if (i_flag_sortie_etat)
{
	i_flag_sortie_etat = faux

	DYN_On()
	DYN_FlagsSet(DYN_C_BasicForces | DYN_C_VectorFriction | DYN_C_GlobalFriction | DYN_C_NeverDynamicFather, DYN_C_NeverDynamicHierarchy)
	DYN_GravitySet(v_Scolo_Gravity)

	COL_ColSetActivationSet(C_bit_zdm_pied, none)
	
	if (!i_flag_grab_paf)
		o_predateur = LNK_ServeurGet(Ci_LNK_GRAB_RAPTOR, mid_predateur_LNK, faux, nofunc, nofunc)

	return
}

if (i_etat_courant != ETAT_Wait_For_Grab)
{
	// INTIALISATION
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Wait_For_Grab
	
	if (fct_last_etat)
	{
		i_flag_sortie_etat = vrai
		AI_Execute(fct_last_etat)
	}
	
	fct_last_etat = "PNJ_Scolo_ETAT_Wait_For_Grab"
	
	PNJ_Scolo_IK_Init(i_ik_modules_nb)

//	DYN_Off()
//	COL_ColSetActivationSet(none, C_bit_zdm_pied)

	DYN_On()
	DYN_FlagsSet(DYN_C_BasicForces | DYN_C_VectorFriction | DYN_C_GlobalFriction | DYN_C_NeverDynamicFather, DYN_C_NeverDynamicHierarchy)
	DYN_GravitySet(Cv_NullVector)
	DYN_FrictionVectorSet(cvector(6.0, 6.0, 6.0))	

	COL_ColSetActivationSet(C_bit_zdm_pied, none)

//	f_rot_sign = MATH_FloatSign(MATH_RandFloat(-1.0, 1.0))

	SND_RequestPlay(SND_GETUP)

	f_delay_until_last_ground_col = 1000.0
	f_delay_until_last_wall_col = 1000.0

	i_etat_phase = 0
	f_etat_phase_duration = 0.0

	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE ==============================================================================
AI_Execute("PNJ_Scolo_exec_check_vision")

AI_Execute("PNJ_Scolo_exec_check_paf")
if (i_flag_paf || ! f_lifecur)
	macro_change_etat("PNJ_Scolo_ETAT_Paf")

AI_Execute("PNJ_Scolo_exec_check_best_interet")

// COMPORTEMENT ========================================================================
o_KK_Grabbed_actor = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_kong_LNK, vrai, nofunc, nofunc)
if (o_KK_Grabbed_actor)
	macro_change_etat("PNJ_Scolo_ETAT_Grabbed_By_Kong")

to_predateur = LNK_ServeurGet(Ci_LNK_GRAB_RAPTOR, mid_predateur_LNK, vrai, nofunc, nofunc)
if (to_predateur != o_predateur || ! MSG_GlobalIsValid(mid_best_interet))
	macro_change_etat("PNJ_Scolo_ETAT_Paf")

EVENT_InteretStatusSet(mid_best_interet, C_EVENT_InteretStatusLock)

to_target = o_predateur
to_head_target = @to_target ANI_CanalObjectGet(Anim_Canal_Tete)

PNJ_Scolo_UncollideAdd(to_target, Cf_EVENT_Duree_1Trame)

if (i_etat_phase < 2)
{
	f_move_speed -= MATH_FloatMin(f_move_speed, 1.5 * move_speed * TIME_GetDt())
	f_virtual_net_offset += f_move_speed * TIME_GetDt()
	f_virtual_net_offset = MATH_FloatMin(f_virtual_net_offset, i_ik_modules_nb * dist_between_module)
}

if (i_etat_phase < 3)
	PNJ_Scolo_Modules_Update(i_ik_modules_nb, nobody)

if (ao_virtual_wp_father[i_virtual_net_last_wp_index])
{
	tv_ik_start_pos = @ao_virtual_wp_father[i_virtual_net_last_wp_index] MATH_VecLocalToGlobal(v_IK_pos)
	tv_ik_start_pos += @ao_virtual_wp_father[i_virtual_net_last_wp_index] OBJ_PosGet()
	
	tv_ik_start_sight = @ao_virtual_wp_father[i_virtual_net_last_wp_index] MATH_VecLocalToGlobal(v_IK_sight)
}
else
{
	tv_ik_start_pos = v_IK_pos
	
	tv_ik_start_sight = v_IK_sight
}

switch(i_etat_phase)
{
	case 0 :
		// Je me relève
		f_etat_phase_duration += TIME_GetDt()
		tf_coef = MATH_FloatMin(f_etat_phase_duration / Cf_phase_0_duration, 1.0)
		tf_coef = MATH_Sin(tf_coef * Cf_PiBy2)

		tv_start_pos = @ao_modules[i_ik_modules_nb] OBJ_PosGet()
		tv_start_pos += @ao_modules[i_ik_modules_nb] OBJ_SightGet() * (f_size_coef * 0.75)

		tv_me_to_target = @to_head_target OBJ_PosGet()
		tv_me_to_target -= tv_start_pos
		tv_me_to_target.z = 0.0
		tf_dist = MATH_VecNorm(tv_me_to_target)
		if (MATH_FloatNullToler(tf_dist, 0.001))
		{
			tv_me_to_target = @ao_modules[i_ik_modules_nb] OBJ_SightGet()
			MATH_VecSetHorzNormalize(tv_me_to_target)
		}
		else	
		{
			tv_me_to_target /= tf_dist
		}

		tv_horizon.x = tv_me_to_target.y
		tv_horizon.y = -tv_me_to_target.x
		tv_horizon.z = 0.0
		tv_horizon *= MATH_Sin(f_time_start_etat * 3.0) * (0.4 * f_size_coef)

		tv_head_pos = tv_start_pos
//		tv_head_pos -= tv_me_to_target * MATH_FloatLimit(f_size_coef - tf_dist, -f_size_coef * 0.5, f_size_coef)
		tv_head_pos.z += f_size_coef * 1.7
		tv_head_pos.z += MATH_Sin(f_time_start_etat * 6.0) * (f_size_coef * 0.1)
		tv_head_pos += tv_horizon

		tf_coef = MATH_FloatMin(tf_coef, 1.0)

		tv_head_pos = MATH_VecBlendRotate(tv_ik_start_pos - tv_start_pos, tv_head_pos - tv_start_pos, tf_coef)
		tv_head_pos += tv_start_pos

//		tv_ray_start_pos = tv_start_pos
//		tv_ray_start_pos.z = tv_head_pos.z
//		tv_ray_dir = tv_head_pos - tv_ray_start_pos
//		tv_ray_dir.z = 0.0
//		tf_norm = MATH_VecNorm(tv_ray_dir)
//		tv_ray_dir /= tf_norm
//		if (COL_RayObject_Dist(tv_ray_start_pos, tv_ray_dir, tf_norm + COL_ZoneSizeGet(C_zdm_pied), all, OBJ_C_IdentityFlag_Anims | OBJ_C_IdentityFlag_Dyna, Ci_Filter_IdentityFlag, COL_C_Ray_on_ColMap_NoCrossable))
//		{
//			tv_head_pos = COL_RayObject_PosGet()
//			tv_head_pos += COL_ZoneSizeGet(C_zdm_pied) * COL_RayObject_NormalGet()
//		}

		tv_head_sight = MATH_VecBlend(@to_head_target OBJ_PosGet(), @to_target OBJ_PosGet(), MATH_FloatMin((tf_dist * 0.25) - f_size_coef, 0.5))
		tv_head_sight = MATH_VecNormalize(tv_head_sight - tv_head_pos)
		tv_head_sight = MATH_VecBlendRotate(tv_ik_start_sight, tv_head_sight, tf_coef)

		DYN_SpeedSetVector((tv_head_pos - OBJ_PosGet()) / TIME_GetDt())	
//		DYN_TractionSet((tv_head_pos - OBJ_PosGet()) * 20.0)
		tv_head_pos = OBJ_PosGet()
		
		PNJ_Scolo_IK(i_ik_modules_nb, tv_head_pos, tv_head_sight, tf_coef)
		
		if (f_etat_phase_duration >= Cf_phase_0_duration)
		{
			f_etat_phase_duration = 0.0
			i_etat_phase++
			
			v_IK_pos = MATH_VecBlend(@to_head_target OBJ_PosGet(), @to_target OBJ_PosGet(), MATH_FloatMin((tf_dist * 0.25) - f_size_coef, 0.5))
			if (ao_virtual_wp_father[i_virtual_net_last_wp_index])
				v_IK_pos = @ao_virtual_wp_father[i_virtual_net_last_wp_index] MATH_VecGlobalToLocal(v_IK_pos - @ao_virtual_wp_father[i_virtual_net_last_wp_index] OBJ_PosGet())
		}
		
		break

	case 1 :
		f_etat_phase_duration += TIME_GetDt()
		tf_coef = MATH_FloatMin(f_etat_phase_duration / 2.0, 1.0)

		// Je lock mon sight
		tv_start_pos = @ao_modules[i_ik_modules_nb] OBJ_PosGet()
		tv_start_pos += @ao_modules[i_ik_modules_nb] OBJ_SightGet() * (f_size_coef * 0.75)

		tv_me_to_target = tv_ik_start_pos
		tv_me_to_target -= tv_start_pos
		tv_me_to_target.z = 0.0
		tf_dist = MATH_VecNorm(tv_me_to_target)
		if (MATH_FloatNullToler(tf_dist, 0.001))
		{
			tv_me_to_target = @ao_modules[i_ik_modules_nb] OBJ_SightGet()
			MATH_VecSetHorzNormalize(tv_me_to_target)
		}
		else	
		{
			tv_me_to_target /= tf_dist
		}

		
		tv_horizon.x = tv_me_to_target.y
		tv_horizon.y = -tv_me_to_target.x
		tv_horizon.z = 0.0
		tv_horizon *= MATH_Sin(f_time_start_etat * 3.0) * (f_size_coef * MATH_FloatBlend(0.4, 0.1, tf_coef))

		tv_head_pos = tv_start_pos
//		tv_head_pos -= tv_me_to_target * MATH_FloatLimit(f_size_coef - tf_dist, -f_size_coef * 0.5, f_size_coef)
		tv_head_pos.z += f_size_coef * 1.7
		tv_head_pos.z += MATH_Sin(f_time_start_etat * 6.0) * (f_size_coef * 0.1)
		tv_head_pos += tv_horizon

//		tv_ray_start_pos = tv_start_pos
//		tv_ray_start_pos.z = tv_head_pos.z
//		tv_ray_dir = tv_head_pos - tv_ray_start_pos
//		tv_ray_dir.z = 0.0
//		tf_norm = MATH_VecNorm(tv_ray_dir)
//		if (tf_norm)
//		{
//			tv_ray_dir /= tf_norm
//			if (COL_RayObject_Dist(tv_ray_start_pos, tv_ray_dir, tf_norm + COL_ZoneSizeGet(C_zdm_pied), all, OBJ_C_IdentityFlag_Anims | OBJ_C_IdentityFlag_Dyna, Ci_Filter_IdentityFlag, COL_C_Ray_on_ColMap_NoCrossable))
//			{
//				tv_head_pos = COL_RayObject_PosGet()
//				tv_head_pos += COL_ZoneSizeGet(C_zdm_pied) * COL_RayObject_NormalGet()
//			}
//		}
	
		tv_head_sight = tv_ik_start_pos - tv_head_pos
		MATH_VecSetNormalize(tv_head_sight)

		DYN_SpeedSetVector((tv_head_pos - OBJ_PosGet()) / TIME_GetDt())	
//		DYN_TractionSet((tv_head_pos - OBJ_PosGet()) * 20.0)
		tv_head_pos = OBJ_PosGet()
		
		PNJ_Scolo_IK(i_ik_modules_nb, tv_head_pos, tv_head_sight, 1.0)

		if (LNK_GrabStatusGet(mid_predateur_LNK))
		{
			switch(i_modele)
			{
				case Ci_Modele_Standard :
				case Ci_Modele_Clair :
					i_etat_phase++
					f_etat_phase_duration = 0.0
	
					if (TIME_Elapsed(f_time_last_paf_sound, f_delay_between_paf_sound))
					{
						f_time_last_paf_sound = TIME_Get()
						f_delay_between_paf_sound = MATH_RandFloat(0.4, 0.6)
						
						SND_RequestPlay(SND_PAF)
					}
					break
					
//				case Ci_Modele_Sombre :
//					to_me = OBJ_Me()
//					EVENT_AddEventPafCanal(	C_EVENT_FILTER_All, 
//															C_PAF_KK_Weapon, 
//															to_me, 
//															Cf_EVENT_Duree_1Trame, 
//															to_me, 
//															Anim_Canal_Tete, 
//															0, 
//															MATH_VecBlendRotate(@to_target OBJ_SightGet(), Cv_VerticalVector, 0.75),
//															@to_target OBJ_PosGet()												
//														)
//					break
			}
		}
		
		break

	case 2 :
		f_etat_phase_duration += TIME_GetDt()
		tf_coef = MATH_FloatMin(f_etat_phase_duration / 0.6, 1.0)

		// J'accuse le coup
		tv_start_pos = @ao_modules[i_ik_modules_nb] OBJ_PosGet()
		tv_start_pos += @ao_modules[i_ik_modules_nb] OBJ_SightGet() * (f_size_coef * MATH_FloatBlend(0.75, 0.25, tf_coef))

		tv_me_to_target = tv_ik_start_pos
		tv_me_to_target -= tv_start_pos
		tv_me_to_target.z = 0.0
		tf_dist = MATH_VecNorm(tv_me_to_target)
		if (MATH_FloatNullToler(tf_dist, 0.001))
		{
			tv_me_to_target = @ao_modules[i_ik_modules_nb] OBJ_SightGet()
			MATH_VecSetHorzNormalize(tv_me_to_target)
		}
		else	
		{
			tv_me_to_target /= tf_dist
		}

		tv_horizon.x = tv_me_to_target.y
		tv_horizon.y = -tv_me_to_target.x
		tv_horizon.z = 0.0
		tv_horizon *= MATH_Sin(f_time_start_etat * 3.0) * (f_size_coef * MATH_FloatBlend(0.1, 0.4, tf_coef))

		tv_head_pos = tv_start_pos
//		tv_head_pos -= tv_me_to_target * MATH_FloatLimit(f_size_coef - tf_dist, -f_size_coef * 0.5, f_size_coef)
		tv_head_pos.z += f_size_coef * (MATH_FloatBlend(1.7, 1.9, tf_coef)  - (MATH_Sin(tf_coef * Cf_Pi) * 1.0))
		tv_head_pos.z += MATH_Sin(f_time_start_etat * 6.0) * (f_size_coef * 0.1)
		tv_head_pos += tv_horizon

//		tv_ray_start_pos = tv_start_pos
//		tv_ray_start_pos.z = tv_head_pos.z
//		tv_ray_dir = tv_head_pos - tv_ray_start_pos
//		tv_ray_dir.z = 0.0
//		tf_norm = MATH_VecNorm(tv_ray_dir)
//		if (tf_norm)
//		{
//			tv_ray_dir /= tf_norm
//			if (COL_RayObject_Dist(tv_ray_start_pos, tv_ray_dir, tf_norm + COL_ZoneSizeGet(C_zdm_pied), all, OBJ_C_IdentityFlag_Anims | OBJ_C_IdentityFlag_Dyna, Ci_Filter_IdentityFlag, COL_C_Ray_on_ColMap_NoCrossable))
//			{
//				tv_head_pos = COL_RayObject_PosGet()
//				tv_head_pos += COL_ZoneSizeGet(C_zdm_pied) * COL_RayObject_NormalGet()
//			}
//		}
	
		tv_head_sight = tv_ik_start_pos - tv_head_pos
		MATH_VecSetNormalize(tv_head_sight)
		
		tv_new_sight = tv_head_sight
		MATH_VecSetHorzNormalize(tv_new_sight)
		tv_new_sight = MATH_VecBlendRotate(tv_new_sight, -Cv_VerticalVector, 0.5)

		tv_head_sight = MATH_VecBlendRotate(tv_head_sight, tv_new_sight, MATH_Sin(tf_coef * Cf_Pi))

		DYN_SpeedSetVector((tv_head_pos - OBJ_PosGet()) / TIME_GetDt())	
//		DYN_TractionSet((tv_head_pos - OBJ_PosGet()) * 60.0)
		tv_head_pos = OBJ_PosGet()
		
		PNJ_Scolo_IK(i_ik_modules_nb, tv_head_pos, tv_head_sight, 1.0)

		if (tf_coef >= 1.0)
		{
			f_etat_phase_duration = 0.0
			i_etat_phase++
		}
		
		break

	case 3 :
		f_etat_phase_duration += TIME_GetDt()
		tf_coef = MATH_FloatMin(f_etat_phase_duration / 1.5, 1.0)

		// Je gigote !!!
		tv_start_pos = @ao_modules[i_ik_modules_nb] OBJ_PosGet()
		tv_start_pos += @ao_modules[i_ik_modules_nb] OBJ_SightGet() * (f_size_coef * MATH_FloatBlend(0.25, 0.75, tf_coef))

		tv_me_to_target = tv_ik_start_pos
		tv_me_to_target -= tv_start_pos
		tv_me_to_target.z = 0.0
		tf_dist = MATH_VecNorm(tv_me_to_target)
		if (MATH_FloatNullToler(tf_dist, 0.001))
		{
			tv_me_to_target = @ao_modules[i_ik_modules_nb] OBJ_SightGet()
			MATH_VecSetHorzNormalize(tv_me_to_target)
		}
		else	
		{
			tv_me_to_target /= tf_dist
		}

		tv_horizon.x = tv_me_to_target.y
		tv_horizon.y = -tv_me_to_target.x
		tv_horizon.z = 0.0
		tv_horizon *= MATH_Sin(f_time_start_etat * 3.0) * (f_size_coef * MATH_FloatBlend(0.4, 0.6, tf_coef))
		
		tv_head_pos = tv_start_pos
		tv_head_pos.z += f_size_coef * 1.9
		tv_head_pos.z += MATH_Sin(f_time_start_etat * 6.0) * (f_size_coef * MATH_FloatBlend(0.1, 0.3, tf_coef))
		tv_head_pos += tv_horizon

//		tv_ray_start_pos = tv_start_pos
//		tv_ray_start_pos.z = tv_head_pos.z
//		tv_ray_dir = tv_head_pos - tv_ray_start_pos
//		tv_ray_dir.z = 0.0
//		tf_norm = MATH_VecNorm(tv_ray_dir)
//		if (tf_norm)
//		{
//			tv_ray_dir /= tf_norm
//			if (COL_RayObject_Dist(tv_ray_start_pos, tv_ray_dir, tf_norm + COL_ZoneSizeGet(C_zdm_pied), all, OBJ_C_IdentityFlag_Anims | OBJ_C_IdentityFlag_Dyna, Ci_Filter_IdentityFlag, COL_C_Ray_on_ColMap_NoCrossable))
//			{
//				tv_head_pos = COL_RayObject_PosGet()
//				tv_head_pos += COL_ZoneSizeGet(C_zdm_pied) * COL_RayObject_NormalGet()
//			}
//		}
	
		tv_head_sight = tv_ik_start_pos - tv_head_pos
		MATH_VecSetNormalize(tv_head_sight)

		tv_head_sight = MATH_VecBlendRotate(tv_head_sight, @ao_modules[i_ik_modules_nb] OBJ_SightGet(), tf_coef)
		tv_head_sight = MATH_VecBlendRotate(tv_head_sight, Cv_VerticalVector, tf_coef * 0.5)
		tv_head_sight = MATH_VecRotate(tv_head_sight, Cv_VerticalVector, MATH_Sin(f_etat_phase_duration * 4.8) * 0.8)

		DYN_SpeedSetVector((tv_head_pos - OBJ_PosGet()) / TIME_GetDt())	
//		DYN_TractionSet((tv_head_pos - OBJ_PosGet()) * 60.0)
		tv_head_pos = OBJ_PosGet()
				
		PNJ_Scolo_IK(i_ik_modules_nb, tv_head_pos, tv_head_sight, 1.0)

		if (f_etat_phase_duration > 1.5)
		{
			to_me = OBJ_Me()
			EVENT_AddEventPafCanal(	C_EVENT_FILTER_All, 
													C_PAF_KK_Weapon, 
													to_me, 
													Cf_EVENT_Duree_1Trame, 
													to_me, 
													4, 
													0.0, 
													MATH_VecBlendRotate(-OBJ_SightGet(), Cv_VerticalVector, 0.5),
													OBJ_PosGet()												
												)



			to_me = to_target
			EVENT_AddEventPafCanal(	C_EVENT_FILTER_All, 
													C_PAF_KK_Weapon, 
													to_me, 
													Cf_EVENT_Duree_1Trame, 
													to_me, 
													8, 
													0.0, 
													MATH_VecBlendRotate(@to_target OBJ_PosGet() - OBJ_PosGet(), Cv_VerticalVector, 0.5),
													@to_target OBJ_PosGet()												
												)

//			macro_change_etat("PNJ_Scolo_ETAT_Paf")
		}

		break
}

