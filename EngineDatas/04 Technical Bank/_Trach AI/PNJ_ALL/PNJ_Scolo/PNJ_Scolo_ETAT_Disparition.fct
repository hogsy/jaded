#include "PNJ_Scolo_defines.var"

int			ti_i
int			ti_flag_ok
int			ti_best_perceived_index

float		tf_dist
float		tf_best_dist

if (i_flag_sortie_etat)
{
	f_move_speed = 0.0
	f_move_length = 0.0

	i_flag_instant_jump = vrai

	i_flag_sortie_etat = faux

	i_net_wp_nb--
	@ao_net_wp[i_net_wp_nb] OBJ_Destroy()
	ao_net_wp[i_net_wp_nb] = nobody

	return
}


if (i_etat_courant != ETAT_Disparition)
{
	// INTIALISATION
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Disparition
	
	if (fct_last_etat)
	{
		i_flag_sortie_etat = vrai
		AI_Execute(fct_last_etat)
	}
	
	fct_last_etat = "PNJ_Scolo_ETAT_Disparition"
	
	i_etat_phase = 0

	f_move_speed = -DYN_SpeedGet()

	DYN_Off()
	COL_ColSetActivationSet(none, C_bit_zdm_pied)

	ao_net_wp[i_net_wp_nb] = @get_WP OBJ_Duplicate(OBJ_PosGet())
	f_link_coef = MATH_VecNorm(@ao_net_wp[i_net_wp_nb] OBJ_PosGet() - @ao_net_wp[i_net_wp_nb - 1] OBJ_PosGet())
	@ao_net_wp[i_net_wp_nb] OBJ_SightGeneralSet(-OBJ_SightGet(), OBJ_BankingGet())

	if (f_link_coef > 0.001)
	{
		i_current_wp_index = i_net_wp_nb - 1
	}
	else
	{
		f_link_coef = MATH_VecNorm(@ao_net_wp[i_net_wp_nb - 1] OBJ_PosGet() - @ao_net_wp[i_net_wp_nb - 2] OBJ_PosGet())
		i_current_wp_index = i_net_wp_nb - 2
	}

	i_net_wp_nb++


	o_best_interet_target = nobody
	
	PNJ_Scolo_Del_Interest()

	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}
	
// ANALYSE ===============================================================
AI_Execute("PNJ_Scolo_exec_check_vision")

AI_Execute("PNJ_Scolo_exec_check_paf")
if (i_flag_paf)
	macro_change_etat("PNJ_Scolo_ETAT_Paf")

// COMPORTEMENT =========================================================
f_move_speed = MATH_FloatBlend(f_move_speed, -move_speed, 6.0 * TIME_GetDt())
f_move_length = f_move_speed * TIME_GetDt()
i_flag_inverse_sight = vrai
PNJ_Scolo_Position_Set()

if (i_flag_net_start)
	macro_change_etat("PNJ_Scolo_ETAT_Attente")



