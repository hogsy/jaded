#include "PNJ_Scolo_defines.var"

int			ti_crossable

o_test_pilotage_tete = nobody
AUTO_BANKING = faux

if (i_SF_NePasSeRejouerSiMort)
{
	int		ti_SF_AlreadyDead
	i_SF_AlreadyDead = AI_SFDynGet(0, SF_MinById, SF_MaxById)		// Alloc
	Super_SpecialFlag_get(i_SF_AlreadyDead, ti_SF_AlreadyDead)			// Test SF
	if (ti_SF_AlreadyDead)																	// Si SF = 1 alors DESTROY
		OBJ_Destroy()
}

i_frame_nb = 0
AI_RunContext(CTX_AfterRec)
DYN_Off()

if (! OBJ_FlagsIdentityTest(OBJ_C_IdentityFlag_Generated))
{
	OBJ_FlagInvisibleSet(vrai)

	meta(i_frame_nb < 2)
	{
		i_frame_nb++
	}
}

OBJ_FlagInvisibleSet(faux)

//o_main_actor = AI_MainActorGet(0)
o_kong = AI_MainActorGet(C_ID_Kong)
o_jack = AI_MainActorGet(C_ID_Joueur)

//if (o_main_actor == @"univ" ao_AllHumains[C_ID_Kong])
//	i_flag_kong_mode = vrai
//else
//	i_flag_kong_mode = faux

// SCALE INVALID // TYPE
// HS FIGHT
//if ( i_flag_kong_mode)
{
	i_gmat_death_bit = Gmat_KK_Face_de_mort
	i_gmat_water_bit = Gmat_KK_Face_eau

	OBJ_FlagsIdentitySet(OBJ_C_IdentityFlag_DesignStruct,none)
	OBJ_Me().des_int1 = 0
	if ( Proc_KK_BigScolo() )
	{
		HotSpot_Add_Obj( OBJ_Me(), 1)
		KK_Size = 2.8
	}
	else
		KK_Size = 1.0
}
//else
//{
//	i_gmat_death_bit = Gmat_Jack_Face_de_mort	
//	i_gmat_water_bit = Gmat_Jack_Face_eau
//}

//TIME_Wait(Cf_EVENT_Duree_1Trame)

v_init_pos = OBJ_PosGet()

f_delay_until_last_ground_col = 1000.0
f_delay_until_last_wall_col = 1000.0

f_time_last_bite_sound = -1000.0

// ZDE CORPS ====================================
COL_SwapToSpecific(C_zde_corps)
//if (i_flag_kong_mode)
//{
//	PNJ_Scolo_UncollideAdd(o_main_actor, -1.0)	
//	
//	if( Proc_KK_BigScolo() )
//		COL_ZoneSizeSet(C_zde_corps, cvector(2.0, 2.0, 2.0))
//	else
//		COL_ZoneSizeSet(C_zde_corps, cvector(1.75, 1.75, 1.75))
//	
//	COL_CrossableSet(none, all)
//	COL_CrossableSet(Gmat_KK_Crossable_Default, none)
//}
//else
//{
//	COL_ZoneSizeSet(C_zde_corps, cvector(1.5, 1.5, 1.5))
//
//	COL_CrossableSet(none, all)
//	ti_crossable = Gmat_Jack_DefaultCrossable
//	ti_crossable |= Gmat_Jack_Face_eau
//	ti_crossable |= Gmat_Jack_Face_de_Bord
//	ti_crossable |= Gmat_Jack_BordHumain_TraversableNMI
//	ti_crossable |= Gmat_Jack_Crossable_All_But_TREX
//	ti_crossable |= Gmat_Jack_Crossable_All_But_RAPTORS
//
//	COL_CrossableSet(ti_crossable, none)
//}
COL_ZoneSizeSet(C_zde_corps, cvector(1.75, 1.75, 1.75))
COL_CrossableSet(none, all)
COL_CrossableSet(Gmat_KK_Crossable_Default, none)
COL_ZonePosSet(C_zde_corps, Cv_NullVector)

// ZDM PIED =======================================
COL_SwapToSpecific(C_zdm_pied)
COL_ZoneSizeSet(C_zdm_pied, cvector(0.2, 0.2, 0.2))
COL_ZoneFlagSet(C_zdm_pied, COL_C_Zone_ZDM | COL_C_Zone_ZDE, none)


AI_CBAdd(OBJ_Me(), CallBack_WhenDestroy,"PNJ_Scolo_callback_WhenDestroy")
AI_CBAdd(OBJ_Me(), CallBack_Info,"PNJ_Scolo_callback_info")
AI_CBAdd(OBJ_Me(), CallBack_Client, "PNJ_Scolo_callback_client")
macro_add_callback_after_cam("PNJ_Scolo_callback_aftercam")

OBJ_FlagsIdentitySet(OBJ_C_IdentityFlag_DesignStruct,none)
//if ( ! i_flag_kong_mode )
	OBJ_Me().des_int1 = Ci_DISPLAY_FIGHT


// Settings des differents Scolo.
AI_Execute("PNJ_Scolo_exec_settings")

if ( ! OBJ_ModifierType(MDF_C_Modifier_InfoPhoto) )
	OBJ_InfoPhotoParamSet( 0, 0, 4, 4, 0.0, 0.0, 0.0, 1.5 * OBJ_ZoomGet())

//if( OBJ_ModifierType(MDF_C_Modifier_DynamicFogSphereEmiter) && ! i_Modifier_Splash && ( ! i_flag_kong_mode || ! Proc_KK_BigScolo() ) )
if( OBJ_ModifierType(MDF_C_Modifier_DynamicFogSphereEmiter) && ! i_Modifier_Splash && ! Proc_KK_BigScolo() )
	OBJ_FreezeModifier(MDF_C_Modifier_DynamicFogSphereEmiter, vrai)		// laisse le modifier actif si flag splash mis à vrai ou si KK  big scolo

ODE_Enable(faux)

dist_between_module *= f_size_coef
dist_tail *= f_size_coef

f_last_module_min_dist = f_size_coef
f_last_module_min_dist *= f_last_module_min_dist

f_middle_module_min_dist = 0.6 * f_size_coef
f_middle_module_min_dist *= f_middle_module_min_dist

i_modules_nb = 15
i_ik_modules_nb = MATH_FloatMin(i_modules_nb - 3, 10)

//if (i_flag_kong_mode)
	f_rigidity_coef = 1200.0
//else
//	f_rigidity_coef = 400.0

f_n2_dist = 0.5 * f_size_coef
f_n3_dist = 0.8 * f_size_coef
f_n5_dist = 1.2 * f_size_coef

v_last_pos = OBJ_PosGet()
v_head_last_pos = OBJ_PosGet()

OBJ_FlagsControlSet(OBJ_C_ControlFlag_AlwaysVisible, none)
PNJ_Scolo_Init_Modules()
OBJ_FlagsControlSet(none, OBJ_C_ControlFlag_AlwaysVisible)

i_perceived_best_actor_index = -1

f_lifecur = f_life
if (override_point_de_viande != -1.0)
	f_point_de_viande = override_point_de_viande

ID_LIFE = EVENT_AddEventLife(f_lifecur , f_life, 0.0)

if (type == Ci_TYPE_FIXE)
	i_flag_instant_jump = vrai

i_foodchain_eat_slots_free = i_foodchain_eat_slots_nb

OBJ_CapaSet(none, all)

AI_TrackChange(Ci_Track_Reflex, "PNJ_Scolo_Reflex")
if (i_modele == Ci_Modele_Pit)
	AI_TrackChange(Ci_Track_Etat, "PNJ_Scolo_ETAT_Pit")
else if (i_modele == Ci_Modele_Cine)
	AI_TrackChange(Ci_Track_Etat, "PNJ_Scolo_ETAT_Cine_Move")
else
	AI_TrackChange(Ci_Track_Etat, "PNJ_Scolo_ETAT_Attente")

//AI_TrackChange(Ci_Track_Etat, "PNJ_Scolo_ETAT_Paf")

AI_TrackChange(4, "PNJ_Scolo_After_ETAT")

if (o_start_wp)
{
	f_delay_until_last_ground_col = 0.0
	f_delay_until_last_wall_col = 0.0

	n_net = @o_start_wp WAY_NetOfObj()
	
	o_next_wp = o_start_wp
	v_net_next_pos = @o_next_wp BV_RandomPosGet(0)

	if (WAY_RootGet(n_net) != o_start_wp)
		DBG_Error("Le root n'est pas le premier wp donné")

	PNJ_Scolo_Init_Net()
	PNJ_Scolo_Position_Set()
	PNJ_Scolo_Virtual_Net_Init(faux, nobody)

	COL_ColSetActivationSet(C_bit_zde_corps, C_bit_zdm_pied)

#ifndef _FINAL_
	if (EDIT)
		AI_TrackChange(Ci_Track_Etat, "PNJ_Scolo_ETAT_TEST")
#endif
}

if (i_net_wp_nb)
	v_init_pos = @ao_net_wp[i_net_wp_nb - 1] OBJ_PosGet()

//AI_TrackChange(Ci_Track_Etat, "PNJ_Scolo_ETAT_Snap")
//AI_TrackChange(Ci_Track_Etat, "PNJ_Scolo_ETAT_Grabbed")

AI_TrackCurStop()
