#include "PNJ_Scolo_defines.var"

int					ti_i
int					ti_rank
int					ti_perceived_status
int					ti_paf_type
int					ti_index
int					ti_seuil_paf_moyen
int					ti_seuil_paf_fort
int					ti_canal
int					ti_au_moins_un_paf

vector			tv_speed
vector			tv_temp

object			to_target
object			to_father
object			to_sender

message		tmsg_filter

float				tf_puissance
float				tf_life_init

messageid		tmid_paf
messageid		tmid_vision_event

if (i_flag_paf_check_done)
	return
	
if (tutorial)
	return

//if (IO_KeyJustPressed(VK_SPACE))
//{
//	f_point_de_viande -= MATH_FloatMin(f_point_de_viande, tf_puissance)
//	
//	i_flag_paf = vrai
//
//	// RAGDOLL ============================
//
//	i_modules_pafed_index = i_modules_nb >> 1
//	v_module_paf_dir = Cv_VerticalVector // MATH_VecBlendRotate(EVENT_PafDirGet(tmid_paf), Cv_VerticalVector, 0.5)
//	MATH_VecSetNormalize(v_module_paf_dir)
//	v_module_paf_dir *= 20.0
//
//	i_on_ground_modules_nb = 0
//	f_delay_until_last_wall_col = 1000.0
//
//	f_ragdoll_damping = 1.0
//	i_flag_start_ragdoll_damping = faux
//
//	for (ti_i = 0; ti_i < i_modules_nb; ti_i++)
//	{
//		av_bone_col_normal[ti_i] = Cv_NullVector
//		af_bone_ground_col_timer[ti_i] = 1000.0
//	}
//	// RAGDOLL ============================
//}


i_flag_paf_check_done = vrai
i_paf_type = 0

MSG_GlobalSetInvalid(tmid_vision_event)

switch(i_modele)
{
	case Ci_Modele_Clair :
		ti_seuil_paf_moyen = 2
		ti_seuil_paf_fort = 8
		break

	case Ci_Modele_Sombre :
		ti_seuil_paf_moyen = 2
		ti_seuil_paf_fort = 2
		break

	default:
		ti_seuil_paf_moyen = 2
		ti_seuil_paf_fort = 4
		break
}

ti_au_moins_un_paf = faux
tf_life_init = f_lifecur

MSG_SetNull(tmsg_filter)
tmsg_filter.msg_gao1 = OBJ_Me()
ti_rank = -1

for (	tmid_paf = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tmsg_filter);
		MSG_GlobalIsValid(tmid_paf);
		tmid_paf = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tmsg_filter)	)
{
	ti_au_moins_un_paf = vrai
	
	if ( ! i_flag_visual_check_done )
		AI_Execute("PNJ_Scolo_exec_check_vision")

	to_father	 = EVENT_PereGet(tmid_paf)
	to_sender = EVENT_Gao2Get(tmid_paf)
	if ( ! to_sender )
		to_sender = to_father

	if (to_father == o_predateur)
		i_flag_grab_paf = vrai

	tf_puissance = EVENT_PafPuisGet(tmid_paf)
	ti_paf_type = EVENT_PafTypeGet(tmid_paf)
	ti_canal = EVENT_PafCanalGet(tmid_paf)
	
	i_paf_type |= ti_paf_type
	
	if ( ti_paf_type & C_PAF_KK_FoodChain )		// Vince : Attention aux bits de paf entre Kong et Jack !!!!!
	{
		f_point_de_viande -= MATH_FloatMin(f_point_de_viande, tf_puissance)
		
		i_flag_paf = vrai
	
		// RAGDOLL ============================

		i_modules_pafed_index = i_modules_nb >> 1
		v_module_paf_dir = MATH_VecBlendRotate(EVENT_PafDirGet(tmid_paf), Cv_VerticalVector, 0.85)
		MATH_VecSetNormalize(v_module_paf_dir)
		v_module_paf_dir *= 20.0

		i_on_ground_modules_nb = 0
		f_delay_until_last_wall_col = 1000.0
	
		f_ragdoll_damping = 1.0
		i_flag_start_ragdoll_damping = faux
	
		for (ti_i = 0; ti_i < i_modules_nb; ti_i++)
		{
			av_bone_col_normal[ti_i] = Cv_NullVector
			af_bone_ground_col_timer[ti_i] = 1000.0
		}
		// RAGDOLL ============================

		continue
	}

	if (ti_canal == -1)
		ti_canal = 5		// pour Kong et autres acteurs qui n'envoient pas des pafs canal
	
// KING KONG 2 Merge Gestion des Dommages =============================

	if  (ti_paf_type & C_PAF_KK_Repousse)
		tf_puissance = 0.0
	if ( ti_canal == Anim_Canal_Tete )
		tf_puissance *= 3.0
	if (ti_paf_type & C_PAF_KK_KiTue)
		PNJ_Scolo_Minimise_Life(0.0, to_father)
	if (ti_paf_type & C_PAF_KK_Fire)
		PNJ_Scolo_Minimise_Life(0.0, to_father)
	if (killed_by_javelin && (ti_paf_type & C_PAF_KK_Javelin) )
		PNJ_Scolo_Minimise_Life(0.0, to_father)
	if( ! OBJ_CapaTest(OBJ_Capa_15) )		// maximiser la vie que si je suis pas déjà mort
		PNJ_Scolo_Remove_Life(tf_puissance, to_father)
	
//	if (i_flag_kong_mode)
//	{
//		// Kong Mode -----------------------------------------------------------------------------------
//
//		SND_RequestPlay(SND_KONG_PAFFED)
//		
//		if  (ti_paf_type & C_PAF_KK_Repousse)
//			tf_puissance = 0.0
//			
//		// POINTS DE VIE
//		if (ti_paf_type & C_PAF_KK_KiTue)
//			PNJ_Scolo_Minimise_Life(0.0, to_father)
//		else
//		{
//			if( ! OBJ_CapaTest(OBJ_Capa_15) )		// maximiser la vie que si je suis pas déjà mort
//				PNJ_Scolo_Remove_Life(tf_puissance, to_father)
//		}
//		
//		if( Proc_KS_Scolo_Pafs_Effects_Check(ti_paf_type) )
//			@o_main_actor Proc_KK_Pafs_Effects(faux)
//	}
//	else
//	{
//		// Jack Mode -----------------------------------------------------------------------------------
//		if (ti_paf_type & C_PAF_KK_Repousse)
//			tf_puissance = 0.0
//	
//		if ( ti_canal == Anim_Canal_Tete )
//			tf_puissance *= 3.0
//	
//		// POINTS DE VIE
//		PNJ_Scolo_Remove_Life(tf_puissance, to_father)
//	
////		if (ti_paf_type & C_EVENT_PAF_Blessant)
////			PNJ_Scolo_Minimise_Life(f_life * Cf_Life_Blesse, to_father)
////		
////		if (ti_paf_type & C_EVENT_PAF_Agonisant)
////			PNJ_Scolo_Minimise_Life(f_life * Cf_Life_Agonisant, to_father)
////		
////		if (ti_paf_type & C_EVENT_PAF_Tuant)
////			PNJ_Scolo_Minimise_Life(0.0, to_father)
////		
//
//		if (ti_paf_type & C_PAF_KK_KiTue)
//			PNJ_Scolo_Minimise_Life(0.0, to_father)
//
//		if (ti_paf_type & C_PAF_KK_Fire)
//			PNJ_Scolo_Minimise_Life(0.0, to_father)
//
//		if (killed_by_javelin && (ti_paf_type & C_PAF_KK_Javelin) )
//			PNJ_Scolo_Minimise_Life(0.0, to_father)
//	}
// KING KONG 2 Merge Gestion des Dommages =============================

	v_module_paf_dir = EVENT_PafDirGet(tmid_paf)
	MATH_VecSetNormalize(v_module_paf_dir)
	
	if (f_lifecur)
	{	
		if (TIME_Elapsed(f_time_last_paf_sound, f_delay_between_paf_sound))
		{
			f_time_last_paf_sound = TIME_Get()
			f_delay_between_paf_sound = MATH_RandFloat(0.4, 0.6)
			
			SND_RequestPlay(SND_PAF)
		}
	}
	else if ( ! i_flag_death_sound_played)
	{
		OBJ_CapaSet(OBJ_Capa_15, none)	
	
		i_flag_death_sound_played = vrai
		SND_RequestPlay(SND_DIE)
	}

	f_time_last_paf = TIME_Get()


// KING KONG 2 Merge Gestion Network =============================
	o_next_wp = nobody
//	v_module_paf_dir.z = MATH_FloatMax(v_module_paf_dir.z, 1.0)
	if (ti_paf_type & C_PAF_KK_Repousse)
		v_module_paf_dir *= 40.0
	else if (ti_paf_type & C_PAF_KK_Fire)
		v_module_paf_dir *= 25.0
	else if (ti_paf_type & (C_PAF_KK_Weapon | C_PAF_KK_Javelin) )
		v_module_paf_dir *= MATH_FloatLimit(tf_puissance * 10.0, 20.0, 100.0)
	else if (ti_paf_type & C_PAF_KK_Moyen)
		v_module_paf_dir *= 100.0
	else if (ti_paf_type & C_PAF_KK_Fort)
		v_module_paf_dir *= 140.0
	
//	if (i_flag_kong_mode)
//	{
//		o_next_wp = nobody	
//
//		// Kong Mode -----------------------------------------------------------------------------------
//		if (ti_paf_type & C_PAF_KK_Repousse)
//		{
//			ti_canal	= 5
//		
//			v_module_paf_dir.z = MATH_FloatMax(v_module_paf_dir.z, 1.0) 
//			v_module_paf_dir *= 40.0
//		}
//		else if (ti_paf_type & C_PAF_KK_Moyen)
//		{
//			ti_canal	= 5
//		
//			v_module_paf_dir.z = MATH_FloatMax(v_module_paf_dir.z, 1.0)
//			v_module_paf_dir *= 100.0		// FRED
//		}
//		else if (ti_paf_type & C_PAF_KK_Fort)
//		{
//			ti_canal	= 5
//		
//			v_module_paf_dir.z = MATH_FloatMax(v_module_paf_dir.z, 1.0)
//			v_module_paf_dir *= 140.0		// FRED
//		}
//	}
//	else 
//	{
//		// Jack Mode -----------------------------------------------------------------------------------
//		if (ti_paf_type & (C_PAF_KK_Weapon | C_PAF_KK_Javelin) )
//		{
//			o_next_wp = nobody	
//			v_module_paf_dir *= MATH_FloatLimit(tf_puissance * 10.0, 20.0, 100.0)
//		}
//		else if (ti_paf_type & C_PAF_KK_Repousse)
//		{
//			o_next_wp = nobody	
//			v_module_paf_dir *= 40.0
//		}
//		else if (ti_paf_type & C_PAF_KK_Fire)
//		{
//			o_next_wp = nobody	
//			v_module_paf_dir *= 25.0
//		}
//	}
// KING KONG 2 Merge Gestion Network =============================

	v_module_paf_dir.z = MATH_FloatMax(v_module_paf_dir.z, 1.0)

	// RAGDOLL ============================
	i_on_ground_modules_nb = 0
	f_delay_until_last_wall_col = 1000.0

	f_ragdoll_damping = 1.0
	i_flag_start_ragdoll_damping = faux

	for (ti_i = 0; ti_i < i_modules_nb; ti_i++)
	{
		av_bone_col_normal[ti_i] = Cv_NullVector
		af_bone_ground_col_timer[ti_i] = 1000.0
	}
	// RAGDOLL ============================

	if (i_modele == Ci_Modele_Big && f_lifecur)
	{
		f_move_speed = 0.0
	}
	else
	{
		i_flag_paf = vrai
		i_flag_trigger_attack_used = vrai

		PNJ_Scolo_Virtual_Net_Init(vrai, nobody)

		if (ti_canal == Anim_Canal_Bassin)
			i_modules_pafed_index = i_modules_nb - 1
 		else
			i_modules_pafed_index = ti_canal
		
		if ( ti_paf_type & C_PAF_KK_Javelin )
		{
			for (ti_i = 0; ti_i < 10; ti_i++)
			{
				if (ao_javelin[ti_i])
				{
					macro_set_javelin_plug_timer(ao_javelin[ti_i], 0.0)
					ao_javelin[ti_i] = nobody
				
					if (ai_javelin_bone_index[ti_i] != -1)
					{
						ai_modules_locked[ai_javelin_bone_index[ti_i]] = faux
						ai_modules_perfored[ai_javelin_bone_index[ti_i]] = faux
						ai_javelin_bone_index[ti_i] = -1
					}
				}
			}
	
			i_perfored_module_index = i_modules_pafed_index
			f_time_javelin_paf = TIME_Get()
	
			ai_modules_perfored[i_modules_pafed_index] = vrai
			av_modules_quat[i_modules_pafed_index] = @ao_modules[i_modules_pafed_index] MATH_VecGlobalToLocal(@to_sender OBJ_SightGet())
			
			av_modules_speed[i_modules_pafed_index] = @get_Arme_Lance_path to_sender v_last_speed
			v_javelin_friction = @get_Arme_Lance_path to_sender mv_LaunchFriction
			v_javelin_gravity = @get_Arme_Lance_path to_sender mv_LaunchGravity

//			DBG_RenderVector(@ao_modules[i_modules_pafed_index] OBJ_PosGet(), av_modules_speed[i_modules_pafed_index], color_jaune)
//			DYN_LIB_Display_Trajectory(@ao_modules[i_modules_pafed_index] OBJ_PosGet(), av_modules_speed[i_modules_pafed_index], v_javelin_gravity, v_javelin_friction, 0.2, 20, 0.0)

			ti_index = ARR_ObjSearch(&ao_javelin[0], 10, nobody)
			if (ti_index != -1)
			{
				ao_javelin[ti_index] = to_sender
				ai_javelin_bone_index[ti_index] = i_modules_pafed_index
			}
		}
	}

//	f_lifecur = f_life
	if (f_lifecur)
	{
		// ON AJOUTE CE PERSO A LA LISTE DES PERSOS PERCUS
		ti_perceived_status = Ci_PERCEIVED_PAF
		
		if ( ti_paf_type & C_PAF_KK_Javelin )
			ti_perceived_status |= Ci_PERCEIVED_JAVELIN_PAF

		ti_index = PNJ_Scolo_Add_Perceived_Actor(to_father, ti_perceived_status, tmid_vision_event)

		if (i_flag_grab_paf)
			v_module_paf_dir *= 1.5
		else if (ti_index != -1 && ai_perceived_ID[ti_index] == C_ID_Scolo)
			v_module_paf_dir *= 4.0
	}
	else
	{
		PNJ_Scolo_Del_Interest()
	}
}


// GFX BLOOD ====================================================
if( ti_au_moins_un_paf && tf_life_init > 0.0 )
{
	tv_temp = v_module_paf_dir
	if( ! MATH_VecNullToler(tv_temp, 0.1) )
		MATH_VecSetNormalize(tv_temp)
	else
		tv_temp = - OBJ_SightGet()
	Proc_KK_Scolo_GFX_Particules(@ao_modules[4] OBJ_PosGet(), tv_temp)
}

