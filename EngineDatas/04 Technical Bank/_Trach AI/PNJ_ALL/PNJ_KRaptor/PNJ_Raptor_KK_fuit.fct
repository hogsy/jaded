#include "PNJ_Raptor_KK_defines.var"

float			tf_delay_since_last_update


// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	o_wp_fuite = nobody
	
	i_sort_etat = faux
	return
}

// INITIALISATION ETAT ==============================================================
if (i_etat_courant != ETAT_KK_fuit)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_KK_fuit

	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}
	
	fct_last_etat = AI_TrackCurGet()
	
	// Calcul du wp de fuite à atteindre
	o_wp_fuite = WAY_WPNearestOfOBJ(n_deplacement, Ci_WP_capa_fuite, none, Ci_Filter_CapaFlag)
	if( o_wp_fuite )
		v_look_pos = @o_wp_fuite OBJ_PosGet()
	else
		macro_change_etat("PNJ_Raptor_KK_attente")
	
	f_time_start_etat = 0.0
	i_propose_camera_fight = faux
}

// ANALYSE =======================================================================================================

o_grabbed_actor_KK = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_grabbed_by_Kong_LNK_ID, vrai, nofunc, nofunc)
if (o_grabbed_actor_KK)
	macro_change_etat("PNJ_Raptor_KK_grabbed")
	
AI_Execute("PNJ_Raptor_KK_exec_check_paf")
if( o_paf_actor )
{
	KR_Paf_Resolution(fct_track_change)
	if( fct_track_change != nofunc )
		macro_change_etat(fct_track_change)
}


// COMPORTEMENT =======================================================================================================

if( ! COL_Pivot_BVCollide(o_wp_fuite) )
{
	f_time_start_etat = 0.0
	ACT_ActionSet(Action_Normal_Course)
	
	// orientation vers le wp de fuite
	v_sens_orientation = @o_wp_fuite OBJ_PosGet() - OBJ_PosGet()
//	OBJ_BankingGeneralSet( MATH_VecBlendRotate(OBJ_SightGet(), @o_wp_fuite OBJ_PosGet() - OBJ_PosGet(), 5 * TIME_GetDt()), Cv_VerticalVector )
}
else
{
	// le raptor a atteint le wp de fuite -> il observe
	if( f_time_start_etat == 0.0 )
		ACT_ActionSet(Action_Observe)
	
	f_time_start_etat += TIME_GetDt()
	
	// orientation vers Kong
	v_sens_orientation = @o_KONG OBJ_PosGet() - OBJ_PosGet()
//	OBJ_BankingGeneralSet( MATH_VecBlendRotate(OBJ_SightGet(), @o_main_actor OBJ_PosGet() - OBJ_PosGet(), 3 * TIME_GetDt()), Cv_VerticalVector )
	
	if( f_time_start_etat > Cf_duree_fuite_observe )
		macro_change_etat("PNJ_Raptor_KK_attente")
}

// ORIENTATION
AI_Execute("PNJ_Raptor_KK_exec_orientation")

