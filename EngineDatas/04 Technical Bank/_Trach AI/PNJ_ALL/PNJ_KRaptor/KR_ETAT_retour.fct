#include "KR_defines.var"

vector	tv_new_sight
vector	tv_new_banking


// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	i_sort_etat = faux
	return
}

// INITIALISATION ETAT ==============================================================
if (i_etat_courant != ETAT_Retour)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Retour

	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}
	
	fct_last_etat = AI_TrackCurGet()

	if ( ! o_net_head)
	{
		o_retour_WP = o_retour_WP
	}
	else
	{
		n_retour_net = @o_net_head WAY_NetOfObj()
		o_retour_WP = WAY_WPNearestOfOBJ( n_retour_net, all, none, 0)
	}
	
	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

if( f_time_start_etat > 2.0)
{
	AI_Execute("KR_exec_select_fight_actor")
	if (  KR_Check_Fight_Actor_Interet() )
	{
		if( o_ANN && ( o_fight_actor == o_ANN ) )
			macro_change_etat("KR_ETAT_fight_ANN")	
		else if( o_fight_actor == o_KONG )
			macro_change_etat("KR_ETAT_fight_KONG")
	}
}

if ( o_retour_WP && ! COL_Pivot_BVCollide(o_retour_WP) 
&& OBJ_SqrDistHorz( o_retour_WP) > 9.0)
{
	ACT_ActionSet(Action_Normal_Trot)

	v_sens_orientation = @o_retour_WP OBJ_PosGet() - OBJ_PosGet()
	MATH_VecSetNormalize(v_sens_orientation)
	
	tv_new_sight = MATH_VecBlendRotate(OBJ_SightGet(), v_sens_orientation, 5.0 * TIME_GetDt())
	tv_new_banking = MATH_VecBlendRotate( OBJ_BankingGet(), Cv_VerticalVector, 6.0 * TIME_GetDt()) 
	
	OBJ_SightGeneralSet(tv_new_sight, tv_new_banking)
}
else
{
	ACT_ActionSet( Action_Normal_Attente)
}