#include "PNJ_Raptor_KK_defines.var"

int			ti_i
int			ti_action

object	to_head
object	to_grab_actor

vector	tv_temp
vector	tv_normal 

// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	i_sort_etat = faux

	if (i_etat_courant != ETAT_lance)
		o_grab_actor = LNK_ClientGet(Ci_LNK_GRAB_RAPTOR, mid_grab_actor_LNK_ID, faux, nofunc, nofunc, nofunc)

	return
}

// INITIALISATION ETAT ==============================================================
if (i_etat_courant != ETAT_grab)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_grab

	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}

	fct_last_etat = AI_TrackCurGet()

	ACT_ActionSet(Action_Fight_Secoue)

	if (MATH_VecDotProduct(@o_grab_actor OBJ_PosGet() - OBJ_PosGet(), @o_grab_actor OBJ_SightGet()) > 0.0)
		@o_grab_actor ACT_ActionSet(70) // Action_Grabed_raptor_bras
	else
		@o_grab_actor ACT_ActionSet(71) //Action_Grabed_raptor_jambe

	i_flag_reset_interet = vrai
	f_force_look_delay = 4.0
		
	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE =======================================================================================================
ti_action = @o_fight_actor ACT_ActionGet() 
if (ti_action == 71)
	i_grab_flag_bite_leg = vrai

o_grabbed_actor_KK = LNK_ServeurGet(Ci_LNK_KKGRAB_OBJECT, mid_grabbed_LNK_ID, vrai, nofunc, nofunc)
if (o_grabbed_actor_KK)
	macro_change_etat("PNJ_Raptor_KK_grabbed")

macro_check_proie_groupe
if( ! o_proie_groupe )
{
	AI_Execute("PNJ_Raptor_KK_exec_check_sound")
	AI_Execute("PNJ_Raptor_KK_exec_check_vision")
	AI_Execute("PNJ_Raptor_KK_exec_check_interet")
}

AI_Execute("PNJ_Raptor_KK_exec_check_paf")
if (i_paf_tombe)
	macro_change_etat("PNJ_Raptor_KK_paf")


to_grab_actor = LNK_ClientGet(Ci_LNK_GRAB_RAPTOR, mid_grab_actor_LNK_ID, vrai, nofunc, nofunc, nofunc)
if (o_grab_actor != to_grab_actor)
	macro_change_etat(fct_main_etat)


if ( f_time_start_etat > 10.0)
{
	// Tuer Ann apres 10s
	macro_change_etat("PNJ_Raptor_KK_lance")
}

AI_Execute("PNJ_Raptor_KK_exec_check_fury")
if ( o_flee_actor )
	macro_change_etat("PNJ_Raptor_KK_intimide")


EVENT_InteretStatusSet(mid_best_interet, C_EVENT_InteretStatusLock)
EVENT_LifeSet(mid_best_interet, 10.0)
EVENT_InteretSeenTimeSet(mid_best_interet, TIME_Get())
EVENT_InteretPrecisionSet(mid_best_interet, 0.0)

o_fight_actor = EVENT_InteretTargetGet(mid_best_interet)

// COMPORTEMENT =================================================================================================
if (f_force_look_delay < 2.0)
{
	i_flag_look = vrai

	v_look_pos = @o_force_look_actor OBJ_PosGet()
	v_look_pos.z += 1.0
	
	ACT_ActionSet(Action_Observe)

	f_time_start_etat = 0.0
}
else if (f_time_start_etat > 8.0)
{
	i_flag_look = vrai
//	i_look_Z_snap = vrai
	
	v_look_pos = OBJ_PosGet()
	v_look_pos += OBJ_SightGet() * 5.0
	v_look_pos += OBJ_HorizonGet() * (MATH_Sin(f_time_start_etat * 8.0) * (MATH_Cos(f_time_start_etat * Cf_PiBy2) * 8.0))
	v_look_pos.z += 2.0

	ACT_ActionSet(Action_Observe)	
	returntrack
}
else
{
	ACT_ActionSet(Action_Fight_Secoue)
}

//OBJ_BankingGeneralSet(-OBJ_SightGet(), Cv_VerticalVector)	

v_way_destpos = OBJ_PosInitGet()
//AI_Execute("PNJ_Raptor_KK_exec_way_find")
//
//OBJ_BankingGeneralSet(-OBJ_SightGet(), Cv_VerticalVector)	

if( COL_CollideType( COL_C_Wall) 
|| (GRID_CapaGet( OBJ_PosGet() - OBJ_SightGet()) & Ci_sol_mur))
	i_way_moving  = faux
else
	i_way_moving  = vrai


tv_temp = v_way_destpos
tv_temp -= OBJ_PosGet()
tv_temp.z = 0.0

if (MATH_VecDotProduct(tv_temp, tv_temp) > 4.0 && i_way_moving)
{
	f_way_rot_speed	= MATH_FloatBlend(f_way_rot_speed, 6.0,  TIME_GetDt())	

	v_joy_dir = OBJ_PosGet()
//	v_joy_dir -= v_way_case_dest
	v_joy_dir -= v_way_destpos
	v_joy_dir.z = 0.0
	
	f_joy_norm = MATH_VecNorm(v_joy_dir)

	ACT_ActionSet(Action_Fight_Secoue)
	if (i_way_moving && f_joy_norm)
	{
		v_joy_dir /= f_joy_norm
		OBJ_BankingGeneralSet(MATH_VecBlendRotate(OBJ_SightGet(), v_joy_dir, f_way_rot_speed * TIME_GetDt()), Cv_VerticalVector)
	}
}
else
{ 
	f_way_rot_speed = 0.0
	ACT_ActionSet(Action_Observe)
}

if ( i_jump_etat)
	AI_Execute("PNJ_Raptor_KK_exec_select_action")	

