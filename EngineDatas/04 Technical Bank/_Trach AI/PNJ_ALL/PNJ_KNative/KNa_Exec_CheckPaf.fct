Include_UltraProcedure_Header

#include"KNa_Defines.var"


int					ti_rank
int					ti_paf_type 
float				tf_puissance
int					ti_canal
float				tf_paf_value, tf_paf
vector			tv_paf_dir
messageid		tmid_paf_event
message		EVT_msg_filter

vector			tv_pos
int					ti_collide
int					ti_i
float				tf_rand

if (f_no_paf_time > 0.0 || i_no_paf )
	return

if( i_etat_courant == ETAT_Paf || i_etat_courant == ETAT_Dead )
	return

EVT_Paf_Pere = nobody
f_paf_degats = 0

if (m_script.msg_int3 & Ci_Filtre_NoCol)
	return

MSG_SetNull( EVT_msg_filter)
EVT_msg_filter.msg_gao1 = OBJ_Me()			// Je cherche tous les Events Paf me concernant !

ti_rank = -1
tf_paf_value = 0
tv_paf_dir = Cv_NullVector
ti_canal = -1

tmid_paf_event = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, EVT_msg_filter)
while(MSG_GlobalIsValid(tmid_paf_event))
{
	ti_paf_type = EVENT_PafTypeGet(tmid_paf_event)
	
	// ignore being accidently paffed by another native (SHOULD NOT HAPPEN ANYMORE)
	if (ti_paf_type & C_PAF_KK_Digwazai)
	{
		tmid_paf_event = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, EVT_msg_filter)
		continue
	}

	tf_puissance = EVENT_PafPuisGet(tmid_paf_event)
	EVT_Paf_Pere = EVENT_PereGet(tmid_paf_event)

//	tmid_vision_event = EVENT_FindEventPereTarget(C_EVENT_TYPE_Visibility, EVT_Pere, nobody)
//	if (!MSG_GlobalIsValid(tmid_vision_event))
//		DBG_Error("Je suis pafé par quelqu'un qui n'existe pas !!!")

//	v_paf_dir = EVENT_PafDirGet(tmid_paf_event)
	
	// Désynchroniser les natifs : ne pas partir dans la même direction
	v_paf_dir = OBJ_PosGet() - @EVT_Paf_Pere OBJ_PosGet()
	v_paf_dir.z = 0.0
	if( ! MATH_VecNullToler(v_paf_dir, 0.1) )
		MATH_VecSetNormalize(v_paf_dir)
	else
		v_paf_dir = - OBJ_SightGet()
	
	if ( EVT_Paf_Pere != AI_MainActorGet(C_ID_Kong) || @EVT_Paf_Pere ACT_ActionGet() != 150)
		i_paf_from_grab = faux
	else
		i_paf_from_grab = vrai	
	
	
	// POINTS DE VIE
	f_lifecur -= MATH_FloatMin(f_lifecur, tf_puissance)
	f_paf_degats += tf_puissance

	tmid_paf_event = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, EVT_msg_filter)
}

// Si ce perso accessible alors il devient ma target
if (KNative_LIB_Target_Check_This_One(EVT_Paf_Pere))
	o_target = EVT_Paf_Pere



//if ( ! EVT_Paf_Pere)
//{
//	// check Kong ecrapou
//	for (ti_i = 20; ti_i <= 80; ti_i += 20)
//	{
//		tv_pos = OBJ_PosGet()
//		ti_collide = @get_kong Proc_KK_PosCollideWithBone(tv_pos,ti_i)
//		if (ti_collide)
//		{
//			//ti_paf_type = EVENT_PafTypeGet(tmid_paf_event)
//		
//			//tf_puissance = EVENT_PafPuisGet(tmid_paf_event)
//			tf_puissance = 10.0
//	
//			EVT_Paf_Pere = get_kong
//	
//			tf_rand = MATH_RandFloat(-Cf_PiBy4,Cf_PiBy4)
//			v_paf_dir = MATH_VecRotate(@EVT_Paf_Pere OBJ_SightGet(),OBJ_BankingGet(),tf_rand)
//			//v_paf_dir = @EVT_Paf_Pere OBJ_SightGet()
//	
//			// POINTS DE VIE
//			f_lifecur -= MATH_FloatMin(f_lifecur, tf_puissance)
//			f_paf_degats += tf_puissance
//	
//		}
//	}
//
//}