#include "PNJ_Brontosaure_defs.var"

int			ti_index
int			ti_crossable
vector	tv_pos
object	to_pasta, to_bone
float		tf_zoom

//no_IK_LEG = vrai
//no_IK_NECK = vrai
//no_SMOKE = vrai

OBJ_PosSet(OBJ_PosGet() + cvector(0,0,0.5))
COL_StartMatrixSet(OBJ_PosGet())

//--------( Check )--------
if ( ( move_network == nonet ) && (move_o_Lead == nobody ) )
{
	DBG_TraceObject( OBJ_Me() )
	DBG_TraceString( "-----> no network nor Leader, ai stop !" )
	DBG_TraceEOL()
	AI_TrackCurStop()
	return
}
//--------( check respawn )--------
if ( move_i_Respawn )
{
//	if ( (move_network != nonet) && (Follower_Nb != 0 ) )
//	{
//		DBG_TraceObject( OBJ_Me() )
//		DBG_TraceString( "-------> leader with follower and respawn capability is not managed" )
//		DBG_TraceEOL()
//		move_i_Respawn = 0
//	}
//	if ( move_o_Lead )
//	{ 
//		DBG_TraceObject( OBJ_Me() )
//		DBG_TraceString( "-------> follower with respawn capability is not managed" )
//		DBG_TraceEOL()
//		move_i_Respawn = 0
//	}
	move_i_AlreadyRespawn = 1
}

//--------( Init var )--------
OBJ_ZoomSet( f_Zoom )

//---------( Init IK)----------
Bronto_Init_IK()

//--------( get network )--------
if ( move_network != nonet )
{
	move_i_netwpnb = WAY_NetFill( move_network, WAY_RootGet(move_network), &move_ao_netwp[ 0 ] )
	move_network_init = vrai
}

//--------( Init dest pos )--------
//if ( !move_o_Lead )
{
	move_o_WP[ 0 ] = nobody
	move_o_WP[ 1 ]  = WAY_WPNearestOfOBJ( move_network,all, none, Ci_Filter_IdentityFlag)
	if ( !move_o_WP[ 1 ] )
	{
		DBG_TraceObject( OBJ_Me() )
		DBG_TraceString( "-----> no nearest WP in network, ai stop !" )
		DBG_TraceEOL()
		AI_TrackCurStop()
		return
	}
	
	if ( WPBV_i_Use )
	{
		for (ti_index = 0; ti_index < BRONTO_SavedPosNb; ti_index++)
			Lead_Width[ ti_index ] = 1.0
		push( move_o_WP[ 1 ] )
		AI_Execute( "pnjbronto_exec_computewpwidth" )
	}

	move_o_WP[ 2 ] = WAY_NetNextWP( move_network,move_o_WP[ 1 ],0,0)
	AI_Execute( "pnjbronto_exec_computemovedest" )
}
//else
//{
//	if (!AI_HaveSameModel( move_o_Lead ) )
//	{
//		DBG_TraceObject( OBJ_Me() )
//		DBG_TraceString( "-----> leader is not a bronto!" )
//		DBG_TraceEOL()
//		AI_TrackCurStop()
//		return
//	}
//	move_v_dest[0] = @bronto_get_leader Follower_ComputedPos[ move_i_FollowerId ]
//	move_v_dest[1] = move_v_dest[0]
//	
//	if ( Pattes_o_Object[ 0 ] == nobody )
//		Pattes_o_Object[ 0 ] = @bronto_get_leader Pattes_o_Object[ 0 ]
//}

//----( Collision )----
COL_UnCollidableAdd( AI_MainActorGet(C_ID_Joueur) )

//COL_CrossableSet( Gmat_Jack_DefaultCrossable, 0)

COL_CrossableSet(none, all)

//ti_crossable = Gmat_Jack_DefaultCrossable
//ti_crossable |= Gmat_Jack_Face_eau
//ti_crossable |= Gmat_Jack_Face_de_Bord
//ti_crossable |= Gmat_Jack_BordHumain_TraversableNMI
//ti_crossable |= Gmat_Jack_Crossable_All_But_TREX
//ti_crossable |= Gmat_Jack_Crossable_All_But_RAPTORS
ti_crossable = Gmat_KK_Crossable_Default
COL_CrossableSet(ti_crossable, none)

//----( Dynamique )----
DYN_On()
DYN_FlagsSet(DYN_C_GlobalFriction + DYN_C_BasicForces + DYN_C_VectorFriction + DYN_C_NeverDynamicFather, none)
DYN_FrictionVectorSet(cvector(2, 2, 0))
//DYN_GravitySet(Cv_NormalGravity * 100)
DYN_GravitySet(Cv_NormalGravity )
DYN_SpeedSetVector( Cv_NullVector )

//--------( Etat initial )--------
etat_i_courant = -1
etat_i_endofpath = 0
troupe_f_speed = 1.0
f_look_timer = 0.0

AI_TrackChange(1,"pnjbronto_reflex" )

//if ( move_o_Lead )
//	AI_TrackCurChange( "pnjbronto_follower_walk" )
//else
	AI_TrackCurChange( "pnjbronto_walk" )

//AI_TrackCurChange( "pnjbronto_TEST" )

AI_TrackChange(4,"pnjbronto_tag" )


//--------( Lead )--------
if ( Follower_Nb )
{
	if ( Lead_PosInterval  == 0 ) Lead_PosInterval = 10.0
	Lead_Dist = Lead_PosInterval
	Lead_PrevPos = OBJ_PosGet()
	Lead_Pos[ 0 ] = Lead_PrevPos
	Lead_Normal[ 0 ] = OBJ_HorizonGet()
	for (ti_index = 1; ti_index < BRONTO_SavedPosNb; ti_index++ )
	{
		Lead_Pos[ ti_index ] = Lead_Pos[ ti_index - 1 ] - (Lead_PosInterval * OBJ_SightGet() )
		Lead_Normal[ ti_index ]  = Lead_Normal[ 0 ] 
	}
}

//--------( Papattes )--------
Pattes_o_Bones[ BRONTO_Bones_FrontRight ] = ANI_CanalObjectGet( Anim_Canal_MainGauche )
Pattes_i_Canal[ BRONTO_Bones_FrontRight ] = Anim_Canal_MainGauche
Pattes_o_Bones[ BRONTO_Bones_FrontLeft ] = ANI_CanalObjectGet( Anim_Canal_MainDroite )
Pattes_i_Canal[ BRONTO_Bones_FrontLeft ] = Anim_Canal_MainDroite
Pattes_o_Bones[ BRONTO_Bones_RearRight ] = ANI_CanalObjectGet( Anim_Canal_PiedDroit )
Pattes_i_Canal[ BRONTO_Bones_RearRight ] = Anim_Canal_PiedDroit
Pattes_o_Bones[ BRONTO_Bones_RearLeft ] = ANI_CanalObjectGet( Anim_Canal_PiedGauche )
Pattes_i_Canal[ BRONTO_Bones_RearLeft ] = Anim_Canal_PiedGauche

if ( 
	(Pattes_o_Bones[ BRONTO_Bones_FrontRight ] == nobody) ||
	(Pattes_o_Bones[ BRONTO_Bones_FrontLeft ] == nobody) ||
	(Pattes_o_Bones[ BRONTO_Bones_RearRight ] == nobody) ||
	(Pattes_o_Bones[ BRONTO_Bones_RearLeft ] == nobody) 
)
	Pattes_o_Object[ 0 ] = nobody

if (Pattes_o_Object[ 0 ] )
{
	to_pasta = Pattes_o_Object[ 0 ]
	if ( @to_pasta AI_IsModel("PNJ_Pacifique/PNJ_Bontosaure_Patte") )
	{
		tv_pos = @to_pasta OBJ_PosGet()
		Pattes_o_Object[ 0 ] = @to_pasta OBJ_Duplicate( tv_pos )
		@Pattes_o_Object[ 0 ] OBJ_ZoomSet( f_Zoom )
		@"PNJ_Pacifique/PNJ_Bontosaure_Patte" Pattes_o_Object[ 0 ] o_Bronto = OBJ_Me()
		COL_UnCollidableAdd( Pattes_o_Object[ 0 ] )

		Pattes_o_Object[ 1 ] = @to_pasta OBJ_Duplicate( tv_pos )
		@Pattes_o_Object[ 1 ] OBJ_ZoomSet( f_Zoom )
		@"PNJ_Pacifique/PNJ_Bontosaure_Patte" Pattes_o_Object[ 1 ] o_Bronto = OBJ_Me()
		COL_UnCollidableAdd( Pattes_o_Object[ 1 ] )

		Pattes_o_Object[ 2 ] = @to_pasta OBJ_Duplicate( tv_pos )
		@Pattes_o_Object[ 2 ] OBJ_ZoomSet( f_Zoom )
		@"PNJ_Pacifique/PNJ_Bontosaure_Patte" Pattes_o_Object[ 2 ] o_Bronto = OBJ_Me()
		COL_UnCollidableAdd( Pattes_o_Object[ 2 ] )

		Pattes_o_Object[ 3 ] = @to_pasta OBJ_Duplicate( tv_pos )
		@Pattes_o_Object[ 3 ] OBJ_ZoomSet( f_Zoom )
		@"PNJ_Pacifique/PNJ_Bontosaure_Patte" Pattes_o_Object[ 3 ] o_Bronto = OBJ_Me()
		COL_UnCollidableAdd( Pattes_o_Object[ 3 ] )

		AI_CBAdd( OBJ_Me(), CTX_AfterBlend, "pnjbronto_cb_afterblend" )
	}
}

IK_ao_Knee[ BRONTO_Bones_FrontRight ] = ANI_CanalObjectGet( Anim_Canal_AvantBrasGauche )
IK_ao_Knee[ BRONTO_Bones_FrontLeft ] = ANI_CanalObjectGet( Anim_Canal_AvantBrasDroit )
IK_ao_Knee[ BRONTO_Bones_RearRight ] = ANI_CanalObjectGet( Anim_Canal_JambeDroite )
IK_ao_Knee[ BRONTO_Bones_RearLeft  ] = ANI_CanalObjectGet( Anim_Canal_JambeGauche )

IK_ao_Leg[ BRONTO_Bones_FrontRight ] = ANI_CanalObjectGet( Anim_Canal_BrasGauche )
IK_ao_Leg[ BRONTO_Bones_FrontLeft ] = ANI_CanalObjectGet( Anim_Canal_BrasDroit )
IK_ao_Leg[ BRONTO_Bones_RearRight ] = ANI_CanalObjectGet( Anim_Canal_CuisseDroite  )
IK_ao_Leg[ BRONTO_Bones_RearLeft  ] = ANI_CanalObjectGet( Anim_Canal_CuisseGauche )

//IK_af_Height[ 0 ] = 1.25
//IK_af_Height[ 1 ] = 1.25
//IK_af_Height[ 2 ] = 1.1
//IK_af_Height[ 3 ] = 1.1

IK_af_Height[ 0 ] = 0.8
IK_af_Height[ 1 ] = 0.8
IK_af_Height[ 2 ] = 0.7
IK_af_Height[ 3 ] = 0.7


IK_ai_PatteState[ 0 ] = 2
IK_ai_PatteState[ 1 ] = 2
IK_ai_PatteState[ 2 ] = 2
IK_ai_PatteState[ 3 ] = 2

//-------( OBBOX )---------------------
to_bone = ANI_CanalObjectGet(Anim_Canal_Machoire)
@to_bone BV_OBBoxMinSet( Cv_NullVector )
@to_bone BV_OBBoxMaxSet( Cv_NullVector )

to_bone = ANI_CanalObjectGet(Anim_Canal_Tete)
@to_bone BV_OBBoxMinSet(cvector(-0.6, -1.0, -0.5))
@to_bone BV_OBBoxMaxSet(cvector(0.6, 0.6, 2.2))

to_bone = ANI_CanalObjectGet(Anim_Canal_Cou)
@to_bone BV_OBBoxMinSet(cvector(-0.6, -1.0, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.6, 0.9, 2.0))

to_bone = ANI_CanalObjectGet(Anim_Canal_Torse)
@to_bone BV_OBBoxMinSet(cvector(-0.6, -1.0, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.6, 0.9, 2.8))

to_bone = ANI_CanalObjectGet(Anim_Canal_Ventre)
@to_bone BV_OBBoxMinSet(cvector(-0.9, -1.8, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.9, 1.2, 3.5))

to_bone = ANI_CanalObjectGet( 4 )
@to_bone BV_OBBoxMinSet(cvector(-1.5, -4.0, -0.9))
@to_bone BV_OBBoxMaxSet(cvector(1.5, 1.5, 5.0))

to_bone = ANI_CanalObjectGet( 5 )
@to_bone BV_OBBoxMinSet(cvector(-2.0, -4.5, -0.8))
@to_bone BV_OBBoxMaxSet(cvector(2.0, 1.5, 4.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_Bassin)
@to_bone BV_OBBoxMinSet(cvector(-1.8, -3.0, -0.5))
@to_bone BV_OBBoxMaxSet(cvector(1.8, 1.5, 4.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_Queue)
@to_bone BV_OBBoxMinSet(cvector(-1.5, -1.5, -0.1))
@to_bone BV_OBBoxMaxSet(cvector(1.5, 2.1, 0.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_Queue + 1)
@to_bone BV_OBBoxMinSet(cvector(-0.9, -1.2, -0.1))
@to_bone BV_OBBoxMaxSet(cvector(0.9, 1.2, 4.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_Queue + 2)
@to_bone BV_OBBoxMinSet(cvector(-0.6, -0.9, -0.1))
@to_bone BV_OBBoxMaxSet(cvector(0.6, 0.9, 4.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_Queue + 3)
@to_bone BV_OBBoxMinSet(cvector(-0.6, -0.6, -0.1))
@to_bone BV_OBBoxMaxSet(cvector(0.6, 0.6, 4.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_Queue + 4)
@to_bone BV_OBBoxMinSet(cvector(-0.3, -0.3, -0.1))
@to_bone BV_OBBoxMaxSet(cvector(0.3, 0.3, 4.0))

to_bone = ANI_CanalObjectGet(Anim_Canal_PiedGauche )
@to_bone BV_OBBoxMinSet(cvector(-0.75, -0.45, -0.15))
@to_bone BV_OBBoxMaxSet(cvector(0.75, 0.3, 1.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_JambeGauche )
@to_bone BV_OBBoxMinSet(cvector(-0.75, -0.9, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.75, 0.6, 3.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_CuisseGauche )
@to_bone BV_OBBoxMinSet(cvector(-0.9, -0.9, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.9, 0.9, 5.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_PiedDroit )
@to_bone BV_OBBoxMinSet(cvector(-0.75, -0.45, -0.15))
@to_bone BV_OBBoxMaxSet(cvector(0.75, 0.3, 1.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_JambeDroite )
@to_bone BV_OBBoxMinSet(cvector(-0.75, -0.9, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.75, 0.6, 3.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_CuisseDroite )
@to_bone BV_OBBoxMinSet(cvector(-0.9, -0.9, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.9, 0.9, 5.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_MainDroite )
@to_bone BV_OBBoxMinSet(cvector(-0.6, -0.6, 0.6))
@to_bone BV_OBBoxMaxSet(cvector(0.75, 1.2, 1.2))

to_bone = ANI_CanalObjectGet(Anim_Canal_AvantBrasDroit )
@to_bone BV_OBBoxMinSet(cvector(-0.6, -0.6, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.6, 0.6, 3.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_BrasDroit )
@to_bone BV_OBBoxMinSet(cvector(-0.9, -0.9, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.9, 0.9, 4.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_MainGauche )
@to_bone BV_OBBoxMinSet(cvector(-0.6, -0.6, 0.6))
@to_bone BV_OBBoxMaxSet(cvector(0.75, 1.2, 1.2))

to_bone = ANI_CanalObjectGet(Anim_Canal_AvantBrasGauche )
@to_bone BV_OBBoxMinSet(cvector(-0.6, -0.6, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.6, 0.6, 3.5))

to_bone = ANI_CanalObjectGet(Anim_Canal_BrasGauche )
@to_bone BV_OBBoxMinSet(cvector(-0.9, -0.9, -0.3))
@to_bone BV_OBBoxMaxSet(cvector(0.9, 0.9, 4.5))





