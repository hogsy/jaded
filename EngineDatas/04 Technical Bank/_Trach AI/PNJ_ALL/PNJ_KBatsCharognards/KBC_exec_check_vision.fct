#include "KBC_defines.var"

int			ti_rank
int			ti_ID

vector	tv_target_pos

object	to_pere

messageid		tmid_ID
messageid		EVT_InfoSeen_ID

if( i_flag_check_vision_done )
	return

i_flag_check_vision_done = vrai

if( EVENT_LIFE_CurLifeGet(ID_LIFE) <= 0.0 )
	return

// CHECK EVENTS VISION -------------------------------------------------------------------------------------------
ti_rank = -1
for (	tmid_ID = MSG_GlobalScan(C_EVENT_TYPE_Visibility, &ti_rank);
		MSG_GlobalIsValid(tmid_ID);
		tmid_ID = MSG_GlobalScan(C_EVENT_TYPE_Visibility, &ti_rank)	)
{
	to_pere = EVENT_PereGet(tmid_ID)
	if ( to_pere && to_pere != OBJ_Me() )
	{
		ti_ID = EVENT_VisionIDGet(tmid_ID)
		
		// COLLISIONS MOLLES ========================================
		if( ti_ID == C_ID_BatCharognard 
			&& @to_pere OBJ_FlagsIdentityTest(OBJ_C_IdentityFlag_AI)
			&& @to_pere AI_IsModel(get_PNJ_KBats_path) )
		{
			// tests multiples pour sécurité envers les cadavres fake de bats
			if( EVENT_VisionLifeStateGet(tmid_ID) > Cf_Life_Dead && (OBJ_SqrDist(to_pere) <= (Cf_dist_detect_budies * Cf_dist_detect_budies)) )
			{
				// bat vivante
				if( ARR_ObjSearch(&ao_budy[0], i_budy_nb, to_pere) == -1 && i_budy_nb < Ci_budy_nb_max )
				{
					// bat pas déjà mémorisée = je la mémorise
					ao_budy[i_budy_nb] = to_pere
					i_budy_nb++
				}
			}
		}
		
		// HUMAINS ET ENNEMIS ========================================
		tv_target_pos = EVENT_PositionGet(tmid_ID)
		if( KBC_Pos_in_Territory(tv_target_pos, faux) )
		{
			KBC_Seen_Actor_Add(tmid_ID)
			if( @to_pere OBJ_FlagsIdentityTest(OBJ_C_IdentityFlag_AI) && @to_pere AI_IsModel(get_Humain_path) )
			{
				EVT_InfoSeen_ID = EVENT_AddEventInfo(OBJ_Me(), to_pere, C_EVENT_INFOTYPE_SEEN)
				EVENT_Info_OutsideGridSet(EVT_InfoSeen_ID, faux)
			}
		}
	}
}


