#include "PNJ_Spider_defines.var"

int					ti_rank
int					ti_ID
int					ti_index

float				tf_dot_product
float				tf_life

object			to_actor

messageid		tmid_visibility
messageid		EVT_InfoSeen_ID

if ( ! f_lifecur )
	return

if (i_flag_visual_check_done)
	return

i_flag_visual_check_done = vrai

PNJ_Spider_Fill_Fire_Array()

if (PNJ_Spider_Get_Check_Vision())
	return

ti_rank = -1
for (tmid_visibility = MSG_GlobalScan(C_EVENT_TYPE_Visibility, &ti_rank); MSG_GlobalIsValid(tmid_visibility); tmid_visibility = MSG_GlobalScan(C_EVENT_TYPE_Visibility, &ti_rank))
{
	to_actor = EVENT_PereGet(tmid_visibility)

	tf_life = EVENT_VisionLifeStateGet(tmid_visibility)

	ti_ID = EVENT_VisionIDGet(tmid_visibility)
	switch(ti_ID)
	{
		case C_ID_Joueur :	
			break

		case C_ID_Spider :
			@get_global ao_spider_budy[@get_global i_spider_budy_nb] = to_actor
			@get_global i_spider_budy_nb++
			continue
			break

		case C_ID_Bidoche :
			if (@to_actor OBJ_CapaTest(CAPA_Bidoche_Snapped_Jack)) // On ne prends pas en compte les bidoches snapé sur la lance tenue par Jack
				continue
			break

		default:
			if (IsThis_ID_Humain(ti_ID))
				continue
			if (tf_life > 0.0)
				continue
	}

	if (tf_life > 0.0)
	{
		if ( ! @to_actor COL_Pivot_BVCollide(BV_Attack) )
			continue
	}
	else
	{
		if (! @to_actor COL_Pivot_BVCollide(BV_ZoneTerritoire) )
			continue
	}

//	if (! IsThis_ID_Humain(ti_ID))
//		continue
		
	ti_index = PNJ_Spider_Add_Perceived_Actor(to_actor, 0, tmid_visibility)
}

if (i_perceived_best_actor_index == -1 && MSG_GlobalIsValid(mid_best_interet))
	EVENT_Delete(mid_best_interet, C_EVENT_DEL)

PNJ_Spider_Update_Near_Fire_Status()
	
PNJ_Spider_Backup_Check_Vision()