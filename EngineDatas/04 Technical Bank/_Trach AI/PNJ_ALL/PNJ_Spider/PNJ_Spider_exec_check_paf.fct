#include "PNJ_Spider_defines.var"

int					ti_rank
int					ti_perceived_status
int					ti_paf_type
int					ti_index
int					ti_seuil_paf_moyen
int					ti_seuil_paf_fort
int					ti_canal

vector			tv_speed
vector			tv_temp

object			to_target
object			to_father

message		tmsg_filter

int					ti_puissance

messageid		tmid_paf
messageid		tmid_vision_event

if (i_flag_paf_check_done)
	return
	
if (tutorial)
	return

i_flag_paf_check_done = vrai

MSG_GlobalSetInvalid(tmid_vision_event)

ti_seuil_paf_moyen = 2
ti_seuil_paf_fort = 2

MSG_SetNull(tmsg_filter)
tmsg_filter.msg_gao1 = OBJ_Me()
ti_rank = -1

for (	tmid_paf = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tmsg_filter);
		MSG_GlobalIsValid(tmid_paf);
		tmid_paf = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tmsg_filter)	)
{
	to_father	 = EVENT_PereGet(tmid_paf)

	ti_puissance = EVENT_PafPuisGet(tmid_paf)
	ti_canal = EVENT_PafCanalGet(tmid_paf)

	if ( ti_canal == Anim_Canal_Tete )
		ti_puissance *= 3

	ti_paf_type = EVENT_PafTypeGet(tmid_paf)
	
//	if ( ! (ti_paf_type & C_EVENT_PAF_Repousse) )
//		f_lifecur -= MATH_FloatMin(f_lifecur, ti_puissance)

	v_paf_dir = EVENT_PafDirGet(tmid_paf)
	MATH_VecSetNormalize(v_paf_dir)
	
	if (f_lifecur)
	{	
		if (TIME_Elapsed(f_time_last_paf_sound, f_delay_between_paf_sound))
		{
			f_time_last_paf_sound = TIME_Get()
			f_delay_between_paf_sound = MATH_RandFloat(0.4, 0.6)
		}
	}
	else if (!i_flag_death_sound_played)
	{
		OBJ_CapaSet(OBJ_Capa_15, none)	
	
		i_flag_death_sound_played = vrai
	}

	f_time_last_paf = TIME_Get()
	
	if (ti_paf_type & (C_PAF_KK_Weapon | C_PAF_KK_Javelin) )
		v_paf_dir *= MATH_FloatLimit(ti_puissance, 1.0, 10.0)
	else
		v_paf_dir *= 2.0

	i_flag_paf = vrai
	i_flag_trigger_used = vrai

//	f_lifecur = f_life
	if (f_lifecur)
	{
		// ON AJOUTE CE PERSO A LA LISTE DES PERSOS PERCUS
		ti_perceived_status = Ci_PERCEIVED_PAF
		
		if (ti_paf_type & C_PAF_KK_Javelin)
			ti_perceived_status |= Ci_PERCEIVED_JAVELIN_PAF

		ti_index = PNJ_Spider_Add_Perceived_Actor(to_father, ti_perceived_status, tmid_vision_event)

		if (ti_index != -1 && ai_perceived_ID[ti_index] == C_ID_Spider)
			v_paf_dir *= 4.0
	}
	else
	{
		EVENT_Delete(mid_best_interet, C_EVENT_DEL)
	}
}

		
	
	
