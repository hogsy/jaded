#include "PNJ_Raptor_defines.var"

float		tf_dist

vector	tv_temp

object	to_target
object	to_collide_object

return

if (OBJ_FlagsStatusGet() & OBJ_C_StatusFlag_Culled)
	return

if (i_flag_paf_faible)
	return

if (i_way_computation_mode == Ci_WAY_MODE_REQUIN && f_requin_mode_duration < 2.0)
	return

if (! MSG_GlobalIsValid(mid_best_interet))
	return

if (@"univ" Humains_PafTimer[i_id_humain])
	return

if (EVENT_InteretSeenTimeGet(mid_best_interet) != TIME_Get())
	return

to_target = EVENT_InteretTargetGet(mid_best_interet)

if (! GRID_LIB_IsReachableFrom(OBJ_PosGet(), @to_target OBJ_PosGet(), 0, -1.0, faux, i_grid_width) )
	return

tv_temp = @to_target OBJ_PosGet()
tv_temp -= OBJ_PosGet()

if (MATH_AbsFloat(tv_temp.z) < 3.0)
{
	tf_dist = MATH_VecDotProduct(tv_temp, tv_temp)

	if (tf_dist > 9.0 && tf_dist < 100.0)
	{
		tf_dist = MATH_FloatSqrt(tf_dist)	
		tv_temp /= tf_dist
	
		if (MATH_VecDotProduct(OBJ_SightGet(), tv_temp) > Cf_Cos60)
		{
			@get_global i_raptor_ray_on_colmap_nb++
			to_collide_object = COL_RayObject_Dist(COL_ZonePosGet(C_zdm_pied), tv_temp, tf_dist, all, none, Ci_Filter_IdentityFlag, COL_C_Ray_on_ColMap_NoCrossable)
			if (!to_collide_object || to_collide_object == to_target)
				macro_change_etat("PNJ_Raptor_ETAT_terrasse")
		}
	}
}

