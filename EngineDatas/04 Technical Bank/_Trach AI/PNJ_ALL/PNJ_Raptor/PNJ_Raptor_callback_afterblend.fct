#include "PNJ_Raptor_defines.var"

int			ti_flag_ok

float		tf_dist
float		tf_coef

vector	tv_pos
vector	tv_temp
vector	tv_head_speed

object	to_target
object	to_wp
object	to_wp_2
object	to_machoire

#ifdef SHOW_RASTER
DBG_StartRaster(0, "IA Raptor")
DBG_StartRaster(9, "After Blend")
#endif

to_machoire = ANI_CanalObjectGet(Anim_Canal_Machoire)

if (ACT_ActionFinished())
{
	if (i_finished_action_trame_nb && i_finished_action == ACT_ActionGet())
		DBG_Error("BUG ANIM")

	i_finished_action = ACT_ActionGet()
	i_finished_action_trame_nb ++
}
else
{
	i_finished_action_trame_nb = 0
}

//if (raptor_type == C_ID_Tyranosaure)
//{
//	@ao_head_bones[Anim_Canal_Tete] OBJ_RotateLocalX(-0.9)
//	@o_ventre OBJ_RotateLocalX(0.4)
//}

if (COL_GMatReportGet(Gmat_KK_Face_de_mort) != -1)
	OBJ_Destroy()

if (i_flag_teleport)
	PNJ_Raptor_Reset_IK()

if (i_flag_snap_pos)
{
	switch(ACT_ActionGet())
	{
		case Action_Saut_fin_surplace :
		case Action_Saut_Reception_D :
		case Action_Saut_Reception_G :
			OBJ_PosSet(v_snap_pos)
			break

		default:
			i_flag_snap_pos = faux
	}
}

v_last_dyn_speed = v_dyn_speed
v_dyn_speed = DYN_SpeedGetVector()

//to_wp = GST_Climb_NearestBVWaypoint(OBJ_PosGet(), n_net, Ci_Capa_Balade, none, tv_temp)
//if (to_wp)
//{
//	DBG_RenderVector(OBJ_PosGet(), tv_temp - OBJ_PosGet(), color_jaune)
//
//	if (GST_Climb_Intersection_Dir_BV(OBJ_PosGet(), MATH_VecNormalize(@to_wp OBJ_PosGet() - OBJ_PosGet()), to_wp, tf_dist, tv_temp))
//		DBG_RenderVector(OBJ_PosGet(), tv_temp - OBJ_PosGet(), color_blanc)
//}

//tv_temp = OBJ_PosGet()
//tv_temp -= OBJ_SightGet() * 4.0
//tv_temp.z += 1.0
//@o_main_actor OBJ_PosSet(tv_temp)
//@o_main_actor COL_StartMatrixSet(tv_temp)
//@o_main_actor OBJ_BankingGeneralSet(OBJ_SightGet(), Cv_VerticalVector)
//@get_camera OBJ_BankingGeneralSet(OBJ_SightGet(), Cv_VerticalVector)

AI_Execute("PNJ_Raptor_exec_IK_legs")

if (raptor_type == C_ID_Raptor)
{
	av_feet_last_pos[Ci_IK_pied_gauche] = @ao_IK_bones[Ci_IK_pied_gauche][3] OBJ_PosGet()
	av_feet_last_pos[Ci_IK_pied_droit] = @ao_IK_bones[Ci_IK_pied_droit][3] OBJ_PosGet()
}

AI_Execute("PNJ_Raptor_exec_neck")

AI_Execute("PNJ_Raptor_exec_IK_hands")

switch(raptor_type)
{
 	case C_ID_Tyranosaure :

//		// SNAP BAT ======================================================================
//		ti_flag_ok = vrai
//		
//		if (i_perceived_best_actor_index == -1)
//			ti_flag_ok = faux
//		else if (ai_perceived_ID[i_perceived_best_actor_index] != C_ID_BatCharognard)
//			ti_flag_ok = faux
//		else if (ACT_ActionGet() != Action_Mange_Au_Sol)
//			ti_flag_ok = faux
//		else if (ANI_CurrentFrameGet(0) < 40)
//			ti_flag_ok = faux
//
//		if (ti_flag_ok)
//		{
//			to_machoire = ANI_CanalObjectGet(Anim_Canal_Machoire)
//		
//			tv_pos = @to_machoire OBJ_PosGet()
//			tv_pos += @to_machoire OBJ_BankingGet()
//			
//			@ao_perceived_actor[i_perceived_best_actor_index] OBJ_PosSet(tv_pos)
//			@ao_perceived_actor[i_perceived_best_actor_index] OBJ_BankingGeneralSet(@to_machoire OBJ_BankingGet(), @to_machoire OBJ_SightGet())
//		}

		// OUVERTURE BOUCHE =============================================================
		ti_flag_ok = vrai

		if (i_etat_courant != ETAT_FIGHT)
			ti_flag_ok = faux
		else if ( ! i_flag_head_search )
			ti_flag_ok = faux
		else if (i_perceived_best_actor_index == -1)	
			ti_flag_ok = faux
		else if (i_perceived_best_actor_index != i_perceived_main_actor_index)
			ti_flag_ok = faux
		else if ( ! ai_perceived_accessible[i_perceived_best_actor_index] )
			ti_flag_ok = faux
			
		if (ti_flag_ok)
		{
			tf_coef = MATH_FloatLimit(MATH_VecNorm(@ao_head_bones[0] OBJ_PosGet() - @o_camera OBJ_PosGet()) - 2.0, 0.0, 8.0)
			tf_coef /= 8.0
			tf_coef *= tf_coef
			tf_coef = 1.0 - tf_coef
			if (tf_coef > 0.5 && f_machoire_clap_duration > 2.0)
				f_machoire_clap_duration = -0.35

			if (tf_coef && i_SND_flag_play_growl && TIME_Elapsed(f_SND_between_growl_duration, 1.0))
			{
				i_SND_flag_play_growl = faux
				f_SND_between_growl_duration = TIME_Get()
				SND_RequestPlayOnObjCanal(Ci_SND_Growl, Anim_Canal_Tete)
			}

			f_machoire_rot_coef = MATH_FloatBlend(f_machoire_rot_coef, tf_coef, 10.0 * TIME_GetDt())
			if (f_machoire_clap_duration < 0.0)
				f_machoire_rot_coef *= f_machoire_clap_duration / -0.35

			if (tf_coef)
			{
				i_flag_bite_ok = faux
				i_flag_bite = vrai
			}
		}
		else
		{
			i_SND_flag_play_growl = vrai
			f_machoire_rot_coef -= MATH_FloatMin(f_machoire_rot_coef, 4.0 * TIME_GetDt())
		}
	
		@to_machoire OBJ_RotateLocalX(f_machoire_rot_coef * 1.2)
		
		break
	
	case C_ID_Raptor :

		ti_flag_ok = vrai
		if (i_etat_courant != ETAT_FIGHT)
			ti_flag_ok = faux
		else if (i_perceived_best_actor_index == -1)	
			ti_flag_ok = faux
		else if ( ! ai_perceived_accessible[i_perceived_best_actor_index])
			ti_flag_ok = faux
		else if (ACT_PartialActionGet() != -1)
			ti_flag_ok = faux
		else
		{
			switch(ACT_ActionGet())
			{
				case Action_Normal_Marche :
				case Action_Normal_Marche_Rapide :
				case Action_Normal_Trot :
				case Action_Normal_Course :
				case Action_Stop :
				case Action_Stop_tr_att :
				case Action_Stop_Rapide :
				case Action_Stop_Rapide_tr_att :
					break

				default:
					ti_flag_ok = faux
			}
		}
				
		if (ti_flag_ok)
		{
			tf_coef = MATH_FloatLimit(af_perceived_dist[i_perceived_best_actor_index] - 4.0, 0.0, 4.0)
			tf_coef /= 4.0
			tf_coef *= tf_coef
			tf_coef = 1.0 - tf_coef

			f_machoire_rot_coef = MATH_FloatBlend(f_machoire_rot_coef, tf_coef, 10.0 * TIME_GetDt())
		}
		else
		{
			f_machoire_rot_coef -= MATH_FloatMin(f_machoire_rot_coef, 4.0 * TIME_GetDt())
		}

		@to_machoire OBJ_RotateLocalX(f_machoire_rot_coef * 0.8)
		
		break
}

if (i_flag_zde_fight_enable)
{
	if (MSG_GlobalIsValid(mid_best_interet))
	{
		to_target = EVENT_InteretTargetGet(mid_best_interet)
	
		if (to_target)
		{
			COL_ColSetActivationSet(C_bit_zde_fight, none)	
	
			switch(raptor_type)
			{
				case C_ID_Tyranosaure :
					tv_temp	= @ao_head_bones[0] OBJ_PosGet()
					tv_temp += @ao_head_bones[0] OBJ_BankingGet()
					tv_temp += @ao_head_bones[0] OBJ_SightGet()
					DBG_RenderSphere(tv_temp, COL_ZoneSizeGet(C_zde_fight), 0x80008000)

					tv_temp = MATH_VecGlobalToLocal(tv_temp - OBJ_PosGet())
//					tv_temp.z -= 1.5
					COL_ZonePosSet(C_zde_fight, tv_temp / OBJ_ZoomGet())
					
					DBG_RenderSphere(COL_ZonePosGet(C_zde_fight), COL_ZoneSizeGet(C_zde_fight), 0x80000080)
					break

				case C_ID_Raptor :
					tv_temp	= v_look_head_pos
					tv_temp.z -= 0.25
					COL_ZonePosSet(C_zde_fight, tv_temp / OBJ_ZoomGet())
					break

//				case C_ID_Galiminus
//					tv_temp	= @ao_head_bones[0] OBJ_PosGet()
//					tv_temp += @ao_head_bones[0] OBJ_BankingGet() * 0.25
//					tv_temp = MATH_VecGlobalToLocal(tv_temp - OBJ_PosGet())
//					COL_ZonePosSet(C_zde_fight, tv_temp / OBJ_ZoomGet())
//					break
			}
	
			if (COL_ZDE_ZDECollide(to_target, C_zde_fight, C_zde_corps))
				i_flag_head_contact = vrai
			else
				i_flag_head_contact = faux
		}
	}
}
else
{
	i_flag_head_contact = faux
	COL_ColSetActivationSet(none, C_bit_zde_fight)	
}

PNJ_Raptor_Test_Head_Col()
		
AI_Execute("PNJ_Raptor_exec_bite")

AI_Execute("PNJ_Raptor_exec_GFX_Feet_Smoke")
AI_Execute("PNJ_Raptor_exec_GFX_Blood")

if (i_flag_dont_use_grid)
{
	switch(i_etat_courant)
	{
		case ETAT_PAF_SLIDE :
		case ETAT_PAF_FALL :
		case ETAT_PAF_FLY :
			break
		default:
			v_way_last_out_grid_pos = OBJ_PosGet()
	}
}

COL_ZonePosSet(C_zde_corps, MATH_VecGlobalToLocal(@o_ventre OBJ_PosGet() - OBJ_PosGet()) / OBJ_ZoomGet())
//COL_ZoneSizeSet(C_zde_corps, cvector(0.25, 0.25, 0.25))
//COL_ZonePosSet(C_zde_corps, MATH_VecGlobalToLocal(@ao_head_bones[0] OBJ_PosGet() - OBJ_PosGet()))

switch(raptor_type)
{
	case C_ID_Tyranosaure :	
	
		switch(ACT_ActionGet())
		{
			case Action_Cri :
			case Action_Cri_Haut :
			case Action_Rex_Cri_G :
			case Action_Rex_Cri_D :
			case Action_Fight_Avale :
			case Action_Fight_Mord_Face_tr_Avale :
			case Action_Fight_Mord_Haut_tr_Avale :
			case Action_Fight_Mord_tr_Avale :
				ti_flag_ok = vrai
				break
		
			default:
				if (f_machoire_rot_coef)
					ti_flag_ok = vrai
				else
					ti_flag_ok = faux
		}
		
		LIBGFX_BaveTRex(&GFX_Bave_ID[0], &GFX_Bave_Time[0], &GFX_Bave_Pos[0], &GXF_ave_Length[0], ti_flag_ok)	

		SPG2_AddSphere(@ao_IK_bones[Ci_IK_pied_gauche][3] OBJ_PosGet() , 4.0)
		SPG2_AddSphere(@ao_IK_bones[Ci_IK_pied_droit][3] OBJ_PosGet(), 4.0)
		
		tv_head_speed = (@ao_head_bones[0] OBJ_PosGet() - v_look_last_head_pos) / TIME_GetDt()
		ODE_Setv(0, tv_head_speed)

		ODE_Setv(1, MATH_VecGlobalToLocal((@ao_head_bones[0] OBJ_PosGet() + @ao_head_bones[0] OBJ_BankingGet()) - OBJ_PosGet()) / OBJ_ZoomGet())
//		DBG_RenderSphere(@ao_head_bones[0] OBJ_PosGet(), 1.5 * OBJ_ZoomGet(), 0x80000080)
//		DBG_RenderVector(@ao_head_bones[0] OBJ_PosGet(), tv_head_speed, color_jaune)
		
		if (ode_bassin)
		{
			@ode_bassin OBJ_PosSet(@o_ventre OBJ_PosGet())
			@ode_bassin OBJ_BankingGeneralSet(@o_ventre OBJ_BankingGet(), @o_ventre OBJ_SightGet())
		}	

		break

	case C_ID_Raptor :
		SPG2_AddSphere(OBJ_PosGet(), 4.0)
		break

	case C_ID_Galiminus :
		SPG2_AddSphere(OBJ_PosGet(), 8.0 * OBJ_ZoomGet())
		break
}


if (OBJ_CapaTest(Capa_Blood))
{
	if (i_flag_can_gen_blood)
	{
		i_flag_can_gen_blood = faux
		LIBGFX_Mat_Blood(@to_machoire OBJ_PosGet() + (@to_machoire OBJ_BankingGet() * OBJ_ZoomGet()), 4.0 * OBJ_ZoomGet())
	}
	
	OBJ_CapaSet(none, Capa_Blood)
}
else
{
	i_flag_can_gen_blood = vrai
}


//v_last_pos = OBJ_PosGet()
//v_last_speed = DYN_SpeedGetVector()
v_look_last_head_pos = @ao_head_bones[0] OBJ_PosGet()

#ifdef SHOW_RASTER
DBG_StopRaster(0)
DBG_StopRaster(9)
#endif

//@get_camera OBJ_FlagInactiveSet(vrai)
//tv_temp = @o_ventre OBJ_PosGet()
//tv_temp -= @o_ventre OBJ_BankingGet() * 6.0
//tv_temp.z += 4.0
//@get_camera OBJ_PosSet(tv_temp)
//tv_temp =  @o_ventre OBJ_PosGet() - @get_camera OBJ_PosGet()
////tv_temp = MATH_VecBlendRotate(@get_camera OBJ_SightGet(), tv_temp, 6.0 * TIME_GetDt())
//@get_camera OBJ_SightGeneralSet(tv_temp, Cv_VerticalVector)
//@get_camera VIEW_AssignObject(0)