#include "PNJ_Raptor_defines.var"

#define ALLOW_TERRASSE								1
#define ALLOW_BITE										1

int			ti_index
int			ti_hiding_place_index
int			ti_action

vector	tv_pos
vector	tv_me_to_cache
vector	tv_new_sight

object	to_hiding_place_nearest_wp
object	to_hiding_place
object	to_left_wp
object	to_right_wp
object	to_near_wp
object	to_far_wp


// SORTIE ETAT ===================================================================
if (i_sort_etat)
{
	i_sort_etat = faux

	if (o_cache_best_wp)
	{
		if (@o_cache_best_wp OBJ_CapaTest(OBJ_Capa_0))
			@o_cache_best_wp OBJ_CapaSet(none, OBJ_Capa_0)

		o_cache_best_wp = nobody
	}

//	i_flag_cri = vrai

	return
}

// INITIALISATION ETAT ==============================================================
if (i_etat_courant != ETAT_RODE)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_RODE

	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}

	fct_last_etat = AI_TrackCurGet()
	fct_main_etat = AI_TrackCurGet()

	i_attaque_phase = 0

	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE =======================================================================================================
if (raptor_category != Ci_Raptor_Heavy)
	f_rode_duration += TIME_GetDt()

AI_Execute("PNJ_Raptor_exec_check_msg")

AI_Execute("PNJ_Raptor_exec_check_vision")

AI_Execute("PNJ_Raptor_exec_check_sound")

i_flag_zde_fight_enable = vrai
AI_Execute("PNJ_Raptor_exec_check_collision")

AI_Execute("PNJ_Raptor_exec_check_paf")
if (i_flag_paf_fly)
	macro_change_etat("PNJ_Raptor_ETAT_PAF_FLY")
if (i_flag_paf_fall)
	macro_change_etat("PNJ_Raptor_ETAT_PAF_FALL")
if (i_flag_paf_repousse || i_flag_paf_slide || !f_lifecur)
	macro_change_etat("PNJ_Raptor_ETAT_PAF_SLIDE")

if (i_flag_force_fuite)
	macro_change_etat("PNJ_Raptor_ETAT_VALA")
if (! i_flag_in_my_territory)
	macro_change_etat("PNJ_Raptor_ETAT_VALA")

AI_Execute("PNJ_Raptor_exec_check_shoot")

AI_Execute("PNJ_Raptor_exec_check_client")

AI_Execute("PNJ_Raptor_exec_update_best_interest")

AI_Execute("PNJ_Raptor_exec_check_requin")

if (! MSG_GlobalIsValid(mid_best_interet) )
	macro_change_etat("PNJ_Raptor_ETAT_ATTENTE")

if (! (ai_perceived_status[i_perceived_best_actor_index] & Ci_PERCEIVED_ALREADY_CHECKED ) )
	macro_change_etat("PNJ_Raptor_ETAT_FIGHT")

if (ai_perceived_status[i_perceived_best_actor_index] & Ci_PERCEIVED_IN_HIDING_PLACE)
	macro_change_etat("PNJ_Raptor_ETAT_ATTAQUE_CACHE")

if (f_rode_duration > f_rode_duration_limit)
	macro_change_etat("PNJ_Raptor_ETAT_ATTENTE")

// COMPORTEMENT ==================================================================================================	
EVENT_InteretSeenTimeSet(mid_best_interet, TIME_Get())

i_flag_look_best_interet = vrai

i_way_computation_mode = Ci_WAY_MODE_RODE
AI_Execute("PNJ_Raptor_exec_way_find_dest_pos")

AI_Execute("PNJ_Raptor_exec_way_move")

i_flag_run = faux

AI_Execute("PNJ_Raptor_exec_select_action")
