#include "PNJ_Worm_defines.var"

int					ti_rank
int					ti_paf_event_nb
int					ti_index
int					ti_best_interet_paf_index
int					ti_flag_target_accessible
int					ti_territory_ID
int					ti_perceived_status
int					ti_flag_visual_paf
int					ti_flag_head_shot

float				tf_interet
float				tf_interet_reel
float				tf_puissance

vector			tv_bras_de_levier
vector			tv_speed

object			EVT_Pere
object			EVT_Target
object			to_bone

message		tm_msg_filter

messageid		tmid_paf_event
messageid		tmid_vision_event
messageid		tmid_invalid_event

if (i_flag_paf_check_done)
	return

i_flag_paf_check_done = vrai

o_paf_actor = nobody

MSG_GlobalSetInvalid(tmid_invalid_event)

MSG_SetNull(tm_msg_filter)
tm_msg_filter.msg_gao1 = OBJ_Me()
ti_rank = -1

i_flag_paf_important = faux
i_flag_paf_moyen = faux
i_flag_paf_faible = faux

for (	tmid_paf_event = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tm_msg_filter);
		MSG_GlobalIsValid(tmid_paf_event);
		tmid_paf_event = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tm_msg_filter)	)
{

	i_paf_type = EVENT_PafTypeGet(tmid_paf_event)
	tf_puissance = EVENT_PafPuisGet(tmid_paf_event)

	EVT_Pere = EVENT_PereGet(tmid_paf_event)
//	i_paf_canal = EVENT_PafCanalGet(tmid_paf_event)
//
	tmid_vision_event = EVENT_FindEventPereTarget(C_EVENT_TYPE_Visibility, EVT_Pere, nobody)
	
//	if (!MSG_GlobalIsValid(tmid_vision_event))
//		DBG_Error("Je suis pafé par quelqu'un qui n'existe pas !!!")

	v_paf_dir = EVENT_PafDirGet(tmid_paf_event)

//	ti_index = ARR_ObjSearch(&ao_paf_sender[0], i_paf_sender_nb, EVT_Pere)
//	if (ti_index == -1)
//	{
//		ti_index = i_paf_sender_nb
//		i_paf_sender_nb++
//		ao_paf_sender[ti_index] = EVT_Pere
//	}
//
//	af_paf_sender_dommage[ti_index] += tf_puissance
//
//	f_paf_jauge	+= tf_puissance

	// POINTS DE VIE
	f_lifecur -= MATH_FloatMin(f_lifecur, tf_puissance)

	if (tf_puissance >= 25.0)
	{
		i_flag_paf_important = vrai
		tv_speed = v_paf_dir * 20.0
	}
	else if (tf_puissance >= 5.0)
	{
		i_flag_paf_moyen = vrai
		tv_speed = v_paf_dir * 10.0
	}
	else
	{
		i_flag_paf_faible = vrai
		tv_speed = v_paf_dir * 3.0
	}
	
	o_paf_actor = EVT_Pere
//	f_delay_since_last_paf = 0.0

	tv_speed += DYN_SpeedGetVector()
	DYN_SpeedSetVector(tv_speed)

	if (f_lifecur)
	{
		// ON AJOUTE CE PERSO A LA LISTE DES PERSOS PERCUS
		ti_perceived_status = Ci_PERCEIVED_PAF
		
		if (i_paf_type & C_PAF_KK_Javelin)
			ti_perceived_status = Ci_PERCEIVED_JAVELIN_PAF

		ti_index = PNJ_Worm_Add_Perceived_Actor(EVT_Pere, ti_perceived_status, tmid_vision_event)
	
	}
}

//i_flag_paf_important = faux
//i_flag_paf_moyen = faux
//f_lifecur = f_life

