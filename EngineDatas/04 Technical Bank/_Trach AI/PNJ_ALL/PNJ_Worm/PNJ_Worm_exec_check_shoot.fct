#include "PNJ_Worm_defines.var"

int			ti_i
int			ti_rank
int			ti_index

float		tf_dist
float		tf_dot_product
float		tf_near_dist

vector	tv_start_pos
vector	tv_end_pos
vector	tv_shoot_dir
vector	tv_nearest_pos
vector	tv_me_to_nearest_pos

object	EVT_Pere
object			to_lance

messageid		tmid_shoot_event
messageid		tmid_invalid_event

#define	Cf_sound_detection_dist			15.0

if (i_flag_shoot_check_done)
	return

i_flag_shoot_check_done = vrai

MSG_GlobalSetInvalid(tmid_invalid_event)

tf_near_dist = 9.0

ti_rank = -1
for (	tmid_shoot_event = MSG_GlobalScan(C_EVENT_TYPE_Shoot, &ti_rank); 
		MSG_GlobalIsValid(tmid_shoot_event);
		tmid_shoot_event = MSG_GlobalScan(C_EVENT_TYPE_Shoot, &ti_rank)	)
{
	tv_start_pos = EVENT_ShootStartPosGet(tmid_shoot_event)
	tv_end_pos = EVENT_ShootEndPosGet(tmid_shoot_event)
	
	tv_shoot_dir = tv_end_pos
	tv_shoot_dir -= tv_start_pos

	if (MATH_VecDotProduct(tv_shoot_dir, OBJ_PosGet() - tv_start_pos) > 0.0)
	{
		// Le tir va vers moi, est-ce qu'il est passé près de moi ?
		tf_dist = MATH_VecNorm(tv_shoot_dir)
		
		if (tf_dist)
		{
			tv_shoot_dir /= tf_dist
			
			tf_dot_product = MATH_VecDotProduct(OBJ_PosGet() - tv_start_pos, tv_shoot_dir)
	
			tv_nearest_pos = MATH_FloatMin(tf_dist, tf_dot_product) * tv_shoot_dir
			tv_nearest_pos += tv_start_pos
			
			tv_me_to_nearest_pos	= tv_nearest_pos
			tv_me_to_nearest_pos -= OBJ_PosGet()
		
			tf_dist = MATH_VecDotProduct(tv_me_to_nearest_pos, tv_me_to_nearest_pos)
			if (tf_dist < tf_near_dist)
			{
//				DBG_RenderVector(tv_start_pos, tv_nearest_pos - tv_start_pos, color_rouge)	

				// Le tir est passé à moins de 5 m de moi...
				EVT_Pere = EVENT_PereGet(tmid_shoot_event)				
				ti_index = PNJ_Worm_Add_Perceived_Actor(EVT_Pere, Ci_PERCEIVED_NEAR_SHOT, tmid_invalid_event)
				
				i_flag_dodge_shot_jump = vrai

				v_jump_dest_pos = MATH_VecDotProduct(OBJ_PosGet() - tv_start_pos, tv_shoot_dir) * tv_shoot_dir
				v_jump_dest_pos += tv_start_pos
				v_jump_dest_pos -= OBJ_PosGet()
				v_jump_dest_pos.z = 0.0
				MATH_VecSetNormalize(v_jump_dest_pos)
				v_jump_dest_pos *= MATH_RandFloat(-2.0, -1.0)
				v_jump_dest_pos += OBJ_PosGet()
				
				break
			}
//			else
//			{
//				DBG_RenderVector(tv_start_pos, tv_nearest_pos - tv_start_pos, color_vert)	
//
//				// Le tir est passé à plus de 5 m de moi...
//				EVT_Pere = EVENT_PereGet(tmid_shoot_event)				
//			}
		}
	}
}

//// ON VA AUSSI REGARDER LES LANCES
//for (ti_i = 0; ti_i < Ci_bambou_maxinmap; ti_i++)
//{
//	to_lance = 	@get_global ao_Lances[ti_i]
//
//	if (to_lance && @"Projectiles/Projectile_Javelin" to_lance mi_State == Ci_bambou_state_launch)
//	{
//		tv_me_to_nearest_pos = @to_lance OBJ_PosGet()
//		tv_me_to_nearest_pos -= OBJ_PosGet()
//		
//		if (MATH_VecDotProduct(tv_me_to_nearest_pos, tv_me_to_nearest_pos) < tf_near_dist)
//		{
//			ti_index = PNJ_Raptor_Add_Perceived_Actor(to_lance, Ci_PERCEIVED_NEAR_SHOT, tmid_invalid_event)
//			ai_perceived_seen[ti_index] = vrai
//		}
//	}
//}

