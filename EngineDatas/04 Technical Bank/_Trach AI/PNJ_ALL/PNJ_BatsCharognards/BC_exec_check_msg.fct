#include "BC_defines.var"

int					ti_i
int					num_msg

message		tm_message
message		m_cine


// CINE
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

if(i_CineStack && am_CineStack[0].msg_id == CINE_ResetWaitDefault)
	OBJ_CapaSet(CAPA_CINE_Annulee, 0)
	
// Capa13 = action courant terminée, on passe a la suivante
if(i_CineStack && (i_cine_close || OBJ_CapaTest(CAPA_CINE_Annulee)))
{
l_loop:
	i_CineStackChanged = vrai
  	for(ti_i = 0; ti_i < i_CineStack - 1; ti_i++)  am_CineStack[ti_i] = am_CineStack[ti_i + 1]
	
  	i_CineStack--
  	if(!i_CineStack) 
  	{
		OBJ_CapaSet(CAPA_CINE_Terminee, 0)
	  	if(i_CineWaitDefault)
	  	{
		  	am_CineStack[0] = m_CineWaitDefault
		  	i_CineStack = 1
		}
		else
		{
			if( BC_IsEtatCine(i_etat_courant) )
				AI_Execute("BC_exec_init_attente")
		}
	}
	else
	{
		m_cine = am_CineStack[0]
		if(m_cine.msg_id == CINE_ResetWaitDefault)
		{
			i_CineWaitDefault = faux
			goto l_loop
		}		
	}
	 
	 i_cine_close = faux
}

// On empile les commandes
ti_i = 0
num_msg = MSG_GetCount()
while(num_msg)
{
	tm_message = MSG_Read(ti_i)
	if(tm_message.msg_id > 100000)
	{
		if(tm_message.msg_id == CINE_Reset)
		{
			i_CineStack = 0
			MSG_Clear()			
			OBJ_CapaSet(0, CAPA_CINE_Terminee)
			if(BC_IsEtatCine(i_etat_courant))
				AI_Execute("BC_exec_init_attente")
			break
		}
		else
		{
			if(i_CineStack == 0) 
			{
				OBJ_CapaSet(0, CAPA_CINE_Terminee)
				i_CineStackChanged = vrai
			}
			
			if(i_CineStack == 1 && am_CineStack[0].msg_id == CINE_WaitDefault ) OBJ_CapaSet(0, CAPA_CINE_Terminee)
			if(i_CineStack == 20) DBG_Error("Trop de messages cines humains")
			am_CineStack[i_CineStack] = tm_message
			i_CineStack++
		}
	}
	
	ti_i++
	num_msg--
}

OBJ_CapaSet(0, CAPA_CINE_Annulee)
MSG_Clear()

// On execute la premiere
if(i_CineStack && i_CineStackChanged)
{
	if( ! BC_IsEtatCine(i_etat_courant) )
		SND_RequestPlay(Ci_SND_Cri_Attack_Loin)			// je crie pour annoncer que je vais attaquer
	
	i_CineStackChanged = faux
	m_cine = am_CineStack[0]
	switch(m_cine.msg_id)
	{
		case CINE_Wait :
			#ifndef _FINAL_
			if(@get_global DEBUG_SCRIPT)
			{
				DBG_TraceString("######## ")
				DBG_TraceObject(OBJ_Me())
				DBG_TraceString(" passe en WAIT\n")
			}
			#endif
			macro_change_etat("BC_ETAT_CINE_Wait")
			break

		case CINE_Vala :
			#ifndef _FINAL_
			if(@get_global DEBUG_SCRIPT)
			{
				DBG_TraceString("######## ")
				DBG_TraceObject(OBJ_Me())
				DBG_TraceString(" passe en VALA\n")
			}
			#endif
			macro_change_etat("BC_ETAT_CINE_Vala")
			break

		case CINE_Fight :
			#ifndef _FINAL_
			if(@get_global DEBUG_SCRIPT)
			{
				DBG_TraceString("######## ")
				DBG_TraceObject(OBJ_Me())
				DBG_TraceString(" passe en ATTAQUE\n")
			}
			#endif
			macro_change_etat("BC_ETAT_CINE_Attaque")
			break
			
		case CINE_ForceEtat :
			#ifndef _FINAL_
			if(@get_global DEBUG_SCRIPT)
			{
				DBG_TraceString("######## ")
				DBG_TraceObject(OBJ_Me())
				DBG_TraceString(" force un état\n")
			}
			#endif
			macro_change_etat("BC_ETAT_CINE_Force_Etat")
			break
		
		case CINE_WaitDefault :
			i_CineWaitDefault = vrai
			m_CineWaitDefault = m_cine
			if (i_CineStack == 1)
				OBJ_CapaSet(CAPA_CINE_Terminee, 0)
			#ifndef _FINAL_
			if(@get_global DEBUG_SCRIPT)
			{
				DBG_TraceString("######## ")
				DBG_TraceObject(OBJ_Me())
				DBG_TraceString(" passe en WAIT DEFAULT\n")
			}
			#endif
			macro_change_etat("BC_ETAT_CINE_Wait_Default")
			break
	}
}

