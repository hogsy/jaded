#include "GFX_Smoke_Defines.var"

int i_Index
message m_Msg
message m_MsgReturn
color c_temp 

mf_TimeRunning += TIME_GetDt()

if ( mi_UseStartDelay && mf_StartDelay > mf_TimeRunning )
{
	return
}
else
{
	mi_GFX_Key = GFX_Add( 6 )
	
	// get the number of dynamic materials
	mi_NumberOfDynamicMaterials = 0
	
	for ( i_Index = 0; i_Index < C_Max_Dynamic_Materials; i_Index++ )
	{
		if ( mi_DynamicMaterialIndex[i_Index] > -1 )
		{
			mi_NumberOfDynamicMaterials++
		}
	}
	
	if ( mi_GFX_Key == C_Invalid_GFX )
	{
		DBG_Error( "GFX_Smoke AI failed to add a GFX item." )
		
		GFX_Del( mi_GFX_Key )
	}
	else
	{
		GFX_FlagSet( mi_GFX_Key, 0, 1 )
		GFX_FlagSet( mi_GFX_Key, 2, mi_MatOpacity )
	
		GFX_MaterialSet( mi_GFX_Key, mo_Material, mi_MaterialIndex )
		
		GFX_Seti( mi_GFX_Key, 6100, mi_MaxNumberOfSprites )
	
		GFX_Setf( mi_GFX_Key, 6000, mf_LifeSpan )
	    GFX_Setf( mi_GFX_Key, 6001, mf_Friction )
		GFX_Setf( mi_GFX_Key, 6002, mf_SmokeStartSize )
	    GFX_Setf( mi_GFX_Key, 6003, mf_SmokeEndSize )
	    
	   	//========================================================
		if(o_GFX_Ambiant_Controller)
		{
			m_Msg.msg_sender = OBJ_Me()
			m_Msg.msg_int1 = COLOR_GetR(mc_StartColour )
			m_Msg.msg_int2 = COLOR_GetG(mc_StartColour )
			m_Msg.msg_int3 = COLOR_GetB(mc_StartColour )
			m_Msg.msg_int4 = COLOR_GetA(mc_StartColour ) 
			m_MsgReturn = Dispatch_Interaction(o_GFX_Ambiant_Controller, m_Msg)
			c_temp = COLOR_SetRGBA(m_MsgReturn.msg_int1,m_MsgReturn.msg_int2,m_MsgReturn.msg_int3,m_MsgReturn.msg_int4) 
		}
		else
			c_temp  = 	mc_StartColour 
		//========================================================
		GFX_Seti( mi_GFX_Key, 6101, c_temp )
		
		//========================================================
		if(o_GFX_Ambiant_Controller)
		{
			m_Msg.msg_sender = OBJ_Me()
			m_Msg.msg_int1 = COLOR_GetR(mc_EndColour )
			m_Msg.msg_int2 = COLOR_GetG(mc_EndColour )
			m_Msg.msg_int3 = COLOR_GetB(mc_EndColour )
			m_Msg.msg_int4 = COLOR_GetA(mc_EndColour ) 
			m_MsgReturn = Dispatch_Interaction(o_GFX_Ambiant_Controller, m_Msg)
			c_temp = COLOR_SetRGBA(m_MsgReturn.msg_int1,m_MsgReturn.msg_int2,m_MsgReturn.msg_int3,m_MsgReturn.msg_int4) 
		}
		else
			c_temp  = 	mc_EndColour
		//========================================================
		GFX_Seti( mi_GFX_Key, 6102, c_temp )
	
		mf_StartTime = TIME_Get()
	
		AI_TrackCurChange( "GFX_Smoke_BhvRun.fct" )
	}
}