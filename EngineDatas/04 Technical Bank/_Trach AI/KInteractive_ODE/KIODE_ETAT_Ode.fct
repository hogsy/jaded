#include "KIODE_defines.var"

int			ti_index

float		tf_time
float		tf_norm

vector	tv_pos
vector	tv_speed

object	to_serveur

// SORTIE ETAT =============================================================================
if (i_sort_etat)
{
	i_sort_etat = faux
	OBJ_CapaSet(none, Capa_Epave)
	OBJ_FlagsControlSet(none, OBJ_C_ControlFlag_RayInsensitive)
	return
}

// INITIALISATION ETAT ========================================================================
if (i_etat_courant != ETAT_Ode)
{
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Ode

	if (fct_last_etat)
	{
		i_sort_etat = vrai
		AI_Execute(fct_last_etat)
	}

	fct_last_etat = AI_TrackCurGet()
	fct_main_etat = fct_last_etat

	OBJ_CapaSet(Capa_Epave, none)
	OBJ_FlagsControlSet(OBJ_C_ControlFlag_RayInsensitive, none)

//	to_serveur = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_grabbed_by_Kong_LNK_ID, i_flag_grab_allowed, nofunc, nofunc)
//	if (to_serveur)
//	{
//		o_ode_target = LNK_GrabKong_LanceObjectGet( mid_grabbed_by_Kong_LNK_ID)
//		if ( o_ode_target )
//		{
//			ti_index = LNK_GrabKong_LanceTargetGet( mid_grabbed_by_Kong_LNK_ID)
//			v_wanted_pos = @get_global v_KongFight_TargetAddPos[ti_index]
//			if ( MATH_VecNullEpsilon(v_wanted_pos))
//				v_wanted_pos = @o_ode_target OBJ_PosGet()
//		}
//		else
//		{
//			v_wanted_pos = @o_grabbed_actor_KK OBJ_PosGet()
//			v_wanted_pos += LNK_GrabKong_LanceVectorGet( mid_grabbed_by_Kong_LNK_ID) * 70.0
//			v_wanted_pos += cvector( 0.0, 0.0, 5.0)
//		}
//		
//		v_wanted_speed = MATH_LIB_PHY_Impulsion_Get(OBJ_PosGet(), v_wanted_pos, cvector(0.0, 0.0, -30.0), 70.0, tf_time)
//
//		ODE_Enable(vrai)
//		ODE_Setv( 0, v_wanted_speed) // Moment linéaire (la vitesse)
//	}
//	else if (i_dernier_etat == ETAT_Grabbed)
//	{
//		v_wanted_speed = @o_grabbed_actor_KK DYN_SpeedGetVector()
//		ODE_Setv( 0, v_wanted_speed)
//	}

	ODE_Setv(3, Cv_NullVector) // Moment angulaire

//	i_flag_grab_allowed = faux
//	o_grabbed_actor_KK = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_grabbed_by_Kong_LNK_ID, i_flag_grab_allowed, nofunc, nofunc)
//
//	i_flag_grab_allowed = vrai

	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE ===============================================================================
//o_grabbed_actor_KK = LNK_ServeurGet(Ci_LNK_GRAB_KONG, mid_grabbed_by_Kong_LNK_ID, vrai, nofunc, nofunc)
//if (o_grabbed_actor_KK)
//	macro_change_etat("KIODE_ETAT_Grabbed")

AI_Execute("KIODE_exec_check_paf")

tv_speed = ODE_Getv(3)
tf_norm = MATH_VecSquareNorm(tv_speed)
if (tf_norm > 40000.0)
{
	tf_norm = MATH_FloatSqrt(tf_norm)
	tv_speed /= tf_norm * 200.0
	ODE_Setv(3, tv_speed)
}

if (ODE_Pause(-1) && OBJ_FlagsStatusGet() & OBJ_C_StatusFlag_Culled)
	OBJ_Destroy()

KIODE_GFX_Light()