Include_UltraProcedure_Header
#include "WS_defines.var"

int		ti_string
int		ti_nb
int		ti_i
vector	tv_pos
object	to_dup_lum
vector	tv_banking


// SORTIE D'ETAT ==========================================================
if( i_etat_sortie )
{
	i_etat_sortie = faux
	return
}

// ENTREE D'ETAT ==========================================================
if( i_etat_courant != ETAT_MEDAILLON )
{
	i_etat_ancien = i_etat_courant
	i_etat_courant = ETAT_MEDAILLON
	if( fct_etat_last_track )
	{
		i_etat_sortie = vrai
		AI_Execute(fct_etat_last_track)
	}
	fct_etat_last_track = AI_TrackCurGet()
	f_etat_duree = 0.0
	
	WOR_Pause(0, 0xFFFFFFFF)
	GRP_FlagInvisibleSet(faux)
	@get_global Proc_CameraSet(o_camera)
	
	// Position du Medaillon
	tv_pos = @get_Kamera OBJ_PosGet()
	tv_pos += (4.0 * @get_Kamera OBJ_SightGet())
	@o_medaillon OBJ_PosSet(tv_pos)
	tv_banking = MATH_VecCrossProduct(@get_Kamera OBJ_SightGet(), Cv_VerticalVector)
	DBG_RenderVector(tv_pos, tv_banking, color_bleu)
	tv_banking = MATH_VecCrossProduct(tv_banking, @get_Kamera OBJ_SightGet())
	DBG_RenderVector(tv_pos, tv_banking, color_rouge)
	@o_medaillon OBJ_BankingGeneralSet( - @get_Kamera OBJ_SightGet(), tv_banking)
	
	// Génération des LUMS
	for(ti_i = 0; ti_i < @get_global i_lums_absorbes; ti_i++ )
	{
		tv_pos = @get_Kamera  OBJ_PosGet() // OBJ_PosGet()
		switch( ti_i )
		{
			case 0 :
				tv_pos += @get_Kamera OBJ_HorizonGet() + @get_Kamera OBJ_BankingGet()
				break
			case 1 :
				tv_pos += @get_Kamera OBJ_HorizonGet() - @get_Kamera OBJ_BankingGet()
				break
			case 2 :
				tv_pos -= @get_Kamera OBJ_HorizonGet() + @get_Kamera OBJ_BankingGet()
				break
			case 3 :
				tv_pos -= @get_Kamera OBJ_HorizonGet() - @get_Kamera OBJ_BankingGet()
				break
		}
		to_dup_lum = Proc_RM_GenerateLums(1, tv_pos)
		ao_dup_lums[i_dup_lums_nb] = to_dup_lum
		i_dup_lums_nb++
	}
	
	// Placement dans le médaillon
	for(ti_i = 0; ti_i < i_dup_lums_nb; ti_i++ )
	{
		to_dup_lum = ao_dup_lums[ti_i]
		tv_pos = GST_WearShop_MedaillonLumsPosGet(ti_i)
		@to_dup_lum Proc_LUMS_MedaillonSet(o_medaillon, tv_pos)
		
		// re-positionnement dans le médaillon (sauf pour le nouveau lums)
		if( ti_i < (i_dup_lums_nb - @get_global i_lums_absorbes) )
		{
			@to_dup_lum OBJ_PosSet(tv_pos)
			@to_dup_lum OBJ_BankingGeneralSet(@o_medaillon OBJ_SightGet(), @o_medaillon OBJ_BankingGet())
		}
	}
	
	// display all
	GST_WearShop_MedaillonDisplay(vrai)
}
else
{
	f_etat_duree += TIME_GetDt()
}

// ANALYSE ===============================================================
if( ! @get_global i_wearshop_active_flag )
	AI_TrackCurChangeNow("WS_ETAT_INACTIF")

// COMPORTEMENT =========================================================

//@get_rayman OBJ_FlagInvisibleSet(vrai)

@o_rayman OBJ_FlagInactiveSet(vrai)
@o_rayman OBJ_FlagInvisibleSet(vrai)

//ti_string = STR_CreateText("\cFF\\h0.15\Medaillon ( ", cvector(0.25,0.05,0), 0)
////STR_AppendInt(ti_string, MATH_Modulo(Proc_RM_Lums_NbGet(), Nb_LUMS_for_Costume_Item))
//STR_AppendInt(ti_string, i_dup_lums_nb)
//STR_AppendText(ti_string, " ) ")

if( @ao_dup_lums[i_dup_lums_nb-1] OBJ_CapaTest(OBJ_Capa_15) )
{
	// FIN DE LA CINE DU LUM QUI SE PLACE
//	@o_dup_lum OBJ_Destroy()
	
//	ti_nb = Proc_RM_Lums_NbGet()
//	if( ! MATH_Modulo(ti_nb, Nb_LUMS_for_Costume_Item) )
	if( i_dup_lums_nb == Nb_LUMS_for_Costume_Item )		// tous les X lums
	{
		// destroy lums
		for( ti_i = 0; ti_i < i_dup_lums_nb; ti_i++ )
		{
			to_dup_lum = ao_dup_lums[ti_i]
			@to_dup_lum OBJ_Destroy()
			ao_dup_lums[ti_i] = nobody
		}
		i_dup_lums_nb = 0
		
		// check costumes pour déterminer la salle où téléporter le rayman fake
		for( ti_i = 0; ti_i < RM_Disguise_Max; ti_i++ )
		{
			if( RM_Disguise_Get(ti_i) )
				continue		// ce costume est complet
			if( RM_Disguise_ItemGet(ti_i, RM_POWER_DISGUISE_GLASSES) )
			{
				// 1 costume incomplet
				tv_pos = @o_wp_select_item OBJ_PosGet()
				@o_rayman OBJ_PosSet(tv_pos)
				@o_rayman OBJ_BankingGeneralSet(@o_wp_select_item OBJ_SightGet(),@o_wp_select_item OBJ_BankingGet())
				@o_rayman COL_StartMatrixSet(tv_pos)
				@o_camera OBJ_FlagInactiveSet(faux)
				AI_TrackCurChangeNow("WS_ETAT_WEARSHOP")
			}
		}
		// pas de costume incomplet
		tv_pos = @o_wp_select_costume OBJ_PosGet()
		@o_rayman OBJ_PosSet(tv_pos)
		@o_rayman OBJ_BankingGeneralSet(@o_wp_select_costume  OBJ_SightGet(),@o_wp_select_costume OBJ_BankingGet())
		@o_rayman COL_StartMatrixSet(tv_pos)
		@o_camera OBJ_FlagInactiveSet(faux)
		AI_TrackCurChangeNow("WS_ETAT_WEARSHOP")
	}
	else
	{
		@get_global i_wearshop_active_flag = faux
	}
}

@o_medaillon OBJ_DrawAtEnd()
