#include "r_defines.var"

messageid		tmid_ID
message	tmsg_filter
int				ti_rank, ti_i
object		to_pere, to_gao 
int				ti_type, ti_SND, ti_nb
vector		tv_pos
vector		tv_dir
float			tf_dmg

i_paf_detect_type = 0
v_paf_detect_dir = Cv_NullVector
o_paf_detect_actor = nobody

if ( ! TIME_Elapsed( f_paf_time_last_big, Cf_Invulnerable))
	return

MSG_SetNull(tmsg_filter)
tmsg_filter.msg_gao1 = OBJ_Me()
ti_rank = -1
for (	tmid_ID = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tmsg_filter);
		MSG_GlobalIsValid(tmid_ID);
		tmid_ID = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tmsg_filter) )
{
	to_pere = EVENT_PereGet(tmid_ID)
	if( to_pere == get_rayman)
		continue
	if ( ( MOVE_MODE() == C_Move_Esquive || MOVE_MODE() == C_Move_ReceptionRoulade)
	&& ANI_CurrentFrameGet(0) < 8)
		continue
	ti_type = EVENT_PafTypeGet(tmid_ID)
	tv_pos = EVENT_PafPositionGet(tmid_ID)
	tv_dir = EVENT_PafDirGet(tmid_ID)
	tf_dmg = EVENT_PafPuisGet(tmid_ID) * PAF_Unit

	if ( ti_type & C_PAF_RM_Faible)
	{
		Proc_Vec_HorzNormalise( tv_dir, OBJ_SightGet())
		DYN_SpeedSetVector( DYN_SpeedGetVector() + (tv_dir * 1.5))
		continue
	}
	

	if( i_etat_courant == ETAT_RM_paf )
		f_paf_jauge += tf_dmg
	else
		f_paf_jauge =0.0
	if( f_paf_jauge >= 20.0 )
	{
		i_paf_detect_type |= C_PAF_RM_Fort
		f_paf_jauge = 0.0
	}
		
	o_paf_detect_actor = to_pere
	i_paf_detect_type |= ti_type
	v_paf_detect_dir += tv_dir
	
//	Proc_RM_LifeManaSet( Proc_RM_LifeGet() - tf_dmg, Proc_RM_ManaGet())
	
	if ( Proc_RM_LifeGet() <= 0.0)
		ti_nb = 8
	else
		ti_nb = 2
		
	for ( ti_i = 0; ti_i < ti_nb; ti_i++)
	{
		tv_dir = MATH_VecRotate( -v_paf_detect_dir , Cv_VerticalVector, MATH_RandFloat( -Cf_PiBy2, Cf_PiBy2))
		tv_dir += cvector( 0.0, 0.0, MATH_RandFloat( 0.5 , 1.0))
		tv_dir *= MATH_RandFloat( 9.0, 12.0)
		to_gao = Proc_RM_GenerateLifeMana( ti_i, 1 - ti_i, OBJ_PosGet() + cvector( MATH_RandFloat( -1.0,1.0), MATH_RandFloat( -1.0,1.0), MATH_RandFloat( 0.0,1.0)) , tv_dir)
	}

	f_display_life = Cf_Display_Time
	i_game_ralenti = faux
}