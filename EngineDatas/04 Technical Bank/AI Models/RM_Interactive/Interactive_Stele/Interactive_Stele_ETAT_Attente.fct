#include "Interactive_Stele_defines.var"

Include_UltraProcedure_Header

object	to_main_actor
vector	tv_axis 
int			ti_ret
int			ti_monture 


if (i_flag_sortie_etat)
{
	i_flag_sortie_etat = faux
	return
}

if (i_etat_courant != ETAT_Attente)
{
	// INTIALISATION
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Attente
	
	if (fct_last_etat)
	{
		i_flag_sortie_etat = vrai
		AI_Execute(fct_last_etat)
	}
	
	fct_last_etat = AI_TrackCurGet()
	
	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

// ANALYSE ===============================================================

//i_SF_MonturesValides = 1<<C_ID_Monture_Bat // -1 // Test

DBG_RenderCircle(OBJ_PosGet(),7.0,Cv_VerticalVector, color_rose)
if (OBJ_SqrDist(get_rayman) <= 7.0 * 7.0)
{
	ti_monture = @get_rayman PROC_RM_MontureIDGet()
	if (ti_monture != C_ID_Rayman)
	{
		i_SF_MonturesValides |= (1 << ti_monture)
		@"univ" Float_speciaux_sauve[i_SF_MonturesValidesID] = i_SF_MonturesValides
	}
//	else
//	{
//		if (COL_BV_PivotCollide(o_main_actor) && ! @o_wp_pos COL_BV_PivotCollide(o_creature) )
//		macro_change_etat("Interactive_Stele_ETAT_Apparition")
//	}
}


tv_axis = -OBJ_SightGet() * 5.0
if (i_SF_MonturesValides & (1<<C_ID_Monture_PoissonLumiere))
{
	if (Proc_IS_DisplayMonturePos( OBJ_PosGet() + tv_axis, "PoissonLum", @"univ" ao_AllHumains[C_ID_Monture_PoissonLumiere] ) )
		AI_TrackCurChangeNow("Interactive_Stele_ETAT_Apparition")
}
	

tv_axis = MATH_VecRotate(tv_axis, Cv_VerticalVector, Cf_PiBy4)
if (i_SF_MonturesValides & (1<<C_ID_Monture_Requin))
{
	if (Proc_IS_DisplayMonturePos( OBJ_PosGet() + tv_axis, "Requin", @"univ" ao_AllHumains[C_ID_Monture_Requin] ))
		AI_TrackCurChangeNow("Interactive_Stele_ETAT_Apparition")
}

tv_axis = MATH_VecRotate(tv_axis, Cv_VerticalVector, Cf_PiBy4)
if (i_SF_MonturesValides & (1<<C_ID_Monture_Aigle))
{
	if (Proc_IS_DisplayMonturePos( OBJ_PosGet() + tv_axis, "Aigle", @"univ" ao_AllHumains[C_ID_Monture_Aigle]))
		AI_TrackCurChangeNow("Interactive_Stele_ETAT_Apparition")
}

tv_axis = MATH_VecRotate(tv_axis, Cv_VerticalVector, Cf_PiBy4)
if (i_SF_MonturesValides & (1<<C_ID_Monture_Araignee))
{
	if (Proc_IS_DisplayMonturePos( OBJ_PosGet() + tv_axis, "Araignée", @"univ" ao_AllHumains[C_ID_Monture_Araignee] ))
		AI_TrackCurChangeNow("Interactive_Stele_ETAT_Apparition")
}

tv_axis = MATH_VecRotate(tv_axis, Cv_VerticalVector, Cf_PiBy4)
if (i_SF_MonturesValides & (1<<C_ID_Monture_Bat))
{
	if (Proc_IS_DisplayMonturePos( OBJ_PosGet() + tv_axis, "Bat", @"univ" ao_AllHumains[C_ID_Monture_Bat] ))
		AI_TrackCurChangeNow("Interactive_Stele_ETAT_Apparition")
}

tv_axis = MATH_VecRotate(tv_axis, Cv_VerticalVector, Cf_PiBy4)
if (i_SF_MonturesValides & (1<<C_ID_Monture_Rhino))
{
	if (Proc_IS_DisplayMonturePos( OBJ_PosGet() + tv_axis, "Rhino", @"univ" ao_AllHumains[C_ID_Monture_Rhino] ))
		AI_TrackCurChangeNow("Interactive_Stele_ETAT_Apparition")
}

tv_axis = MATH_VecRotate(tv_axis, Cv_VerticalVector, Cf_PiBy4)
if (i_SF_MonturesValides & (1<<C_ID_Monture_Serpent))
{
	if (Proc_IS_DisplayMonturePos( OBJ_PosGet() + tv_axis, "Serpent", @"univ" ao_AllHumains[C_ID_Monture_Serpent] ))
		AI_TrackCurChangeNow("Interactive_Stele_ETAT_Apparition")
}
	
tv_axis = MATH_VecRotate(tv_axis, Cv_VerticalVector, Cf_PiBy4)
if (i_SF_MonturesValides & (1<<C_ID_Monture_Tigre))
{
	if (Proc_IS_DisplayMonturePos( OBJ_PosGet() + tv_axis, "Tigre", @"univ" ao_AllHumains[C_ID_Monture_Tigre] ))
		AI_TrackCurChangeNow("Interactive_Stele_ETAT_Apparition")
}





