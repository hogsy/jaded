#include "PNJ_Lapin_defines.var"

int			ti_i
int			ti_rank
int			ti_dodge
int			ti_dodge_mode
int			ti_protect
int			ti_protect_mode
int			ti_type

float		tf_dist
float		tf_dot_product
float		tf_near_dist

vector	tv_start_pos
vector	tv_end_pos
vector	tv_shoot_dir
vector	tv_nearest_pos
vector	tv_me_to_nearest_pos

object	to_lance

messageid		tmid_shoot_event


if (i_flag_shoot_check_done)
	return

i_flag_shoot_check_done = vrai

i_flag_shoot_near_of_me = faux


// DODGE ENABLED ?
ti_dodge = faux
switch( Atk_Dodge )
{
	case Ci_Atk_Dodge_All :
	case Ci_Atk_Dodge_Gun :
	case Ci_Atk_Dodge_Grenade :
		ti_dodge = vrai
		i_etat_dodge_enabled = vrai
		break
}

// PROTECT ENABLED ?
ti_protect = faux
switch( Atk_Protect )
{
	case Ci_Atk_Protect_All :
	case Ci_Atk_Protect_Gun :
	case Ci_Atk_Protect_Grenade :
		ti_protect = vrai
		i_etat_protect_enabled = vrai
		break
}


// FORCE PROTECT !!!
//if( i_etat_protect_enabled && o_external_protect_actor )
if( o_external_protect_actor )
{
	Lapin_PROTECT(o_external_protect_actor, i_external_protect_mode)
	MACRO_GO_IDLE(0)
}

// FORCE DODGE !!!
//if( i_etat_dodge_enabled && o_external_dodge_actor )
if( o_external_dodge_actor )
{
	Lapin_DODGE(o_external_dodge_actor, i_external_dodge_mode)
	MACRO_GO_IDLE(0)
}


//tf_near_dist = 5.0
//
//ti_rank = -1
//for (	tmid_shoot_event = MSG_GlobalScan(C_EVENT_TYPE_Shoot, &ti_rank); 
//		MSG_GlobalIsValid(tmid_shoot_event);
//		tmid_shoot_event = MSG_GlobalScan(C_EVENT_TYPE_Shoot, &ti_rank)	)
//{
//	tv_start_pos = EVENT_ShootStartPosGet(tmid_shoot_event)
//	tv_end_pos = EVENT_ShootEndPosGet(tmid_shoot_event)	
//	tv_shoot_dir = tv_end_pos - tv_start_pos
//	
//	if (MATH_VecDotProduct(tv_shoot_dir, OBJ_PosGet() - tv_start_pos) > 0.0)
//	{
//		// Le tir va vers moi, est-ce qu'il est passé près de moi ?
//		tf_dist = MATH_VecNorm(tv_shoot_dir)
//		if (tf_dist)
//		{
//			tv_shoot_dir /= tf_dist
//			
//			tf_dot_product = MATH_VecDotProduct(OBJ_PosGet() - tv_start_pos, tv_shoot_dir)
//	
//			tv_nearest_pos = MATH_FloatMin(tf_dist, tf_dot_product) * tv_shoot_dir
//			tv_nearest_pos += tv_start_pos
//			
//			tv_me_to_nearest_pos	= tv_nearest_pos
//			tv_me_to_nearest_pos -= OBJ_PosGet()
//		
//			tf_dist = MATH_VecDotProduct(tv_me_to_nearest_pos, tv_me_to_nearest_pos)
//			if (tf_dist < tf_near_dist)
//			{
//				DBG_RenderVector(tv_start_pos, tv_nearest_pos - tv_start_pos, color_rouge)
//				ti_dodge = faux
//				ti_dodge_mode = 0
//				ti_protect = faux
//				ti_protect_mode = 0
//				ti_type = EVENT_ShootTypeGet(tmid_shoot_event)
//				switch( ti_type )
//				{
//					// DODGE ou PROTECT vs GUN ? ------------------------------------------------------
//					case RM_WEAPON_TYPE_GUN :
//						switch( Atk_Dodge )
//						{
//							case Ci_Atk_Dodge_All :
//							case Ci_Atk_Dodge_Gun :
//								ti_dodge = vrai
//								ti_dodge_mode = Ci_Dodge_Mode_Gun
//								break
//						}
//						switch( Atk_Protect )
//						{
//							case Ci_Atk_Protect_All :
//							case Ci_Atk_Protect_Gun :
//								ti_protect = vrai
//								ti_protect_mode = Ci_Dodge_Mode_Gun
//								break
//						}
//						break
//						
//					// DODGE ou PROTECT vs GRENADE ? ------------------------------------------------------
//					case RM_WEAPON_TYPE_GRENADE :
//						switch( Atk_Dodge )
//						{
//							case Ci_Atk_Dodge_All :
//							case Ci_Atk_Dodge_Grenade :
//								ti_dodge = vrai
//								ti_dodge_mode = Ci_Dodge_Mode_Grenade
//								break
//						}
//						switch( Atk_Protect )
//						{
//							case Ci_Atk_Protect_All :
//							case Ci_Atk_Protect_Grenade :
//								ti_protect = vrai
//								ti_protect_mode = Ci_Dodge_Mode_Grenade
//								break
//						}					
//						break
//				}
//				
//				// OK dodge ou protect -----------------------------------------------------------
//				if( ti_dodge || ti_protect )
//				{
//					i_flag_shoot_near_of_me = vrai
//					o_flag_shoot_near_of_actor = EVENT_PereGet(tmid_shoot_event)
//					
//					if( ti_protect )
//						Lapin_PROTECT(o_flag_shoot_near_of_actor, ti_protect_mode)
//					else
//						Lapin_DODGE(o_flag_shoot_near_of_actor, ti_dodge_mode)
//					MACRO_GO_IDLE(0)
//				}
//			}
//		}
//	}
//}
//