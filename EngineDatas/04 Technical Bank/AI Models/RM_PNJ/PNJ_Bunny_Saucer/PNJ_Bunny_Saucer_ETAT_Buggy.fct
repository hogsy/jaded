#include "PNJ_Bunny_Saucer_defines.var"

Include_UltraProcedure_Header

int				ti_i
int				ti_zde_corps_nb
int				ti_index
int				ti_flag_main
int				ti_flag_boost

float			tf_hor_speed
float			tf_speed_coef
float			tf_wanted_traction
float			tf_next_wanted_traction
float			tf_norm

object		to_head
object		tao_zde_corps_gao[20]
object		to_bullet
object		to_last_rider

vector		tv_pos
vector		tv_joy_dir
vector		tv_speed
vector		tv_traction


if (i_flag_sortie_etat)
{
	i_flag_sortie_etat = faux
	return
}


if (i_etat_courant != ETAT_Buggy)
{
	// INTIALISATION
	i_dernier_etat = i_etat_courant
	i_etat_courant = ETAT_Buggy
	
	if (fct_last_etat)
	{
		i_flag_sortie_etat = vrai
		AI_Execute(fct_last_etat)
	}
	
	fct_last_etat = AI_TrackCurGet()
	
	COL_ColSetActivationSet(C_bit_zdm_pied, none)

	COL_SwapToSpecific(C_zde_corps)
	COL_ZonePosSet(C_zde_corps, Cv_NullVector)
	COL_ZoneSizeSet(C_zde_corps, cvector(2.0, 2.0, 2.0))

	DYN_On()
	DYN_FlagsSet(DYN_C_BasicForces | DYN_C_VectorFriction | DYN_C_NeverDynamicFather | DYN_C_NeverDynamicHierarchy | DYN_C_HorizontalGrounds | DYN_C_SlipOnGroundEdge | DYN_C_ApplyRec | DYN_C_Col, none)
	DYN_GravitySet(cvector(0.0, 0.0, -40.0))

	f_time_start_etat = 0.0
}
else
{
	f_time_start_etat += TIME_GetDt()
}

//// ANALYSE ===============================================================
//o_eagle = LNK_ServeurGet(Ci_LNK_GRAB_EAGLE, mid_eagle_LNK, vrai, "PNJ_Bunny_Saucer_exec_LNK_Eagle", nofunc)
//if (o_eagle)
//	macro_change_etat("PNJ_Bunny_Saucer_ETAT_Grabbed")

if (f_burn_duration)
	o_Rided_Actor = LNK_ServeurGet(Ci_LNK_RIDE_ON_NMI, mid_Rided_LNK_ID, vrai, nofunc, nofunc)
else
	o_Rided_Actor = LNK_ServeurGet(Ci_LNK_RIDE_ON_NMI, mid_Rided_LNK_ID, faux, nofunc, nofunc)

//if ( o_current_wp && ! o_Rided_Actor )
//	macro_change_etat("PNJ_Bunny_Saucer_ETAT_Course")
//if ( o_fake_pilot )
//	macro_change_etat("PNJ_Bunny_Saucer_ETAT_Course")

PNJ_Bunny_Sauver_check_paf()

switch(mode)
{
	case Ci_Mode_Agressif :
		if (o_Rided_Actor && o_Rided_Actor != o_main_actor)
			macro_change_etat("PNJ_Bunny_Saucer_ETAT_Fight")
		break
		
	case Ci_Mode_Fuite :
		if (o_Rided_Actor && o_Rided_Actor != o_main_actor)
		{
			if (AI_TriggerIsValid(trigger_agressif) && call_trigger(trigger_agressif))
				macro_change_etat("PNJ_Bunny_Saucer_ETAT_Fuite")
			else
				macro_change_etat("PNJ_Bunny_Saucer_ETAT_Ronde")
		}
		break

	case Ci_Mode_Ride :
		if ( ! o_Rided_Actor || o_Rided_Actor != o_main_actor )
			macro_change_etat("PNJ_Bunny_Saucer_ETAT_Ride")
		break

	case Ci_Mode_Transport :
		macro_change_etat("PNJ_Bunny_Saucer_ETAT_Balade")
		break

	case Ci_Mode_In_The_Sky :
		macro_change_etat("PNJ_Bunny_Saucer_ETAT_In_The_Sky")
		break
}


// RIDED ? -----------------------------------------------------------------
ti_flag_main = faux
ti_flag_boost = faux

tf_wanted_traction = 0.0

if ( o_Rided_Actor == o_main_actor )
{
	ti_flag_main = vrai

//	if ( ! rabbit_allowed )
//	{
//		f_burn_duration -= MATH_FloatMin(f_burn_duration, TIME_GetDt())
//		if ( ! f_burn_duration )
//		{
//			PROC_SFX_EXPLOSION_REALISTE(5.0, 2.0, OBJ_PosGet())
//			PROC_SFX_EXPLOSION_ARBRE(OBJ_PosGet(), 3.0, 3.0)
//
//			COL_SwapToSpecific(C_zde_corps)
//			COL_ZonePosSet(C_zde_corps, Cv_NullVector)
//			COL_ZoneSizeSet(C_zde_corps, cvector(6.0, 6.0, 6.0))
//
//			@o_Rided_Actor OBJ_PosSet(OBJ_PosGet() + OBJ_BankingGet())
//
//			ti_zde_corps_nb =  COL_ZDE_ZDEListGet(&tao_zde_corps_gao[0], C_zde_corps, C_zde_corps, all, none, Ci_Filter_IdentityFlag)
//			for (ti_i = 0; ti_i < ti_zde_corps_nb; ti_i++)
//			{
//				if (tao_zde_corps_gao[ti_i] == o_Rided_Actor)
//					EVENT_AddEventPafCanal( C_EVENT_FILTER_Object, C_PAF_RM_Fort | C_PAF_RM_Grenade, OBJ_Me(), Cf_EVENT_Duree_1Trame, tao_zde_corps_gao[ti_i], -1, 0.0, OBJ_BankingGet(), OBJ_PosGet())
//				else
//					EVENT_AddEventPafCanal( C_EVENT_FILTER_Object, C_PAF_RM_Fort | C_PAF_RM_Grenade, OBJ_Me(), Cf_EVENT_Duree_1Trame, tao_zde_corps_gao[ti_i], -1, 0.0, @tao_zde_corps_gao[ti_i] OBJ_PosGet() - OBJ_PosGet(), OBJ_PosGet())
//			}
//			
//			o_Rided_Actor = LNK_ServeurGet(Ci_LNK_RIDE_ON_NMI, mid_Rided_LNK_ID, faux, nofunc, nofunc)
//
//			OBJ_Destroy()
//		}
//	}
			
	tv_joy_dir = glob_joyvector_get

	if (Proc_JOY_Boost_Pressed())
		tf_wanted_traction = f_speed_max
	else
		tf_wanted_traction = f_analog_speed * glob_joynorm_get
}
else
{
	if( ! i_hotspot && grappinable)
	{
		HotSpot_Add_Obj(OBJ_Me(), 0)
		i_hotspot = vrai
	}

	tv_joy_dir = Cv_NullVector
}

if ( MATH_VecSquareNorm(tv_joy_dir) < 0.001)
	tv_joy_dir = OBJ_SightGet()

tf_speed_coef = MATH_FloatLimit(f_real_speed * 0.5, 0.1, 1.0)
tf_wanted_traction *= tf_speed_coef

//if (i_flag_Y_slide && f_wanted_speed > f_real_speed + f_Y_limit_speed)
//{
//	// ANTI PATINAGE
//	tf_next_wanted_traction = f_wanted_speed + (f_acceleration * TIME_GetDt())
//	tf_wanted_traction = f_real_speed + f_Y_limit_speed - 0.1
//}

// COMPORTEMENT =========================================================
PNJ_Bunny_Saucer_Sight_And_Banking(tv_joy_dir)
PNJ_Bunny_Saucer_Apply_Traction_And_Choose_Action(tf_wanted_traction)

if (@o_main_actor PROC_RM_CHEAT_Mode())
{
	DYN_SpeedSetVector(Cv_NullVector)
	OBJ_BankingGeneralSet(OBJ_SightGet(), Cv_VerticalVector)
}
