#include "RM_Projectiles_defines.var"

float		tf_degats
vector	tv_dir
object	to_target

to_target = AI_MainActorGet(0)
if (i_type  == RMP_TYPE_AIRE)
	AI_TrackCurChangeNow("RMP_ETAT_EXPLOSE")
	
tf_degats = MATH_VecNorm(@to_target OBJ_PosGet() - OBJ_PosGet())
if (tf_degats < f_explosion_size)
{
	if (tf_degats < 1.0)
		tf_degats = f_explosion_strength
	else
		tf_degats = f_explosion_strength / tf_degats

	// Paf de missile seulement si pas de face, et pas de paf en cours
	if (((i_type != RMP_TYPE_TETE) || MATH_VecDotProduct(@o_target OBJ_SightGet(), OBJ_BankingGet()) > -Cf_Cos45) && !RM_Projectiles_Target_Paffed())
	{
		tv_dir = @o_target OBJ_PosGet() - OBJ_PosGet()
		EVENT_AddEventPaf(C_EVENT_FILTER_Object, C_PAF_RM_ComboPetit, OBJ_Me(), Cf_EVENT_Duree_1Trame, to_target, tf_degats, tv_dir)
	}
}

if (i_type == RMP_TYPE_TETE)
{
	if( i_GFX_halo != -1 )
	{
		GFX_Del(i_GFX_halo)
		i_GFX_halo = -1
	}
}

if (i_type == RMP_TYPE_MINE)
	PROC_SFX_EXPLOSION_SOL(f_explosion_size * 5, OBJ_PosGet())
else
	PROC_SFX_EXPLOSION_CARTOON (OBJ_PosGet())

{
	if ((o_target != AI_MainActorGet(0)) && (@o_target OBJ_CapaGet() == 0xFF))
	{
		@o_target OBJ_Destroy()
	}
//	OBJ_Destroy()

	i_started = 0
	i_dead = 1
	i_SND_boom = SND_RequestPlay(RMP_SND_BOOM)
	OBJ_FlagInvisibleSet(1)
	AI_TrackCurChangeNow("RMP_ETAT_WAIT")
}
