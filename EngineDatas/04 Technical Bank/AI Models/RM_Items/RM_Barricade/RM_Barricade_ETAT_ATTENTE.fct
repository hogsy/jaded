#include "RM_Barricade_defines.var"

message		tm_messPaf
int					ti_rank,ti_typePaf
messageid		tmid_messPaf
vector			tv_sensPaf
object			to_gao
object			to_pafeur



float		tf_rope_length
float		tf_rope_ratio
vector	tv_offset_A
vector	tv_offset_B
int			ti_rope_index



// Detect Paf
MSG_SetNull(tm_messPaf)
tm_messPaf.msg_gao1 = OBJ_Me()
ti_rank = -1

tmid_messPaf = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tm_messPaf)
while(MSG_GlobalIsValid(tmid_messPaf))
{
	ti_typePaf=EVENT_PafTypeGet(tmid_messPaf)
	to_pafeur = EVENT_PereGet(tmid_messPaf)
	tv_sensPaf = EVENT_PafDirGet(tmid_messPaf) * 4.0
	if(C_PAF_RM_Moyen==(C_PAF_RM_Moyen & ti_typePaf))
	{
//		tv_sensPaf *= 2.0
		i_NbCoup++
		f_DelayTremble=1.0
//		DBG_RenderVector(OBJ_PosGet(),tv_sensPaf,color_rouge)
		SND_RequestPlay(Ci_Barricade_SND_Paf)
		if(i_NbCoup>=i_Solidite)
		{
			RM_Barricade_DetruitPlanche(i_NumModule,tv_sensPaf )
			
	//		@ao_Planche[i_NumModule] OBJ_Destroy()
			
			i_NbCoup=0
			i_NumModule++
			if(i_NumModule>=i_NbPlanche)
			{
				RM_Barricade_Detruit(tv_sensPaf,2.0)
			}
		}
	}
	else if(i_PafDestruction==(i_PafDestruction & ti_typePaf))
	{
//		RM_Barricade_Detruit(Cv_VerticalVector*2.0,3.0)
//		RM_Barricade_Detruit((OBJ_PosGet() - @to_pafeur OBJ_PosGet()) * 3.0 , 2.0)
//		DBG_RenderVector(OBJ_PosGet(),tv_sensPaf ,color_rouge)
		RM_Barricade_Detruit(tv_sensPaf , 5.0)
 	}

//	DYN_SpeedSetVector( MATH_VecNormalize(tv_sensPaf) * 10.0)
	tmid_messPaf = MSG_GlobalSearchIntGao(C_EVENT_TYPE_Paf, &ti_rank, tm_messPaf)
}

// GRAPPIN
to_gao = @o_rope_manager Rope_Manager_Get_Linked_Gao(OBJ_Me(), tf_rope_length, tf_rope_ratio, tv_offset_A, tv_offset_B)
if( to_gao )
{
	Proc_Mashing_Actor_Add(OBJ_Me())
	
	ti_rope_index = @o_rope_manager Rope_Manager_Get_Corde_Index(to_gao, OBJ_Me())
	if( ! glob_joynorm_get )
	{
		OBJ_CapaSet(none,OBJ_Capa_2)
		f_DelaiTire = 0.0
	}
	else if( @o_rope_manager Rope_Manager_RopeTendue(ti_rope_index) )
		f_DelaiTire += TIME_GetDt()
	if( f_DelaiTire )
	{
		OBJ_CapaSet(OBJ_Capa_2,none)
		f_DelayTremble=f_DelaiTire*0.2
//			if( f_DelaiTire == TIME_GetDt() )
		if( f_DelaiTire > f_ResistanceGrappin )
		{
			RM_Barricade_Detruit((@get_rayman OBJ_PosGet()-OBJ_PosGet())+(Cv_VerticalVector*2.0),1.0)
			
			if( @to_gao AI_IsModel(get_Rayman_Path))		// Rayman et ses clones
				@get_global i_grappin_hotspot_nmi_died = vrai		// cancel grappin	
		}
	}
}

// Tremble
RM_Barricade_Tremble()
RM_Barricade_Chute()


