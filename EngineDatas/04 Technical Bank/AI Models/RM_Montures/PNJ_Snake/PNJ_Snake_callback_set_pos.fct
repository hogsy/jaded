Include_UltraProcedure_Header
#include "PNJ_Snake_defines.var"

int				ti_index
int				ti_flag_collision
int				ti_flag_can_strangulate

float			tf_norm
float			tf_coef
float			tf_dist
float			tf_target_speed
float			tf_zdm_pied_size
float			tf_sign
float			tf_frame
float			tf_pct
float			tf_offset
float			tf_offset1

vector		tv_pos	
vector		tv_speed
vector		tv_new_sight
vector		tv_new_banking
vector		tv_point_A
vector		tv_OBBOX_center
vector		tv_bone_sight
vector		tv_bone_banking
vector		tv_bone_horizon

object		to_bone
object		to_camera
object		to_serveur

to_camera = @get_global o_camera

if (o_eagle)
{
	switch(creature_type)
	{
		case Ci_CreatureType_Snake :
	
			// JE SUIS GRABBE PAR UN AUTRE ACTEUR
			to_bone = o_snap_bone
			ti_index = i_grabbed_bone_index
			
			tv_speed = @ao_modules[ti_index] OBJ_PosGet()
			
			if (COL_RayObject_Dist(@to_bone OBJ_PosGet(), -Cv_VerticalVector, 10.0, all, none, Ci_Filter_IdentityFlag, COL_C_Ray_on_ColMap_NoCrossable))
			{
				v_ray_pos = MATH_VecBlend(v_ray_pos, COL_RayObject_PosGet(), 6.0 * TIME_GetDt())
				v_ray_normal = MATH_VecBlendRotate(v_ray_normal, COL_RayObject_NormalGet(), 4.0 * TIME_GetDt())
			}
			
			tf_coef = f_time_start_etat / 0.2
			
			switch( LNK_GrabServeurVisionIDGet(mid_eagle_LNK) )
			{
		//		case C_ID_Tyranosaure :
		//			tf_offset = - 0.5
		//			tf_offset1 = 1.0
		//			break
				default:	
					tf_offset = 0.0
					tf_offset1 = 0.5
					break
			}
			
			tv_pos = @to_bone OBJ_PosGet()
			tv_pos += @to_bone OBJ_SightGet() * tf_offset
			tv_pos += @to_bone OBJ_BankingGet() * tf_offset1
			
			tv_new_sight = @to_bone OBJ_HorizonGet()
			tv_new_banking = - @to_bone OBJ_SightGet()
			if (tf_coef < 1.0)
			{
				tv_pos = MATH_VecBlend(@ao_modules[ti_index] OBJ_PosGet(), tv_pos, tf_coef)
				tv_new_sight = MATH_VecBlendRotate(@ao_modules[ti_index] OBJ_SightGet(), tv_new_sight, tf_coef)
				tv_new_banking = MATH_VecBlendRotate(@ao_modules[ti_index] OBJ_BankingGet(), tv_new_banking, tf_coef)
			}
			@ao_modules[ti_index] OBJ_PosSet(tv_pos)
			@ao_modules[ti_index] OBJ_BankingGeneralSet(tv_new_sight, tv_new_banking)
			
			av_modules_speed[ti_index] = @ao_modules[ti_index] OBJ_PosGet() - tv_speed
			av_modules_speed[ti_index] /= TIME_GetDt()
		
		//	PNJ_Snake_Snake(ti_index + 1, 12.0, Cv_NullVector, -20.0)
		//	PNJ_Snake_Inv_Snake(ti_index - 1, 12.0, Cv_NullVector, -20.0)
		
			f_ragdoll_damping = 1.0
			ai_modules_locked[ti_index] = vrai
			PNJ_Snake_Rag_Doll(0)	
			
			break
			
		case Ci_CreatureType_Spider :
		case Ci_CreatureType_Quadri :
			break
	}
}

AI_Execute("PNJ_Snake_After_ETAT")